<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Application Hub (MCI + CRA + TV) — Supabase</title>

    <script src="https://printjs-4de6.kxcdn.com/print.min.js"></script>
    <link rel="stylesheet" href="https://printjs-4de6.kxcdn.com/print.min.css" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&display=swap');
        /* ================= Theme ================= */
        :root {
            --bg: #0b0e12;
            --panel: #0f0f1b;
            --panel-header: rgba(255, 255, 255, .04);
            --ink: #e8eef6;
            --muted: #a8b2be;
            --accentA: #2ea44f;
            --accentA-light: #6ee7b7;
            --accentB: #00a3ff;
            --accentC: #ffc107;
            --accentD: #dc3545;
            --border: rgba(255, 255, 255, .08)
        }

        /* START: Light Theme Variables */
        body.light-theme {
            --bg: #f8f9fa;
            --panel: #ffffff;
            --panel-header: rgba(0, 0, 0, .03);
            --ink: #212529;
            --muted: #6c757d;
            --border: #dee2e6;
        }
        /* END: Light Theme Variables */

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        html,
        body {
            height: 100%
        }

        body {
            background: var(--bg);
            color: var(--ink);
            font-family: 'Source Sans Pro', sans-serif;
            overflow: hidden
        }

        .app-container {
            display: flex;
            height: 100vh
        }

        @keyframes pulse-glow {
            0% {
                box-shadow: 0 0 6px rgba(0, 163, 255, 0.8), 0 0 12px rgba(0, 163, 255, 0.6), 0 0 3px #fff;
            }

            50% {
                box-shadow: 0 0 14px rgba(0, 163, 255, 1), 0 0 22px rgba(0, 163, 255, 0.9), 0 0 5px #fff;
            }

            100% {
                box-shadow: 0 0 6px rgba(0, 163, 255, 0.8), 0 0 12px rgba(0, 163, 255, 0.6), 0 0 3px #fff;
            }
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background-color: var(--panel);
            /* Stained glass color effect */
            background-image: linear-gradient(180deg, rgba(255, 255, 255, 0.04) 0%, rgba(255, 255, 255, 0) 60%);
            display: flex;
            flex-direction: column;
            padding: 24px;
            gap: 16px;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .sidebar::before {
            display: none; /* Disables the cross pseudo-element */
        }

        body.light-theme .sidebar {
            background-image: linear-gradient(180deg, #ffffff 0%, #e9ecef 100%);
        }

        body.light-theme .sidebar::before {
            display: none; /* Also disable for light theme */
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .logo {
            width: 48px;
            height: 48px
        }

        .company-name {
            font-weight: 800
        }

        .sidebar-nav {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1
        }

        .nav-item a {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 10px 12px;
            border-radius: 10px;
            color: var(--muted);
            text-decoration: none;
            font-weight: 600
        }

        body.light-theme .nav-item a {
            color: #495057; /* Darker font color for light theme */
        }

        .nav-item.has-submenu > a {
            justify-content: space-between;
        }

        .nav-item.has-submenu > a::after {
            content: '›';
            font-size: 1.5rem;
            transition: transform 0.2s;
        }
        
        .nav-item.open > a::after {
            transform: rotate(90deg);
        }

        .submenu {
            list-style: none;
            padding-left: 24px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        
        .nav-item.open > .submenu {
            max-height: 260px; /* Increased from 200px */
        }

        .submenu-item a {
            padding: 8px 12px;
            font-size: 0.9rem;
            transition: color 0.2s, background-color 0.2s;
        }

        .submenu-item a.active {
            color: var(--accentA-light);
            font-weight: 700;
            background: transparent; /* This is the fix */
        }

        body.light-theme .submenu-item a.active {
            color: var(--accentB);
            font-weight: 700;
            background: transparent; /* This is the fix */
        }

        .nav-item a:hover {
            color: var(--ink);
            box-shadow: 0 0 0 1px rgba(0, 163, 255, .2), 0 0 8px rgba(0, 163, 255, .2)
        }
        
        body.light-theme .nav-item a:hover {
            color: var(--accentB);
            background-color: rgba(0, 163, 255, .1);
            box-shadow: none;
        }

        .nav-item a.active {
            background: rgba(0, 163, 255, .08);
            color: var(--ink)
        }

        body.light-theme .nav-item a.active {
            background: rgba(0, 163, 255, .1);
            color: var(--accentB);
        }

        .nav-text {
            display: inline-block
        }

        .sidebar-footer {
            margin-top: auto;
            border-top: 1px solid var(--border);
            padding-top: 12px
        }

        /* Main */
        .main-content {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-left: 1px solid var(--border);
        }

        .main-header {
            padding: 16px 24px;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center
        }

        .main-header h1 {
            font-size: 1rem;
            font-weight: 900;
            padding: 8px 16px;
            border-radius: 10px;
            box-shadow: 0 0 0 1px rgba(0, 163, 255, .2), 0 0 8px rgba(0, 163, 255, .2)
        }

        body.light-theme .main-header h1 {
            box-shadow: none;
            background: var(--bg);
            border: 1px solid var(--border);
        }

        .app-panel-container {
            flex: 1;
            overflow: auto;
            padding: 24px
        }

        .app-panel {
            display: none;
            width: 100%
        }

        /* Cards/Sections */
        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, .45)
        }

        body.light-theme .card {
            box-shadow: 0 4px 12px rgba(0, 0, 0, .08);
        }

        .card.pad {
            padding: 24px
        }

        .section-title {
            font-size: 1rem;
            font-weight: 900;
            color: var(--ink);
            border-bottom: 2px solid var(--accentB);
            padding-bottom: 10px;
            margin-bottom: 14px
        }

        /* --- MCI Report Card Fixes --- */
        .small-card-header {
            background: var(--panel-header);
            padding: 10px 16px;
            margin: -24px -24px 16px;
            border-radius: 16px 16px 0 0;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--ink);
        }

        .financial-line {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            font-size: 0.85rem;
            margin-top: 6px;
        }

        .financial-line span:first-child {
            font-weight: 600; /* Bolder label */
            color: var(--muted);
        }

        .financial-line span:last-child {
            font-weight: 900; /* Bolder number */
            color: var(--ink);
        }
        /* --- End of Fixes --- */

        /* Buttons */
        .btn {
            padding: .8rem 1.1rem;
            border: 2px solid;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all .2s;
            color: var(--muted);
            border-color: var(--muted);
            background-color: rgba(168, 178, 190, 0.15);
            font-family: 'Source Sans Pro', sans-serif;
            /* Solid semi-transparent fill */
        }

        body.light-theme .btn {
            background-color: transparent;
            border-width: 1px;
        }
        
        body.light-theme .btn:hover {
             /* REMOVED: background-color: rgba(0, 0, 0, .04); */
             /* REMOVED: border-color: var(--ink); */
             transform: translateY(-2px);
             box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .btn:hover {
            /* REMOVED: color: var(--ink); */
            /* REMOVED: border-color: var(--ink); */
            /* REMOVED: background-color: rgba(168, 178, 190, 0.2); */
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.45);
        }
        
        .btn.small {
            padding: .4rem .8rem;
            font-size: .8rem;
            border-width: 1px;
            border-radius: 8px
        }

        .btn-primary {
            border-color: var(--accentA);
            color: var(--accentA);
            background-color: rgba(46, 164, 79, 0.15);
        }

        body.light-theme .btn-primary {
            background-color: var(--accentA);
            color: white;
        }

        .btn-primary:hover {
            /* REMOVED color and border-color */
            box-shadow: 0 4px 12px rgba(46, 164, 79, .35);
            /* REMOVED background-color */
        }

        body.light-theme .btn-primary:hover {
            /* REMOVED background-color and border-color */
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 164, 79, .25);
        }

        .btn-info {
            border-color: var(--accentB);
            color: var(--accentB);
            background-color: rgba(0, 163, 255, 0.15);
        }

        .btn-info:hover {
            box-shadow: 0 4px 12px rgba(0, 163, 255, .35);
            /* REMOVED background-color */
        }

        body.light-theme .btn-info {
            background-color: var(--accentB);
            color: white;
        }

        .btn-warning {
            border-color: var(--accentC);
            color: var(--accentC);
            background-color: rgba(255, 193, 7, 0.15);
        }

        .btn-warning:hover {
            box-shadow: 0 4px 12px rgba(255, 193, 7, .35);
            /* REMOVED background-color */
        }

        body.light-theme .btn-warning {
            background-color: var(--accentC);
            color: #212529;
        }

        .btn-danger {
            border-color: var(--accentD);
            color: var(--accentD);
            background-color: rgba(220, 53, 69, 0.15);
        }

        .btn-danger:hover {
            box-shadow: 0 4px 12px rgba(220, 53, 69, .35);
            /* REMOVED background-color */
        }

        body.light-theme .btn-danger {
            background-color: var(--accentD);
            color: white;
        }

        /* Active state for payment buttons */
        .btn.active {
            background-color: var(--accentA);
            border-color: var(--accentA);
            color: var(--bg);
        }

        .btn.active:hover {
            /* REMOVED background-color and border-color */
        }

        /* Inputs */
        .field {
            margin-bottom: 16px
        }

        .label {
            display: block;
            font-size: .85rem;
            color: var(--muted);
            margin: 0 0 6px
        }

        .input,
        .textarea,
        .select {
            width: 100%;
            padding: .9rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, .06);
            color: var(--ink);
            font-family: 'Source Sans Pro', sans-serif;
            font-weight: 400;
            font-size: 1rem;
        }

        body.light-theme .input,
        body.light-theme .textarea,
        body.light-theme .select {
            background: #fff;
        }

        .input::placeholder,
        .textarea::placeholder {
            color: rgba(168, 178, 190, 0.6);
            font-style: normal;
            font-weight: 400;
            font-size: 0.9rem;
            opacity: 1;
        }

        body.light-theme .input::placeholder,
        body.light-theme .textarea::placeholder {
            color: #adb5bd;
        }

        .textarea {
            min-height: 120px;
            resize: vertical
        }

        .input:focus,
        .textarea:focus,
        .select:focus {
            outline: none;
            border-color: rgba(0, 163, 255, .45);
            box-shadow: 0 0 0 4px rgba(0, 163, 255, .12)
        }

        .input::placeholder,
        .textarea::placeholder {
            color: #eaf2fb;
            opacity: .95
        }

        body.light-theme .input::placeholder,
        body.light-theme .textarea::placeholder {
            color: #adb5bd;
            opacity: 1;
        }

        .select:invalid {
            color: var(--muted);
        }

        /* Toggle Switch */
        .toggle {
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: 1fr;
            gap: 6px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 5px;
        }

        body.light-theme .toggle {
            background-color: #e9ecef;
        }

        .toggle .opt {
            text-align: center;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 14px; /* Standardized toggle font size */
            color: var(--muted);
            cursor: pointer;
            user-select: none;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            background-color: transparent;
            white-space: nowrap;
            font-family: 'Source Sans Pro', sans-serif;
            /* Prevents text from wrapping */
        }

        body.light-theme .toggle .opt {
            color: #333;
        }

        .toggle .opt.active {
            color: var(--bg);
            background-color: var(--accentA);
        }

        body.light-theme .toggle .opt.active {
            background-color: var(--accentA);
            color: white;
        }

        /* CRA Reports UI */
        #cra-reports .controls {
            display: flex;
            align-items: flex-end;
            gap: 24px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        #cra-report-output {
            margin-top: 16px;
        }

        .reports-header {
            background: var(--panel-header);
            padding: 18px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 65px;
        }

        /* Tables & grids */
        .grid {
            display: grid;
            gap: 16px
        }

        .grid-2 {
            grid-template-columns: 1fr 1fr
        }

        .grid-3 {
            grid-template-columns: 1fr 1fr 1fr
        }

        .grid-4 {
            grid-template-columns: repeat(4, 1fr)
        }

        .table {
            width: 100%;
            border-collapse: collapse
        }

        .table th,
        .table td {
            padding: 12px 8px;
            border-bottom: 1px solid var(--border);
            text-align: left
        }

        .table th {
            background: var(--panel-header)
        }

        .table-container {
            margin-top: 24px;
        }

        /* --- UNIFIED TABLE FONT STYLING --- */
        /* This rule applies a consistent font style to data tables across the app */
        #cra-apps #apps_tbody td,
        #followup-list-container .table td,
        #cra-report-output .table td,
        #emailReportsTbody td,
        #statusTableBody td {
            font-family: 'Source Sans Pro', sans-serif;
            font-weight: 600;
            font-size: 0.85rem;
        }

        /* FIX for CRA Action Buttons */
        #cra-apps .actions-cell {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        /* Pills / badges (original style) */
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            color: var(--muted)
        }

        /* Payment method badges - UPDATED PILL STYLE */
        .payment-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 4px 4px 12px; /* Asymmetrical padding */
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: capitalize;
        }

        .payment-badge .remove-payment-btn {
            background-color: var(--accentD);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            transition: all 0.2s ease;
        }

        .payment-badge .remove-payment-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .payment-badge.cash {
            background: rgba(46, 164, 79, 0.2);
            color: var(--accentA);
        }

        .payment-badge.check {
            background: rgba(0, 163, 255, 0.2);
            color: var(--accentB);
        }
        
        /* --- FIX: Report Status Pills --- */
        .status-pill {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: capitalize;
            text-align: center;
            line-height: 1.2;
            margin: 0 2px;
        }
        .status-pill.cash { background: rgba(46, 164, 79, 0.2); color: var(--accentA); }
        .status-pill.check { background: rgba(0, 163, 255, 0.2); color: var(--accentB); }
        .status-pill.online { background: rgba(255, 193, 7, 0.2); color: var(--accentC); }
        .status-pill.sponsorship { background: rgba(108, 117, 125, 0.2); color: var(--muted); }
        /* --- End of Fix --- */

        /* --- NEW: Live Check-In Styles --- */
        #checkin_tbody td {
            vertical-align: top;
            padding-top: 12px;
        }
        #checkin_tbody .approve-cell {
            text-align: center;
            vertical-align: middle;
        }
        .btn-approve-checkin {
            font-size: 1.2rem !important;
            padding: 12px 20px !important;
            width: 100%;
        }
        /* --- END: Live Check-In Styles --- */

        /* --- NEW: Uniform Payment Cell Layout --- */
        .payment-cell-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px; /* Space between status text and pills */
            min-height: 40px; /* Ensures consistent row height */
        }

        .payment-status-text {
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
        }
        
        /* Status-specific colors for the text */
        .payment-status-text.paid,
        .payment-status-text.waived {
            color: var(--accentA);
        }
        .payment-status-text.partial {
            color: var(--accentC);
        }
        .payment-status-text.due {
            color: var(--accentD);
        }

        .payment-pills-container {
            display: flex;
            gap: 4px;
            flex-wrap: wrap; /* Allows pills to wrap if needed */
            justify-content: center;
            min-height: 22px; /* Reserves space for pills even if none exist, for alignment */
        }
        /* --- END: Uniform Payment Cell Layout --- */
        
        /* --- FIX: Equalize button height in recipient modal --- */
        #addRecipientBtn, #quickAddContainer > .btn {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        
        /* MCI */
        .mci-app {
            display: flex;
            flex-direction: column;
            gap: 16px;
            height: 100%;
        }

        .mci-app .controls-bar {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 15px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, .45);
        }

        body.light-theme .mci-app .controls-bar,
        body.light-theme .mci-app .member-list,
        body.light-theme .mci-app .detail-panel {
            box-shadow: 0 4px 12px rgba(0, 0, 0, .08);
        }

        .mci-app .main-container {
            display: grid;
            grid-template-columns: 40% 1fr;
            gap: 16px;
            flex: 1;
            min-height: 0
        }

        .mci-app .member-list,
        .mci-app .detail-panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 12px 40px rgba(0, 0, 0, .45);
        }

        .mci-app .list-header,
        .mci-app .status-legend,
        .mci-app .reports-header,
        .mci-app .meeting-control-container {
            background: var(--panel-header);
            padding: 18px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 65px
        }

        .mci-app .reports-header h2 {
            font-size: 1rem;
            font-weight: 900;
        }

        .mci-app .list-header > span {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .mci-app .status-label {
            font-size: 11px;
            font-weight: normal;
            color: var(--muted);
        }

        .mci-app .empty-list-message {
            font-size: 11px;
            font-weight: normal;
            color: var(--muted);
            text-align: center;
            padding: 40px 20px;
        }

        #detailPanelName {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .mci-app .status-legend {
            justify-content: flex-end;
            gap: 16px;
        }

        .mci-app .list-content {
            overflow: auto;
            flex: 1
        }

        .member-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: .2s;
            border-left: 5px solid transparent
        }

        .member-item:hover {
            background: var(--panel-header)
        }

        .member-item.selected {
            background: rgba(0, 163, 255, .08);
            border-left-color: var(--accentB)
        }

        .member-name {
            font-weight: 700
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--muted);
            display: inline-block
        }

        .status-dot.complete {
            background: var(--accentA);
            border-color: var(--accentA)
        }

        .attendance-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px
        }

        .meet-btn {
            position: relative;
            padding: 8px 0;
            font-weight: 700;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, .06);
            color: var(--ink);
            cursor: pointer
        }

        .meet-btn.attended {
            background: var(--accentA);
            color: #111;
            border-color: var(--accentA)
        }

        .meet-btn.zoom {
            background: var(--accentB);
            color: #111;
            border-color: var(--accentB)
        }

        .meet-btn.zoom::after {
            content: "Z";
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: 6px;
            font-size: 10px;
            font-weight: 900;
            background-image: linear-gradient(to bottom right, #4dabf7, var(--accentB));
            color: var(--bg);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.5);
            animation: pulse-glow 2s infinite ease-in-out;
        }

        .inline-status {
            display: flex;
            gap: 14px;
            align-items: baseline;
            flex-wrap: wrap
        }

        .amount-paid {
            color: var(--accentA);
            font-weight: 900
        }

        .amount-due {
            color: var(--accentD);
            font-weight: 900
        }

        .mci-app .detail-panel {
            overflow: hidden
        }

        #detailContent {
            height: 100%;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
        }

        .fee-card {
            display: flex;
            flex-direction: column;
            padding: 16px;
        }

        .fee-card .inline-status {
            margin-top: auto;
            padding-top: 10px;
        }

        .payment-options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .meeting-dots-container {
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: center;
        }

        .meeting-status-dot {
            width: 21px;
            height: 21px;
            border-radius: 50%;
            border: 2px solid var(--muted);
            background-color: transparent;
            transition: all 0.2s;
        }

        .meeting-status-dot.attended {
            background-color: var(--accentA);
            border-color: var(--accentA);
        }

        /* Data Management Styles */
        .data-management-card {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .data-management-card p {
            color: var(--muted);
            font-size: 0.9rem;
            flex-grow: 1;
            margin-top: 4px;
        }

        .data-management-card .actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 12px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .7);
            z-index: 1000
        }

        .modal .box {
            width: min(740px, 92vw);
            margin: 10vh auto;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column
        }

        .modal .box.small {
            width: min(480px, 92vw)
        }

        .modal .box .head {
            padding: 18px 22px;
            background: var(--panel-header);
            border-bottom: 1px solid var(--border);
            font-weight: 900
        }

        .modal .box .body {
            padding: 22px;
            max-height: 65vh;
            overflow: auto
        }

        .modal .box .foot {
            padding: 16px 22px;
            background: var(--panel-header);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 8px
        }

        /* --- STYLES FOR HEADER & MODAL STATUS BARS --- */
        /* Main Status Bar (mimics header BAR) */
        #mainStatusBar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 11; /* Above header */
            background-color: var(--accentA);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 25px 24px; /* Adjusted to perfectly match the .main-header's computed height */
            font-size: 1.2rem;
            font-weight: 700;
            transform: translateY(-100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            text-transform: uppercase;
        }

        #mainStatusBar.visible {
            transform: translateY(0);
        }
                
        #mainStatusBar.error {
            background-color: var(--accentD);
        }

        /* Generic Status Bar (for modals) */
        .status-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 10;
            background-color: var(--accentA);
            color: white;
            text-align: center;
            font-weight: 600;
            padding: 12px;
            transform: translateY(-100%);
            transition: transform 0.4s ease-in-out;
        }

        .status-bar.visible {
            transform: translateY(0);
        }
        
        .status-bar.error {
            background-color: var(--accentD);
        }

        /* MCI-specific Status Bar */
        #mciStatusBar {
            padding: 27px 20px; /* Increased height */
            min-height: 65px; /* Match panel header */
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* --- END: STATUS BAR STYLES --- */

        /* --- NEW: Custom Date Picker Styles --- */
        .custom-date-input {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: .9rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, .06);
            color: var(--ink);
            cursor: pointer;
            transition: all 0.2s;
        }

        body.light-theme .custom-date-input {
            background: #fff;
        }

        .custom-date-input:focus,
        .custom-date-input.active {
            outline: none;
            border-color: rgba(0, 163, 255, .45);
            box-shadow: 0 0 0 4px rgba(0, 163, 255, .12)
        }

        .custom-date-input .placeholder {
            color: var(--muted);
        }

        .picker-popover {
            display: none;
            position: absolute;
            z-index: 1001;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
            width: 280px;
        }
        
        body.light-theme .picker-popover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .picker-popover .picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
        }
        
        .picker-popover .picker-header button {
            background: transparent;
            border: none;
            color: var(--muted);
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            padding: 4px 10px;
            border-radius: 6px;
        }
        
        .picker-popover .picker-header button:hover {
            background-color: var(--panel-header);
            color: var(--ink);
        }
        
        .picker-popover .picker-header span {
            font-weight: 700;
        }
        
        .picker-popover .picker-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            padding: 12px;
        }

        .picker-popover .month-btn {
            padding: 10px 0;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--ink);
            font-weight: 600;
            transition: all 0.2s;
        }

        .picker-popover .month-btn:hover {
            background: var(--panel-header);
        }

        .picker-popover .month-btn.selected {
            background: var(--accentB);
            color: white;
        }
        /* --- END: Custom Date Picker Styles --- */

        /* Confirmation Modal Warning Style */
        #confirmModal .head {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #confirmModal .icon {
            width: 24px;
            height: 24px;
            stroke-width: 2.5px;
        }

        #confirmModal .body {
            font-size: 1rem;
            color: var(--muted);
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }

            #printable-content,
            #printable-content * {
                visibility: visible;
            }

            #printable-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            .printable-header h1,
            .printable-header h2 {
                text-align: center;
                color: #000;
                margin: 0;
            }

            .printable-header h1 {
                font-size: 22pt;
            }

            .printable-header h2 {
                font-size: 16pt;
                font-weight: normal;
                margin-top: 8px;
            }

            .printable-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
                color: #000;
            }

            .printable-table th,
            .printable-table td {
                border: 1px solid #ccc;
                padding: 8px;
                text-align: left;
            }

            .printable-table th {
                background-color: #eee;
                font-weight: bold;
            }

            .printable-summary {
                margin-top: 20px;
                padding-top: 10px;
                border-top: 2px solid #000;
                color: #000;
            }

            .printable-summary div {
                font-size: 12pt;
                margin-bottom: 5px;
            }

            .printable-summary span {
                font-weight: bold;
            }
        }

        /* Print support for Do Not Call / Deceased styling */
        @media print {
            .profile-main-info.do-not-call {
                border-left: 30px solid #dc3545 !important;
                position: relative !important;
                background-color: rgba(220, 53, 69, 0.05) !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .profile-main-info.do-not-call::before {
                content: "DO NOT CALL" !important;
                position: absolute !important;
                left: -73px !important;
                top: 50% !important;
                transform: translateY(-50%) rotate(-90deg) !important;
                color: white !important;
                font-weight: bold !important;
                font-size: 14pt !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .profile-main-info.deceased {
                border-left: 30px solid #000000 !important;
                position: relative !important;
                background-color: rgba(0, 0, 0, 0.05) !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .profile-main-info.deceased::before {
                content: "DECEASED" !important;
                position: absolute !important;
                left: -73px !important;
                top: 50% !important;
                transform: translateY(-50%) rotate(-90deg) !important;
                color: white !important;
                font-weight: bold !important;
                font-size: 14pt !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }


        @media (max-width:1024px) {
            .mci-app .main-container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .grid-4,
            .grid-2 {
                grid-template-columns: 1fr 1fr
            }
        }

        @media (max-width:768px) {
            .sidebar {
                width: 72px;
                padding: 16px 10px
            }

            .nav-text,
            .company-name {
                display: none
            }

            .grid-4,
            .grid-3,
            .grid-2 {
                grid-template-columns: 1fr
            }
        }

        /* ====================================================== */
        /* ============ START: AUTHENTICATION STYLES ============ */
        /* ====================================================== */
        #auth-container {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            z-index: 2000;
            padding: 24px;
        }

        .auth-card {
            width: 100%;
            max-width: 740px;
            display: grid;
            grid-template-columns: 1fr 1fr; /* Equal columns */
            background: var(--panel);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }

        .auth-image-panel {
            background: linear-gradient(135deg, #495057, #adb5bd);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* This pseudo-element now holds the cross image */
        .auth-image-panel::before {
            content: '';
            display: block;
            width: 100%; /* Increased to fill the panel */
            height: 100%; /* Increased to fill the panel */
            background-image: url('tres_dias_cross.svg'); /* Using GitHub relative path */
            background-size: 100%;
            background-repeat: no-repeat;
            background-position: center;
            filter: drop-shadow(0 0 15px rgba(0,0,0,0.4));
        }


        .auth-form-panel {
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .auth-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin: 0 0 8px 0;
        }

        .auth-subtitle {
            font-size: 1rem;
            color: var(--muted);
            margin: 0 0 24px 0;
        }

        .auth-links {
            text-align: center;
            margin-top: 20px;
            font-size: 0.85rem;
        }
        .auth-links a {
            color: var(--accentB);
            text-decoration: none;
            font-weight: 600;
        }
        .auth-links a:hover {
            text-decoration: underline;
        }
        .auth-links span {
            color: var(--muted);
            margin: 0 8px;
        }

        @media (max-width: 768px) {
            .auth-card {
                grid-template-columns: 1fr;
                max-width: 400px;
            }
            .auth-image-panel {
                display: none;
            }
        }
        /* ====================================================== */
        /* ============= END: AUTHENTICATION STYLES ============= */
        /* ====================================================== */

        /* ====================================================== */
        /* =========== START: TEAM VIEWER SCOPED CSS ============ */
        /* ====================================================== */

        #team-viewer-app {
            background-color: #f8f9fa;
            color: #333; /* Set default text color for contrast */
            margin: 0;
            padding: 0; /* Changed from 20px to 0 to fit panel */
            height: 100%;
            overflow-y: auto;
        }

        #team-viewer-app .container {
            max-width: none; /* This allows the container to expand */
            margin: 0; /* This removes the centering */
        }

        #team-viewer-app .header {
            background: #e9ecef;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        #team-viewer-app .header h1 {
            margin: 0 0 10px 0;
            color: #333;
        }

        /* --- Global Font Unification --- */
        #team-viewer-app button {
            font-family: 'Source Sans Pro', sans-serif;
        }

        /* Directory View Styles */
        #team-viewer-app .directory-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        #team-viewer-app select.search-select {
            color: #333;
        }

        #team-viewer-app select.search-select:invalid {
            color: #999;
        }

        #team-viewer-app .control-panel-divider {
            border: none;
            border-top: 1px solid #e0e0e0;
            margin: 20px 0;
        }

        #team-viewer-app .controls-main-grid {
            display: grid;
            grid-template-columns: 1.4fr 1fr;
            gap: 30px;
        }

        #team-viewer-app .controls-left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #team-viewer-app .controls-right-panel {
            display: flex;
            flex-direction: column;
            border-left: 1px solid #e0e0e0;
            padding-left: 30px;
        }

        #team-viewer-app .search-input-group {
            display: flex;
        }

        #team-viewer-app .search-input-group .search-input {
            border-right: none;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        #team-viewer-app .search-input-group .search-button {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        #team-viewer-app .utility-buttons {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        #team-viewer-app .utility-buttons .clear-button,
        #team-viewer-app .utility-buttons .print-button {
            flex: 0 1 110px;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 13px;
            padding: 6px 8px;
        }

        #team-viewer-app .utility-buttons .view-team-button {
            flex: 1 1 100px;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #team-viewer-app .gender-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        #team-viewer-app .toggle-inset-container {
            display: flex;
            justify-content: center;
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 5px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 20px;
        }

        #team-viewer-app .controls-right-panel .toggle-inset-container {
            width: 100%;
        }

        #team-viewer-app .toggle-inset-option {
            padding: 8px 19px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 700;
            color: #333;
            background-color: transparent;
            border: 1px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-grow: 1;
            text-align: center;
            font-family: 'Source Sans Pro', sans-serif;
        }

        #team-viewer-app #genderToggleContainer .toggle-inset-option {
            padding: 8px 14px;
        }

        #team-viewer-app .toggle-inset-option.active {
            background-color: #28a745;
            color: white;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #team-viewer-app .search-group.name-search {
            flex: 0.5;
            max-width: 250px;
        }

        #team-viewer-app .search-label {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            text-align: left;
        }

        #team-viewer-app .search-input,
        #team-viewer-app .search-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 15px;
            box-sizing: border-box;
            height: 37px;
            font-family: 'Source Sans Pro', sans-serif;
            font-weight: 300;
            background-color: #fff;
        }

        #team-viewer-app .search-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            height: 37px;
        }

        #team-viewer-app .search-button:hover {
            background-color: #218838;
        }

        #team-viewer-app .clear-button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            height: 37px;
        }

        #team-viewer-app .clear-button:hover {
            /* REMOVED background-color */
        }

        #team-viewer-app .print-button {
            background-color: #ffc107;
            color: #333;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            height: 37px;
        }

        #team-viewer-app .print-button:hover {
            /* REMOVED background-color */
        }

        #team-viewer-app .search-button,
        #team-viewer-app .clear-button,
        #team-viewer-app .print-button,
        #team-viewer-app .back-button,
        #team-viewer-app .nav-button,
        #team-viewer-app .refresh-button,
        #team-viewer-app .edit-button,
        #team-viewer-app .save-button,
        #team-viewer-app .cancel-button,
        #team-viewer-app .password-submit,
        #team-viewer-app .password-cancel,
        #team-viewer-app .gender-button {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease-in-out;
        }

        #team-viewer-app .search-button:hover,
        #team-viewer-app .clear-button:hover,
        #team-viewer-app .print-button:hover,
        #team-viewer-app .back-button:hover,
        #team-viewer-app .nav-button:hover:not(:disabled),
        #team-viewer-app .refresh-button:hover,
        #team-viewer-app .edit-button:hover,
        #team-viewer-app .save-button:hover,
        #team-viewer-app .cancel-button:hover,
        #team-viewer-app .password-submit:hover,
        #team-viewer-app .password-cancel:hover,
        #team-viewer-app .gender-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.18);
        }

        #team-viewer-app .directory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #007bff;
        }

        #team-viewer-app .directory-title {
            font-size: 1rem;
            font-weight: 900;
            color: #333;
        }

        #team-viewer-app .directory-count {
            font-size: 16px;
            color: #666;
        }

        #team-viewer-app .names-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-auto-flow: column; /* This is the key change */
            gap: 10px;
            max-height: 70vh;
            overflow-y: auto;
            padding: 10px;
        }

        #team-viewer-app .name-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            text-align: center;
        }

        #team-viewer-app .name-box:hover {
            /* REMOVED background-color and color */
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.18);
        }

        /* Enhanced name boxes for weekend searches */
        #team-viewer-app .name-box.enhanced-search-result {
            height: 60px;
            display: flex;
            flex-direction: column;
            padding: 0;
            justify-content: stretch;
        }
        #team-viewer-app .name-section {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 500;
        }
        #team-viewer-app .search-match-badge {
            flex-shrink: 0;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        #team-viewer-app .search-match-badge.candidate {
            background-color: var(--accentB);
            color: white;
        }
        #team-viewer-app .search-match-badge.service {
            background-color: var(--accentA);
            color: white;
        }

        #team-viewer-app .profile-main-info.is-spiritual-director {
            box-shadow: 0 0 8px 2px rgba(40, 167, 69, 0.4);
            border-left: 5px solid #28a745;
        }

        /* DO NOT CALL STYLING */
        #team-viewer-app .profile-main-info.do-not-call {
            border-left: 40px solid #dc3545;
            position: relative;
            box-shadow: 0 0 15px rgba(220, 53, 69, 0.3);
            background-color: rgba(220, 53, 69, 0.05);
        }

        #team-viewer-app .profile-main-info.do-not-call::before {
            content: "DO NOT CALL";
            position: absolute;
            left: -83px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
            color: white;
            font-weight: bold;
            font-size: 18px;
            letter-spacing: 1px;
            text-transform: uppercase;
            white-space: nowrap;
            z-index: 10;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        #team-viewer-app .profile-main-info.is-spiritual-director.do-not-call {
            box-shadow: 0 0 15px rgba(220, 53, 69, 0.4);
            border-left: 40px solid #dc3545;
            background-color: rgba(220, 53, 69, 0.05);
        }

        /* DECEASED STYLING */
        #team-viewer-app .profile-main-info.deceased {
            border-left: 40px solid #000000;
            position: relative;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            background-color: rgba(0, 0, 0, 0.05);
        }

        #team-viewer-app .profile-main-info.deceased::before {
            content: "DECEASED";
            position: absolute;
            left: -83px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
            color: white;
            font-weight: bold;
            font-size: 18px;
            letter-spacing: 1px;
            text-transform: uppercase;
            white-space: nowrap;
            z-index: 10;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        #team-viewer-app .profile-main-info.is-spiritual-director.deceased {
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
            border-left: 40px solid #000000;
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* Combined states - deceased takes priority over do-not-call */
        #team-viewer-app .profile-main-info.deceased.do-not-call {
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
            border-left: 40px solid #000000;
            background-color: rgba(0, 0, 0, 0.05);
        }

        #team-viewer-app .profile-main-info.is-spiritual-director.deceased.do-not-call {
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
            border-left: 40px solid #000000;
            background-color: rgba(0, 0, 0, 0.05);
        }

        #team-viewer-app .back-button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
        }

        #team-viewer-app .back-button:hover {
            /* REMOVED background-color */
        }

        #team-viewer-app .profile-view {
            display: none;
        }

        #team-viewer-app .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            background: #ffffff;
            padding: 15px 20px;
            border-radius: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid #dee2e6;
        }

        #team-viewer-app .nav-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        #team-viewer-app .nav-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        #team-viewer-app .nav-button:hover:not(:disabled) {
            /* REMOVED background-color */
        }

        #team-viewer-app .nav-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        #team-viewer-app .profile-counter {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        #team-viewer-app .profile-container {
            /* These card styles were causing a "card-in-card" layout problem. */
            /* background: #ffffff; */
            /* border-radius: 8px; */
            /* padding: 30px; */
            /* box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); */
            min-height: 500px;
            /* New layout properties to correctly space the cards */
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        #team-viewer-app .profile-main-info {
            border: 1px solid var(--border); /* This explicitly resets the border to the default card style. */
        }

        #team-viewer-app .profile-name {
            font-size: 1rem;
            font-weight: 900;
            color: #333;
            margin: 0 0 12px 0;
            margin-right: 15px;
            display: inline-block;
            vertical-align: middle;
        }

        #team-viewer-app .profile-weekend-info {
            display: inline-block;
            vertical-align: middle;
            margin-left: 15px;
            font-size: 0.8em;
            color: #333;
            font-weight: 600;
        }

        #team-viewer-app .main-info-item {
            margin: 6px 0;
            font-size: 14px;
            display: flex;
            align-items: flex-start;
        }

        #team-viewer-app .main-info-label {
            font-weight: bold;
            width: 100px;
            flex-shrink: 0;
            color: #555;
        }

        #team-viewer-app .main-info-value {
            color: #333;
            flex: 1;
        }

        #team-viewer-app .info-divider {
            margin: 0 8px;
            color: #999;
        }

        #team-viewer-app .last-served-highlight {
            background-color: #ffc107;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
            color: #333;
            display: inline-block;
            font-size: 0.9em;
        }

        #team-viewer-app .name-separator {
            display: inline-block;
            border-left: 1px solid #ccc;
            height: 24px;
            margin: 0 5px 0 15px;
            vertical-align: middle;
        }

        #team-viewer-app .legal-name-badge {
            display: inline-block;
            vertical-align: middle;
            margin-left: 12px;
            font-size: 0.7em;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 12px;
            background-color: #e9ecef;
            color: #495057;
            border: 1px solid #dee2e6;
        }

        #team-viewer-app .profile-detail-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 10px 0;
        }

        #team-viewer-app .roles-section {
            /* margin-top: 30px; */ /* Spacing is now handled by the parent container's gap */
        }

        #team-viewer-app .roles-title {
            font-weight: 900;
            /* margin-bottom: 15px; */
            font-size: 1rem;
            color: #333;
            /* border-bottom: 2px solid #007bff; */
            /* padding-bottom: 10px; */
        }

        #team-viewer-app .roles-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        #team-viewer-app .role-header-legend {
            display: grid;
            gap: 6px;
            margin-bottom: 8px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #team-viewer-app .role-header-legend.team-headers {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: auto;
            column-gap: 10px;
        }

        #team-viewer-app .role-header-legend.professor-headers {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: auto;
            column-gap: 10px;
        }

        #team-viewer-app .role-header-set {
            display: grid;
            grid-template-columns: 55% 15% 18% 12%;
            gap: 2px;
        }

        #team-viewer-app .role-header-name,
        #team-viewer-app .role-header-status,
        #team-viewer-app .role-header-last,
        #team-viewer-app .role-header-qty {
            padding: 10px 8px;
            background-color: #495057;
            color: white;
            border-radius: 4px;
            text-align: center;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #team-viewer-app .role-header-name {
            text-align: left;
        }

        #team-viewer-app .role-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(10, auto);
            gap: 6px;
            font-size: 13px;
        }
        #team-viewer-app .professor-grid {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(5, auto);
        }

        #team-viewer-app .rector-qualification-grid {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        #team-viewer-app .qualification-labels {
            display: flex;
            justify-content: space-around;
        }
        
        #team-viewer-app .qualification-label {
            flex: 1;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: #555;
            padding: 0 4px;
        }

        #team-viewer-app .segmented-bar-container {
            display: flex;
            width: 100%;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border);
            background-color: var(--bg);
        }

        #team-viewer-app .bar-segment {
            flex: 1;
            height: 100%;
        }

        #team-viewer-app .bar-segment.pass {
            background-color: var(--accentA);
        }

        #team-viewer-app .bar-segment.fail {
            background-color: var(--accentD);
        }

        #team-viewer-app .role-grid.professor-grid {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(5, auto);
        }

        #team-viewer-app .role-item {
            display: grid;
            grid-template-columns: 55% 15% 18% 12%;
            gap: 2px;
            align-items: stretch;
            margin-bottom: 2px;
            min-height: 32px;
        }

        #team-viewer-app .role-name,
        #team-viewer-app .role-status-cell,
        #team-viewer-app .role-last-cell,
        #team-viewer-app .role-qty-cell {
            padding: 6px 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 13px;
            min-height: 20px;
            display: flex;
            align-items: center;
        }

        #team-viewer-app .role-name {
            color: #333;
            justify-content: flex-start;
        }

        #team-viewer-app .role-status-cell,
        #team-viewer-app .role-last-cell,
        #team-viewer-app .role-qty-cell {
            justify-content: center;
        }

        #team-viewer-app .status-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #team-viewer-app .role-status {
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            font-weight: bold;
            color: white;
            font-size: 11px;
            flex-shrink: 0;
        }

        #team-viewer-app .service-info-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #team-viewer-app .service-separator {
            display: none;
        }

        #team-viewer-app .service-number {
            font-size: 11px;
            font-weight: 600;
            color: #333;
            text-transform: uppercase;
        }

        #team-viewer-app .quantity-separator {
            display: none;
        }

        #team-viewer-app .quantity-number {
            font-size: 11px;
            font-weight: 600;
            color: #28a745;
            text-transform: uppercase;
        }

        #team-viewer-app .status-N {
            background-color: #dc3545;
        }

        #team-viewer-app .status-I {
            background-color: #ffc107;
            color: #333;
        }

        #team-viewer-app .status-E {
            background-color: #28a745;
        }

        #team-viewer-app .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
        }

        #team-viewer-app .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            text-align: center;
        }

        #team-viewer-app .legend {
            display: flex;
            gap: 20px;
            font-size: 12px;
        }

        #team-viewer-app .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #team-viewer-app .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        #team-viewer-app .refresh-section {
            text-align: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        #team-viewer-app .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        #team-viewer-app .refresh-button,
        #team-viewer-app .edit-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        #team-viewer-app .refresh-button:hover,
        #team-viewer-app .edit-button:hover {
            /* REMOVED background-color */
        }

        #team-viewer-app .refresh-button:disabled,
        #team-viewer-app .edit-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        #team-viewer-app .edit-button {
            background-color: #007bff;
        }

        #team-viewer-app .edit-button:hover {
            /* REMOVED background-color */
        }

        #team-viewer-app .edit-mode .profile-main-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px 25px;
            align-items: center;
        }

        #team-viewer-app .edit-mode .profile-main-info .profile-header,
        #team-viewer-app .edit-mode .profile-main-info .full-width-item {
            grid-column: 1 / -1; /* Make header span both columns */
        }

        #team-viewer-app .edit-mode .main-info-value .editable-field {
            width: 100%;
            min-width: 180px;
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #007bff;
            background-color: #fff;
            font-size: 14px;
        }

        #team-viewer-app .edit-mode-toggle {
            display: flex;
            background-color: #e9ecef;
            border-radius: 6px;
            padding: 4px;
            border: 1px solid #ccc;
            width: 150px;
        }

        #team-viewer-app .edit-mode-toggle .opt {
            flex: 1;
            text-align: center;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        #team-viewer-app .edit-mode-toggle .opt.active {
            background-color: #28a745;
            color: white;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }

        #team-viewer-app .edit-mode-toggle .opt.active.danger {
            background-color: #dc3545;
        }

        #team-viewer-app .last-updated {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        #team-viewer-app .edit-mode .main-info-value input {
            background-color: #fff;
            border: 1px solid #007bff;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: text;
            font-family: inherit;
            font-size: inherit;
        }

        #team-viewer-app .edit-mode .main-info-value select {
            background-color: #fff;
            border: 1px solid #007bff;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: inherit;
        }

        #team-viewer-app .editable-field {
            font-family: inherit;
            font-size: inherit;
        }

        #team-viewer-app .edit-mode .role-status {
            cursor: pointer;
            border: 2px solid #333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s;
        }

        #team-viewer-app .edit-mode .role-status:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
        }

        #team-viewer-app .edit-mode .role-status:active {
            transform: scale(0.95);
        }

        #team-viewer-app .save-cancel-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        #team-viewer-app .edit-mode .role-last-cell input,
        #team-viewer-app .edit-mode .role-qty-cell input {
            width: 100%;
            padding: 4px;
            border: 1px solid #007bff;
            border-radius: 4px;
            background-color: #fff;
            font-size: 11px; /* MATCHED: non-edit font size */
            font-weight: 600; /* MATCHED: non-edit font weight */
            text-transform: uppercase; /* MATCHED: non-edit text transform */
            text-align: center;
            box-sizing: border-box;
            -moz-appearance: textfield; /* Firefox */
        }
        
        #team-viewer-app .edit-mode .role-last-cell input::-webkit-outer-spin-button,
        #team-viewer-app .edit-mode .role-last-cell input::-webkit-inner-spin-button,
        #team-viewer-app .edit-mode .role-qty-cell input::-webkit-outer-spin-button,
        #team-viewer-app .edit-mode .role-qty-cell input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #team-viewer-app .save-button,
        #team-viewer-app .cancel-button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }

        #team-viewer-app .save-button {
            background-color: #28a745;
            color: white;
        }

        #team-viewer-app .save-button:hover {
            /* REMOVED background-color */
        }

        #team-viewer-app .cancel-button {
            background-color: #6c757d;
            color: white;
        }

        #team-viewer-app .cancel-button:hover {
            /* REMOVED background-color */
        }

        #team-viewer-app .password-modal,
        #team-viewer-app .role-modal,
        #team-viewer-app .team-name-modal,
        #team-viewer-app .notification-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        #team-viewer-app .badge-export-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1100;
        }

        #team-viewer-app .password-modal-content,
        #team-viewer-app .role-modal-content,
        #team-viewer-app .team-name-modal-content,
        #team-viewer-app .notification-modal-content,
        #team-viewer-app .badge-export-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            width: 95%;
            max-width: 1000px;
        }

        #team-viewer-app .team-name-modal-content,
        #team-viewer-app .notification-modal-content,
        #team-viewer-app .badge-export-modal-content {
            max-width: 400px;
        }
        
        #team-viewer-app .team-name-modal-content {
            max-width: 500px;
        }

        #team-viewer-app .team-creation-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }
        
        #team-viewer-app .team-creation-button {
            padding: 20px;
            font-size: 18px;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid;
            transition: all 0.2s ease;
        }

        #team-viewer-app .team-creation-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #team-viewer-app .password-modal h3,
        #team-viewer-app .role-modal h3,
        #team-viewer-app .team-name-modal h3,
        #team-viewer-app .notification-modal h3,
        #team-viewer-app .badge-export-modal h3 {
            margin-top: 0;
            color: #333;
            text-align: center;
        }

        #team-viewer-app .password-input,
        #team-viewer-app .team-name-input,
        #team-viewer-app .badge-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }

        #team-viewer-app .password-error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        #team-viewer-app .password-buttons,
        #team-viewer-app .role-modal-buttons,
        #team-viewer-app .team-name-buttons,
        #team-viewer-app .badge-export-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        #team-viewer-app .password-submit,
        #team-viewer-app .password-cancel {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        #team-viewer-app .password-submit {
            background-color: #007bff;
            color: white;
        }

        #team-viewer-app .password-submit:hover {
            /* REMOVED background-color */
        }

        #team-viewer-app .password-cancel {
            background-color: #6c757d;
            color: white;
        }

        #team-viewer-app .password-cancel:hover {
            /* REMOVED background-color */
        }

        /* --- Team Modal Styles --- */
        #team-viewer-app .team-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
        }

        #team-viewer-app .team-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #f8f9fa;
            border-radius: 16px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            width: 95%;
            max-width: 1200px;
            height: 90vh;
            max-height: 850px;
            display: flex;
            flex-direction: column;
        }

        #team-viewer-app .team-modal-header {
            padding: 15px 25px;
            background-color: #28a745;
            color: white;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        #team-viewer-app .team-modal-title {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            line-height: 1.2;
        }

        #team-viewer-app .team-modal-subtitle {
            margin: 5px 0 0 0;
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            line-height: 1.1;
        }

        #team-viewer-app .team-close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.8);
            padding: 0;
            line-height: 1;
            transition: all 0.2s ease;
            position: absolute;
            top: 15px;
            right: 25px;
        }

        #team-viewer-app .team-close-btn:hover {
            /* REMOVED color */
            transform: scale(1.1);
        }

        #team-viewer-app .team-content {
            flex-grow: 1;
            padding: 20px 25px;
            overflow-y: auto;
            position: relative;
            /* For positioning the total card */
        }

        #team-viewer-app #teamGrid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #team-viewer-app .team-total-card {
            padding: 10px;
            border-radius: 16px;
            background-color: #fff;
            border: 1px solid #dee2e6;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.4);
        }

        #team-viewer-app .rector-section {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
        }

        #team-viewer-app .rector-title {
            font-weight: 600;
            font-size: 14px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        #team-viewer-app .rector-badge {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 6px 18px;
            border: 1px solid #28a745;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.4);
        }

        #team-viewer-app .rector-badge .remove-rector-btn {
            display: none;
            color: #fff;
            font-weight: bold;
            font-size: 14px;
        }

        #team-viewer-app .rector-badge:hover {
            background-color: #dc3545;
            border-color: #c82333;
            color: white;
        }

        #team-viewer-app .rector-badge:hover .rector-name {
            display: none;
        }

        #team-viewer-app .rector-badge:hover .remove-rector-btn {
            display: inline-block;
        }

        #team-viewer-app .team-close-modal-btn:hover {
            /* REMOVED background-color */
        }

        #team-viewer-app .team-export-btn,
        #team-viewer-app .team-clear-btn,
        #team-viewer-app .team-print-btn,
        #team-viewer-app .team-badge-export-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        #team-viewer-app .team-export-btn {
            background-color: #28a745;
            color: white;
        }

        #team-viewer-app .team-export-btn:hover {
            /* REMOVED background-color */
        }

        #team-viewer-app .team-print-btn {
            background-color: #ffc107;
            color: #333;
        }

        #team-viewer-app .team-print-btn:hover {
            /* REMOVED background-color */
        }

        #team-viewer-app .team-clear-btn {
            background-color: #dc3545;
            color: white;
        }

        #team-viewer-app .team-clear-btn:hover {
            /* REMOVED background-color */
        }

        #team-viewer-app .team-badge-export-btn {
            background-color: #007bff;
            color: white;
        }

        #team-viewer-app .team-badge-export-btn:hover {
            /* REMOVED background-color */
        }

        /* --- NEW: Custom Dropdown Styles --- */
        #team-viewer-app .dropdown-container {
            position: relative;
            display: inline-block;
            width: 100%; /* Make it fill the available space */
        }

        #team-viewer-app .dropdown-btn {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%; /* Ensure button takes full width of container */
            background: #fff;
            border: 1px solid #ddd;
            color: #333;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 300;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            text-align: left;
            height: 37px; /* Match input height */
            font-family: 'Source Sans Pro', sans-serif;
        }
        
        #team-viewer-app .dropdown-btn.disabled {
            background-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #ddd;
        }

        #team-viewer-app .dropdown-btn::after {
            content: '';
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 6px solid currentColor;
            margin-left: 12px;
            transition: transform 0.2s ease;
        }

        #team-viewer-app .dropdown-container.open .dropdown-btn::after {
            transform: rotate(180deg);
        }

        #team-viewer-app .dropdown-btn:hover:not(.disabled) {
            border-color: #007bff;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
        }

        #team-viewer-app .dropdown-content {
            display: none;
            position: absolute;
            background: white;
            width: 100%; /* Match button width */
            border-radius: 6px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            z-index: 100;
            top: 100%;
            left: 0;
            margin-top: 8px;
            border: 1px solid #e9ecef;
            overflow-y: auto;
            max-height: 250px;
            opacity: 0;
            transform: translateY(-5px);
            transition: all 0.2s ease;
        }

        #team-viewer-app .dropdown-container.open .dropdown-content {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        #team-viewer-app .dropdown-content a {
            color: #333;
            padding: 10px 16px;
            text-decoration: none;
            display: block;
            transition: background-color 0.2s ease;
            font-weight: 400;
            font-size: 14px;
        }

        #team-viewer-app .dropdown-content a:hover,
        #team-viewer-app .dropdown-content a.selected {
            background: #f0f8ff;
            color: #007bff;
        }

        #team-viewer-app .dropdown-content .dropdown-divider {
            height: 1px;
            margin: 5px 0;
            overflow: hidden;
            background-color: #e9ecef;
        }
        /* --- END: Custom Dropdown Styles --- */

        /* --- STYLES FOR NEW TEAM LIST PAGE (from old modal) --- */
        #team-list-app .card {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        #team-list-app .team-list-controls {
            padding: 15px 24px 20px;
            display: flex;
            align-items: flex-end;
            gap: 20px;
            border-bottom: 1px solid var(--border);
            justify-content: space-between;
        }

        #team-list-app .team-list-header-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 20px;
            align-items: center;
        }

        #team-list-app .team-total-card {
            padding: 8px 16px;
            border-radius: 12px;
            background-color: var(--bg);
            border: 1px solid var(--border);
            text-align: center;
            min-width: 150px;
        }
        
        #team-list-app .team-total-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #team-list-app .team-total-count {
            font-size: 2rem;
            font-weight: 700;
            color: var(--ink);
            line-height: 1.1;
        }

        #team-list-app .rector-section {
            text-align: center;
            margin-bottom: 0;
            padding: 16px;
            background: var(--panel-header);
            border-radius: 12px;
        }

        #team-list-app .rector-title {
            font-weight: 600;
            font-size: 14px;
            color: #6c757d;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        #team-list-app .rector-badge {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 6px 18px;
            border: 1px solid #28a745;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 700;
            color: #333;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.4);
        }
        
        #team-list-app .rector-badge:hover {
            background-color: #dc3545;
            border-color: #c82333;
            color: white;
        }
        
        #team-list-app .rector-badge:hover .rector-name {
            display: none;
        }
        
        #team-list-app .rector-badge .remove-rector-btn {
            display: none;
            color: #fff;
            font-weight: bold;
            font-size: 14px;
        }

        #team-list-app .rector-badge:hover .remove-rector-btn {
            display: inline-block;
        }
        
        #team-list-app #teamListGrid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #team-list-app .unified-team-section {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        #team-list-app .unified-team-header {
            background-color: #495057;
            color: white;
            padding: 8px 12px;
            border-radius: 12px 12px 0 0;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #team-list-app .team-header-count-badge {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
            margin-left: 8px;
            min-width: 18px;
            text-align: center;
        }

        #team-list-app .unified-team-members.two-column {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0;
        }
        
        #team-list-app .unified-team-members.two-column .unified-member-item {
            border-right: 1px solid #f0f0f0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        #team-list-app .unified-team-members.two-column .unified-member-item:nth-child(even) {
            border-right: none;
        }

        #team-list-app .single-role-name {
            font-weight: 500;
            color: #495057;
            min-width: 120px;
            flex-shrink: 0;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 0;
            margin: 0;
            display: flex;
            align-items: center;
        }

        #team-list-app .single-role-assigned {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-grow: 1;
            justify-content: space-between;
            padding: 8px 12px;
        }

        #team-list-app .unified-member-item {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            padding: 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
            min-height: 32px;
        }
        
        #team-list-app .unified-member-item:last-child {
            border-bottom: none;
        }

        #team-list-app .member-role-label {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }

        #team-list-app .member-role-label.head {
            background-color: #28a745;
            color: white;
        }

        #team-list-app .member-role-label.asst-head {
            background-color: #ffc107;
            color: #333;
        }

        #team-list-app .unified-member-name {
            color: #333;
            font-weight: 400;
            flex-grow: 1;
        }

        #team-list-app .remove-teammate-btn {
            background-color: #dc3545;
            color: white;
            border: 1px solid #dc3545;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: all 0.2s ease;
        }

        #team-list-app .remove-teammate-btn:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 3px 7px rgba(0,0,0,0.3);
        }
        
        /* --- END: STYLES FOR NEW TEAM LIST PAGE --- */

        /* RESTORED: View Team Button Green Color */
        #team-viewer-app .view-team-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #team-viewer-app .view-team-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        #team-viewer-app .view-team-button .team-count-badge {
            background-color: rgba(255, 255, 255, 0.25);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 8px;
        }

        /* --- RESTORED: Original Team Layout Styles --- */
        #team-viewer-app .unified-team-section {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 16px;
            margin-bottom: 15px;
        }

        #team-viewer-app .unified-team-header {
            background-color: #495057;
            color: white;
            padding: 8px 12px;
            border-radius: 16px 16px 0 0;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #team-viewer-app .team-header-count-badge {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
            margin-left: 8px;
            min-width: 18px;
            text-align: center;
        }

        #team-viewer-app .unified-team-members.two-column {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0;
        }

        #team-viewer-app .unified-team-members.two-column .unified-member-item {
            border-right: 1px solid #f0f0f0;
            border-bottom: 1px solid #f0f0f0;
        }

        #team-viewer-app .unified-team-members.two-column .unified-member-item:nth-child(even) {
            border-right: none;
        }

        #team-viewer-app .single-role-name {
            font-weight: 500;
            color: #495057;
            min-width: 120px;
            flex-shrink: 0;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 0;
            margin: 0;
            display: flex;
            align-items: center;
        }

        #team-viewer-app .single-role-assigned {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-grow: 1;
            justify-content: space-between;
            padding: 8px 12px;
        }

        #team-viewer-app .unified-member-item {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            padding: 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
            min-height: 32px;
        }

        #team-viewer-app .unified-member-item:last-child {
            border-bottom: none;
        }

        #team-viewer-app .member-role-label {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }

        #team-viewer-app .member-role-label.head {
            background-color: #28a745;
            color: white;
        }

        #team-viewer-app .member-role-label.asst-head {
            background-color: #ffc107;
            color: #333;
        }

        #team-viewer-app .unified-member-name {
            color: #333;
            font-weight: 400;
            flex-grow: 1;
        }

        #team-viewer-app .remove-teammate-btn {
            background-color: #dc3545;
            color: white;
            border: 1px solid #dc3545;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: all 0.2s ease;
        }

        #team-viewer-app .remove-teammate-btn:hover {
            /* REMOVED background-color and border-color */
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 3px 7px rgba(0,0,0,0.3);
        }

        /* --- End of Restored Styles --- */

        #team-viewer-app .role-assign-button .team-count-badge {
            background-color: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
        }

        #team-viewer-app .role-button-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-auto-flow: column;
            gap: 10px;
            margin-top: 20px;
        }

        #team-viewer-app .role-section {
            margin-bottom: 25px;
        }

        #team-viewer-app .role-section:last-child {
            margin-bottom: 0;
        }

        #team-viewer-app .role-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #28a745;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #team-viewer-app .role-assign-button {
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f8f9fa;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #team-viewer-app .role-assign-button:hover {
            /* REMOVED background-color, color, and border-color */
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
        }

        #team-viewer-app .role-assign-button:hover .team-count-badge {
            background-color: #218838;
            color: white;
        }

        /* --- Progress Bar Styles --- */
        #team-viewer-app .progress-bar-container {
            width: 100%;
            padding: 20px 0;
            grid-column: 1 / -1;
            /* Makes this item span all columns in the parent grid */
        }

        #team-viewer-app .progress-bar-label {
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        #team-viewer-app .progress-bar-track {
            width: 100%;
            height: 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        #team-viewer-app .progress-bar-fill {
            height: 100%;
            width: 100%;
            background-color: #28a745;
            position: absolute;
            top: 0;
            left: 0;
            transform: translateX(-100%);
            animation: tv-slide 2s linear infinite;
        }

        @keyframes tv-slide {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* Badge Export Modal Styles */
        #team-viewer-app .badge-form-group {
            margin-bottom: 15px;
        }

        #team-viewer-app .badge-form-label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        #team-viewer-app .badge-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        #team-viewer-app .badge-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
        }

        /* MCI Budget Styles */
        .budget-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .budget-layout-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            align-items: start;
        }
        .budget-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .budget-item {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
        }
        .budget-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background: var(--panel-header);
            border-bottom: 1px solid var(--border);
        }
        .budget-item-body {
            padding: 12px 16px;
        }
        .budget-item .role {
            font-weight: 700;
            font-size: 0.9rem;
        }
        .budget-item .financial-summary {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .disbursement-inputs {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 150px; /* More compact */
            overflow-y: auto;
            padding: 4px;
        }
        .disbursement-inputs .input {
            padding: 0.5rem;
            text-align: right;
            font-size: 0.9rem;
        }
        .disbursement-inputs .select {
            padding: 0.6rem .8rem; /* Refined padding for a cleaner look */
            font-size: 0.9rem;
            font-family: 'Source Sans Pro', sans-serif; /* This matches the app's button font */
            font-weight: 400; /* This removes the bold styling */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23a8b2be' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
        .disbursement-entry {
            display: grid;
            grid-template-columns: 100px 1fr auto; /* Add column for delete button */
            gap: 8px;
            align-items: center;
            margin-bottom: 6px;
        }
        .disbursement-entry:last-child {
            margin-bottom: 0;
        }
        .balance-positive {
            color: var(--accentA);
        }
        .balance-negative {
            color: var(--accentD);
        }

        .summary-grid {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .summary-card-clickable {
            cursor: pointer;
            transition: all 0.2s;
        }

        .summary-card-clickable:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            border-color: var(--accentB);
        }

        body.light-theme .summary-card-clickable:hover {
            box-shadow: 0 6px 15px rgba(0,0,0,0.12);
        }

        #noAttendanceList ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #noAttendanceList li {
            padding: 10px 4px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
        }
        
        #noAttendanceList li:last-child {
            border-bottom: none;
        }

        #emailReportsTbody .actions-cell {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        #recipientListContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .recipient-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 8px;
            background: var(--bg);
            border: 1px solid var(--border);
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .recipient-badge .delete-recipient-btn {
            background: transparent;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-weight: 900;
            padding: 0 4px;
        }

        .recipient-badge .delete-recipient-btn:hover {
            color: var(--accentD);
        }

        /* --- Report Preview Modal Styles --- */
        #previewModalBody {
            font-family: 'Source Sans Pro', sans-serif;
            background-color: var(--bg);
        }

        #report-preview-content {
            color: var(--ink);
        }

        #report-preview-content .report-header {
            text-align: center;
            border-bottom: 1px solid var(--border);
            padding-bottom: 16px;
            margin-bottom: 20px;
        }

        #report-preview-content .report-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        #report-preview-content .report-subtitle {
            font-size: 0.9rem;
            color: var(--muted);
            margin-top: 4px;
        }

        #report-preview-content .report-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        #report-preview-content .stat-card {
            background-color: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        #report-preview-content .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accentB);
        }

        #report-preview-content .stat-label {
            font-size: 0.85rem;
            color: var(--muted);
            margin-top: 4px;
        }

        #report-preview-content .table {
            font-size: 0.9rem;
        }
        
        #report-preview-content .table .badge {
            display: inline-block;
            padding: 3px 8px;
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: 999px;
            text-transform: uppercase;
        }

        #report-preview-content .table .badge.badge-warning {
            background-color: rgba(255, 193, 7, 0.15);
            color: var(--accentC);
        }

        #report-preview-content .table th {
            font-weight: 700;
            color: var(--ink);
        }

        #report-preview-content .table td {
            font-weight: 600;
            color: var(--muted);
        }
        #report-preview-content .table tr:last-child td {
            border-bottom: none;
        }


        /* ====================================================== */
        /* =========== START: USER MANAGEMENT UI CSS ============ */
        /* ====================================================== */
        #user-management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* --- NEW: Super Admin Status Pills --- */
        .status-badge-admin {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: capitalize;
        }
        .status-badge-admin.trial {
            background-color: rgba(255, 193, 7, 0.15); /* --accentC */
            color: var(--accentC);
        }
        .status-badge-admin.active {
            background-color: rgba(46, 164, 79, 0.15); /* --accentA */
            color: var(--accentA);
        }
        .status-badge-admin.waived {
            background-color: rgba(0, 163, 255, 0.15); /* --accentB */
            color: var(--accentB);
        }
        /* --- END: Super Admin Status Pills --- */

        #permissions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 20px;
        }

        .permission-item {
            display: flex;
            align-items: center;
            background: var(--bg);
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 8px;
        }

        .permission-item .label {
            margin: 0;
            flex-grow: 1;
            font-weight: 600;
        }

        /* Custom Checkbox Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--accentA);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--accentA);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* --- NEW: User List Table Styles --- */
        #user-list-table {
            margin-top: 20px;
        }

        #user-list-table .role-badge {
            display: inline-block;
            padding: 3px 10px;
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: 999px;
            text-transform: uppercase;
        }

        #user-list-table .role-badge.admin {
            background-color: rgba(0, 163, 255, 0.15);
            color: var(--accentB);
        }

        #user-list-table .role-badge.user {
            background-color: rgba(168, 178, 190, 0.15);
            color: var(--muted);
        }

        #user-list-table .actions-cell {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        /* --- END: User List Table Styles --- */

        /* --- NEW: Secretariat Config Styles --- */
        #secretariat-positions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px 24px; /* less vertical, more horizontal gap */
            margin-top: 16px;
        }

        .secretariat-position-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .secretariat-position-item .position-name {
            font-weight: 600;
            color: var(--muted);
        }

        .secretariat-position-item .term-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .secretariat-position-item .term-input {
            width: 70px;
            padding: 6px 10px;
            text-align: center;
            font-size: 0.9rem;
        }
        /* --- END: Secretariat Config Styles --- */

        /* --- UPDATED: Secretariat Dashboard Styles --- */
        .secretariat-dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .secretariat-card {
            background-color: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Important for new layout */
            position: relative; /* This is required for the banner's positioning */
        }

        .secretariat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: var(--panel-header);
            border-bottom: 1px solid var(--border);
        }

        .secretariat-card-body {
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .secretariat-card .position-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--ink);
        }

        .secretariat-card.is-interim .secretariat-card-header {
            background-color: var(--accentC); /* Yellow */
        }

        .secretariat-card.is-interim .secretariat-card-header .position-title {
            color: #212529; /* Dark text for contrast on yellow */
        }

        .secretariat-card .member-name {
            font-size: 0.8rem; /* Changed from 0.95rem */
            font-weight: 600;
            color: var(--ink); /* Changed from accentB for a cleaner look */
            min-height: 24px;
        }
        
        .secretariat-card .intern-info {
            font-size: 0.75rem;
            font-weight: 600;
            font-style: italic;
            color: var(--muted);
            margin-top: 4px;
            padding-left: 2px;
        }

        .secretariat-card .member-name.unfilled {
            color: var(--muted);
            font-style: italic;
        }

        .secretariat-card .term-info-footer {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-top: 4px;
        }

        .secretariat-card .term-dates {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--muted);
        }

        /* --- REPLACED: Progress Bar with Segmented Timeline --- */
        .secretariat-card .timeline-container {
            display: flex;
            gap: 4px;
            width: 100%;
        }

        .secretariat-card .timeline-segment {
            flex: 1;
            height: 10px;
            background-color: var(--bg);
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid var(--border);
            position: relative; /* Needed for the overlay */
        }

        .secretariat-card .timeline-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
        }
        
        .secretariat-card .timeline-fill.green { background-color: var(--accentA); }
        .secretariat-card .timeline-fill.yellow { background-color: var(--accentC); }
        .secretariat-card .timeline-fill.red { background-color: var(--accentD); }
        
        .secretariat-card .timeline-transition-overlay {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 50%; /* Represents a 6-month transition in a 12-month segment */
            background-image: repeating-linear-gradient(
                -45deg,
                transparent,
                transparent 3px,
                rgba(255, 255, 255, 0.2) 3px,
                rgba(255, 255, 255, 0.2) 6px
            );
            border-top-right-radius: 5px;
            border-bottom-right-radius: 5px;
        }
        /* --- END: Replacement --- */

        .secretariat-card .time-remaining {
            font-size: 0.8rem;
            font-weight: 700;
        }
        /* --- END: Secretariat Dashboard Styles --- */

        /* --- REMOVED: Interim Banner Style --- */
        /* The .interim-banner-wrapper and .interim-banner styles have been removed. */

        /* --- NEW: Roster Management Modal Styles --- */
        #rosterManagementModal .modal-body-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px 24px;
        }

        .roster-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .roster-item-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .roster-item-position {
            font-weight: 700;
            font-size: 0.95rem;
        }

        .roster-item-member {
            font-size: 0.85rem;
            color: var(--muted);
            font-style: italic;
        }
        /* --- END: Roster Modal Styles --- */

        /* ====================================================== */
        /* ============ END: USER MANAGEMENT UI CSS ============= */
        /* ====================================================== */

        /* ====================================================== */
        /* =========== START: TEAM VIEWER SCOPED CSS ============ */
        /* ====================================================== */

    </style>
</head>

<body class="light-theme">
    <!-- ====================================================== -->
    <!-- ============== START: AUTHENTICATION UI ============== -->
    <!-- ====================================================== -->
    <div id="auth-container" style="display: none;">
        <div class="auth-card">
            <div class="auth-image-panel">
                <!-- This is where your cross image will appear. -->
                <!-- Ensure the image file is named 'cross-logo.png' in your project root, -->
                <!-- or update the path here. -->
            </div>
            <div class="auth-form-panel">
                <!-- Login View -->
                <div id="login-view">
                    <h2 class="auth-title">Welcome Back</h2>
                    <p class="auth-subtitle">Please sign in to continue.</p>
                    <div class="field"><label class="label">Email Address</label><input class="input" id="loginEmail" type="email" placeholder="you@example.com"></div>
                    <div class="field"><label class="label">Password</label><input class="input" id="loginPassword" type="password" placeholder="••••••••"></div>
                    <button id="loginButton" class="btn btn-primary" style="width: 100%;">Log In</button>
                    <div class="auth-links">
                        <a href="#" id="forgotPasswordLink">Forgot Password?</a>
                        <span>•</span>
                        <a href="#" id="showSignupLink">Don't have an account? Sign Up</a>
                    </div>
                </div>

                <!-- Sign Up View -->
                <div id="signup-view" style="display: none;">
                    <h2 class="auth-title">Create an Account</h2>
                    <p class="auth-subtitle">Get started with your community.</p>
                    <div class="grid grid-2">
                        <div class="field"><label class="label">Full Name</label><input class="input" id="signupName" placeholder="John Doe"></div>
                        <div class="field"><label class="label">Organization Name</label><input class="input" id="signupOrgName" placeholder="Community Name"></div>
                    </div>
                    <div class="field"><label class="label">Email Address</label><input class="input" id="signupEmail" type="email" placeholder="you@example.com"></div>
                    <div class="field"><label class="label">Create Password</label><input class="input" id="signupPassword" type="password" placeholder="••••••••"></div>
                    <button id="signupButton" class="btn btn-primary" style="width: 100%;">Create Account</button>
                    <div class="auth-links">
                        <a href="#" id="showLoginLink_fromSignup">Already have an account? Sign In</a>
                    </div>
                </div>

                <!-- Forgot Password View -->
                <div id="forgot-password-view" style="display: none;">
                    <h2 class="auth-title">Reset Password</h2>
                    <p class="auth-subtitle">Enter your email to receive a password reset link.</p>
                    <div class="field"><label class="label">Email Address</label><input class="input" id="resetEmail" type="email" placeholder="you@example.com"></div>
                    <button id="resetButton" class="btn btn-primary" style="width: 100%;">Send Reset Link</button>
                    <div class="auth-links">
                        <a href="#" id="showLoginLink_fromReset">Back to Sign In</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ====================================================== -->
    <!-- =============== END: AUTHENTICATION UI =============== -->
    <!-- ====================================================== -->

    <div class="app-container" style="display: none;">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img class="logo" src="https://static.wixstatic.com/media/953fd6_8f0412db929d426b8feff830ee3fea0f~mv2.png" alt="Logo" />
                <span class="company-name" id="sidebarCompanyName">Placeholder Inc.</span>
            </div>
            <nav style="display: flex; flex-direction: column; flex: 1;">
                <ul class="sidebar-nav" id="sidebarList">
                    <!-- NAV ITEM FOR TEAM VIEWER -->
                    <li class="nav-item has-submenu">
                        <a href="#" data-app-id="team-viewer-app">
                            <span class="nav-text">Directory</span>
                        </a>
                        <ul class="submenu">
                            <li class="submenu-item"><a href="#" data-app-id="team-list-app">Team List</a></li>
                        </ul>
                    </li>
                    <!-- EXISTING NAV ITEMS -->
                    <li class="nav-item"><a href="#" data-app-id="team-book"><span class="nav-text">Team Book</span></a></li>
                    <li class="nav-item has-submenu" id="mci-nav-parent">
                        <a href="#" data-app-id="meeting-check-in-app">
                            <span class="nav-text">Team Meetings</span>
                        </a>
                        <ul class="submenu">
                            <li class="submenu-item"><a href="#" data-mci-action="show_checkin">Check-In</a></li>
                            <li class="submenu-item"><a href="#" data-mci-action="show_reports">Reports</a></li>
                            <li class="submenu-item"><a href="#" data-mci-action="show_budget">Budget</a></li>
                        </ul>
                    </li>
                    <li class="nav-item has-submenu" id="cra-nav-parent">
                        <a href="#" data-app-id="candidate-registration">
                            <span class="nav-text">Candidate Registration</span>
                        </a>
                        <ul class="submenu">
                            <li class="submenu-item"><a href="#" data-cra-action="entry">New Application</a></li>
                            <li class="submenu-item"><a href="#" data-cra-action="followup">Follow-up Calls</a></li>
                            <li class="submenu-item"><a href="#" data-cra-action="apps">View Roster</a></li>
                            <li class="submenu-item"><a href="#" data-cra-action="checkin">Live Check-in</a></li>
                            <li class="submenu-item"><a href="#" data-cra-action="reports">Reports</a></li>
                            <li class="submenu-item"><a href="#" data-cra-action="email">Email Reports</a></li>
                        </ul>
                    </li>
                    <li class="nav-item"><a href="#" data-app-id="secretariat-app"><span class="nav-text">Secretariat</span></a></li>
                </ul>
                <div class="sidebar-footer">
                    <ul class="sidebar-nav">
                        <li class="nav-item"><a href="#" data-app-id="app-settings"><span class="nav-text">Settings</span></a></li>
                        <li class="nav-item" id="superAdminLink" style="display: none;"><a href="#" data-app-id="super-admin-app"><span class="nav-text">Super Admin</span></a></li>
                        <li class="nav-item"><a href="#" id="logoutButton"><span class="nav-text" style="color: var(--accentD);">Log Out</span></a></li>
                    </ul>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <div id="mainStatusBar"></div>
            <div class="main-header">
                <h1 id="app-title">Team Viewer</h1>
            </div>
            <div class="app-panel-container">
                
                <!-- ====================================================== -->
                <!-- ============ START: TEAM VIEWER APP PANEL ============ -->
                <!-- ====================================================== -->
                <section id="team-viewer-app" class="app-panel" style="display:block;">
                     <div class="container">
                        
                        <div id="directoryView" class="directory-container">
                           <div class="card pad">
                                <div class="controls-main-grid">
                                    <div class="controls-left-panel">
                                        <div class="search-group">
                                            <label class="label">Search By</label>
                                            <div class="search-input-group">
                                                <input type="text" id="nameSearch" class="search-input" placeholder="First, Last or Weekend Number" onkeypress="if(event.key==='Enter') TV.performSearch()">
                                                <button class="search-button" onclick="TV.performSearch()">Search</button>
                                            </div>
                                        </div>
                                        <div class="search-group">
                                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                                <div class="field" style="margin:0;">
                                                    <label class="label">Primary Filter</label>
                                                    <div id="primaryFilterDropdown" class="dropdown-container" data-selected-value="">
                                                        <button class="dropdown-btn">Select Primary Filter...</button>
                                                        <div class="dropdown-content">
                                                            <a href="#" data-value="">None (Default Sort)</a>
                                                            <a href="#" data-value="recent">Most Recently Served</a>
                                                            <a href="#" data-value="never-served">Never Served</a>
                                                            <div class="dropdown-divider"></div>
                                                            <a href="#" data-value="rector-qualified">Rector Qualified</a>
                                                            <a href="#" data-value="rector-qualified-minus-1">Rector Qualified (Minus 1)</a>
                                                            <a href="#" data-value="rector-qualified-minus-2">Rector Qualified (Minus 2)</a>
                                                            <a href="#" data-value="head-asst-head-qualified">Head / Asst Head Qualified</a>
                                                            <a href="#" data-value="kitchen-qualified">Head / Asst Kitchen Qualified</a>
                                                            <a href="#" data-value="bur-qualified">BUR Qualified</a>
                                                            <a href="#" data-value="dorm-qualified">Head Dorm Qualified</a>
                                                            <a href="#" data-value="prayer-qualified">Head Prayer Qualified</a>
                                                            <a href="#" data-value="chapel-qualified">Head Chapel Qualified</a>
                                                            <a href="#" data-value="table-qualified">Head Table Qualified</a>
                                                            <a href="#" data-value="worship-qualified">Head Worship Qualified</a>
                                                            <a href="#" data-value="palanca-qualified">Head Palanca Qualified</a>
                                                            <a href="#" data-value="gopher-qualified">Head Gopher Qualified</a>
                                                            <a href="#" data-value="storeroom-qualified">Head Storeroom Qualified</a>
                                                            <a href="#" data-value="floater-supply-qualified">Head Floater Supply Qualified</a>
                                                            <a href="#" data-value="spiritual-director-qualified">Spiritual Director Qualified</a>
                                                            <div class="dropdown-divider"></div>
                                                            <a href="#" data-value="role-rector-e">Experienced Rector</a>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="field" style="margin:0;">
                                                    <label class="label">Secondary Filter</label>
                                                    <div id="secondaryFilterDropdown" class="dropdown-container" data-selected-value="alpha-asc">
                                                        <button class="dropdown-btn disabled">Select Sort Order...</button>
                                                        <div class="dropdown-content">
                                                            <a href="#" data-value="alpha-asc">Last Name (A-Z)</a>
                                                            <a href="#" data-value="alpha-desc">Last Name (Z-A)</a>
                                                            <a href="#" data-value="weekend-desc">Weekend # (High-Low)</a>
                                                            <a href="#" data-value="weekend-asc">Weekend # (Low-High)</a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="controls-right-panel">
                                        <label class="label">Select Team</label>
                                        <div class="toggle-inset-container" id="genderToggleContainer">
                                            <div class="toggle-inset-option active" onclick="TV.selectGender('men', this)">Men</div>
                                            <div class="toggle-inset-option" onclick="TV.selectGender('women', this)">Women</div>
                                        </div>
                                        <label class="label">Display Options</label>
                                        <div class="toggle-inset-container" id="nameFormatToggle">
                                            <div class="toggle-inset-option active" onclick="TV.selectNameFormat('firstLast', this)">First / Last</div>
                                            <div class="toggle-inset-option" onclick="TV.selectNameFormat('lastFirst', this)">Last / First</div>
                                        </div>
                                        <div class="utility-buttons">
                                            <button class="clear-button" onclick="TV.clearSearch()">Clear</button>
                                            <button class="print-button" onclick="TV.printReport()">Print Report</button>
                                            <button class="view-team-button" onclick="TV.openTeamNameModal()">
                                                Manage Latest Weekend
                                                <span class="team-count-badge" id="teamCountBadgeProfile" style="display: none;">0</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card pad">
                                <div class="directory-header">
                                    <h2 class="directory-title" id="directoryTitle">Directory</h2>
                                    <span class="directory-count" id="directoryCount">0 results</span>
                                </div>
                                <div class="names-grid" id="namesGrid">
                                    <div class="loading">Loading initial data...</div>
                                </div>
                            </div>
                        </div>

                        <div id="profileView" class="profile-view">
                            <div class="navigation">
                                <button class="back-button" onclick="TV.showDirectory()">← Back to Directory</button>
                                <div class="nav-controls">
                                    <button id="prevButton" class="nav-button" onclick="TV.navigateProfile(-1)" disabled>Previous</button>
                                    <span id="profileCounter" class="profile-counter">0 of 0</span>
                                    <button id="nextButton" class="nav-button" onclick="TV.navigateProfile(1)" disabled>Next</button>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="print-button" onclick="TV.printProfile()">Print Profile</button>
                                    <button class="view-team-button" onclick="TV.openRoleModal()">
                                        Add to Team
                                    </button>
                                </div>
                            </div>

                            <div id="profileContainer" class="profile-container">
                                <!-- Profile content will be dynamically rendered here -->
                            </div>

                            <div class="refresh-section" style="margin-top: 16px;">
                                <div class="button-group">
                                    <button id="refreshButton" class="refresh-button" onclick="TV.fetchDataFromSupabase().then(() => TV.renderProfile())">Refresh Data</button>
                                    <button id="editButton" class="edit-button" onclick="TV.requestEditMode()">Edit Profile</button>
                                </div>
                                <div id="lastUpdated" class="last-updated" style="margin-top: 8px; font-size: 12px; color: #666;"></div>
                            </div>
                            <div id="editModeControls" class="save-cancel-buttons" style="display: none;">
                                <button class="cancel-button" onclick="TV.cancelEdit()">Cancel</button>
                                <button class="save-button" onclick="TV.saveChanges()">Save Changes</button>
                            </div>
                        </div>

                        <!-- Modals specific to Team Viewer -->
                        <div id="passwordModal" class="password-modal">
                            <div class="password-modal-content">
                                <h3>Enter Password to Edit</h3>
                                <input type="password" id="passwordInput" class="password-input" onkeypress="if(event.key==='Enter') TV.checkPassword()">
                                <p id="passwordError" class="password-error">Incorrect password. Please try again.</p>
                                <div class="password-buttons">
                                    <button class="password-cancel" onclick="TV.closePasswordModal()">Cancel</button>
                                    <button class="password-submit" onclick="TV.checkPassword()">Submit</button>
                                </div>
                            </div>
                        </div>

                        <div id="roleModal" class="role-modal">
                            <div class="role-modal-content">
                                <h3>Assign Role</h3>
                                <div id="roleButtonGrid"></div>
                                <div class="role-modal-buttons">
                                    <button class="password-cancel" onclick="TV.closeRoleModal()">Close</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="teamNameModal" class="team-name-modal">
                            <div class="team-name-modal-content">
                                <h3>Manage or Create a Team</h3>
                                <div class="team-creation-options">
                                    <button id="loadWomenTeamBtn" class="team-creation-button" style="border-color: #dc3545; color: #dc3545;" onclick="TV.loadLatestTeam('women')" disabled>Load Women's Team</button>
                                    <button id="createWomenTeamBtn" class="team-creation-button" style="background-color: #dc3545; color: white;" onclick="TV.createNewTeam('women')" disabled>Create New Women's Team</button>
                                </div>
                                <hr class="control-panel-divider">
                                <div class="team-creation-options">
                                    <button id="loadMenTeamBtn" class="team-creation-button" style="border-color: #007bff; color: #007bff;" onclick="TV.loadLatestTeam('men')" disabled>Load Men's Team</button>
                                    <button id="createMenTeamBtn" class="team-creation-button" style="background-color: #007bff; color: white;" onclick="TV.createNewTeam('men')" disabled>Create New Men's Team</button>
                                </div>
                                <div class="team-name-buttons">
                                    <button class="password-cancel" onclick="TV.closeTeamNameModal()">Cancel</button>
                                </div>
                            </div>
                        </div>

                        <div id="notificationModal" class="notification-modal">
                            <div class="notification-modal-content">
                                <h3 id="notificationTitle">Notification</h3>
                                <p id="notificationMessage" style="margin-top: 15px; text-align: center;"></p>
                                <div class="team-name-buttons">
                                    <button class="password-submit" onclick="TV.closeNotificationModal()">OK</button>
                                </div>
                            </div>
                        </div>

                        <div id="badgeExportModal" class="badge-export-modal">
                            <div class="badge-export-modal-content">
                                <h3>Export to Team Badges</h3>
                                <div class="badge-form-group">
                                    <label for="badgeGenderIndicator" class="badge-form-label">Team:</label>
                                    <p id="badgeGenderIndicator" style="font-weight: bold; font-size: 1.1em;"></p>
                                </div>
                                <div class="badge-form-group">
                                    <label for="badgeWeekendNumber" class="badge-form-label">Weekend Number:</label>
                                    <input type="text" id="badgeWeekendNumber" class="badge-input" placeholder="e.g., 101">
                                </div>
                                <div class="badge-form-group">
                                    <label for="badgeWeekendDates" class="badge-form-label">Weekend Dates:</label>
                                    <input type="text" id="badgeWeekendDates" class="badge-input" placeholder="e.g., Oct 24-27, 2024">
                                </div>
                                <div class="badge-export-buttons">
                                    <button class="password-cancel" onclick="TV.closeBadgeExportModal()">Cancel</button>
                                    <button class="password-submit" onclick="TV.generateBadgeCSV()">Generate CSV</button>
                                </div>
                            </div>
                        </div>

                    </div>
                </section>
                <!-- ====================================================== -->
                <!-- ============ END: TEAM VIEWER APP PANEL ============= -->
                <!-- ====================================================== -->

                <!-- ====================================================== -->
                <!-- ============ START: TEAM LIST APP PANEL ============== -->
                <!-- ====================================================== -->
                <section id="team-list-app" class="app-panel" style="display:none; padding: 0;">
                    <div class="card">
                        <div class="section-title" id="teamListTitle" style="margin: 24px 24px 0; padding-bottom: 20px;">
                            <!-- Title will be rendered here by JS -->
                        </div>
                        <div class="team-list-controls">
                            <div>
                                <label class="label">Select Team Roster</label>
                                <div class="toggle" id="teamListGenderToggle" style="max-width: 250px;">
                                    <div class="opt active" data-gender="men">Men</div>
                                    <div class="opt" data-gender="women">Women</div>
                                </div>
                            </div>
                        </div>
                        <div class="team-content" style="flex-grow: 1; padding: 20px 24px; overflow-y: auto; position: relative;">
                            <div id="teamListGrid">
                                <!-- Content from the modal will be rendered here -->
                            </div>
                        </div>
                        <div class="team-actions" style="padding: 15px 24px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                             <div>
                                <span style="font-size: 14px; color: var(--muted);">Team for: <strong id="teamGenderDisplayPanel">Men</strong></span>
                            </div>
                            <div class="team-action-buttons" style="display: flex; gap: 10px;">
                                <button class="btn btn-warning" onclick="TV.printTeamRoster()">Print Report</button>
                                <button class="btn btn-warning" onclick="TV.printAllTeamProfiles()">Print All Profiles</button>
                                <button class="btn btn-primary" onclick="TV.exportTeam()">Export for Team Book</button>
                                <button class="btn btn-info" onclick="TV.openBadgeExportModal()">Export to Team Badges</button>
                                <button class="btn btn-danger" onclick="TV.clearTeam()">Clear All</button>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- ====================================================== -->
                <!-- ============= END: TEAM LIST APP PANEL ============== -->
                <!-- ====================================================== -->


                <!-- ====================================================== -->
                <!-- ================ START: TEAM BOOK PANEL ============== -->
                <!-- ====================================================== -->
                <section id="team-book" class="app-panel" style="display:none;">
                    <div class="card pad" style="text-align: center; margin: auto; max-width: 500px;">
                        <h2 style="font-size: 2rem; color: var(--muted);">Coming Soon</h2>
                        <p style="color: var(--muted); margin-top: 10px;">This feature is currently under development.</p>
                    </div>
                </section>
                <!-- ====================================================== -->
                <!-- ================= END: TEAM BOOK PANEL =============== -->
                <!-- ====================================================== -->


                <!-- ====================================================== -->
                <!-- ============== START: SECRETARIAT PANEL ============= -->
                <!-- ====================================================== -->
                <section id="secretariat-app" class="app-panel" style="display:none;">
                    <div id="secretariat-dashboard-container" class="secretariat-dashboard-grid">
                        <!-- Secretariat dashboard cards will be rendered here by JS -->
                    </div>
                </section>
                <!-- ====================================================== -->
                <!-- =============== END: SECRETARIAT PANEL ============== -->
                <!-- ====================================================== -->


                <section id="meeting-check-in-app" class="app-panel mci-app" style="display:none;">
                    <div id="mciControls" style="margin-bottom: 16px; display: none; max-width: 250px;">
                        <div>
                             <label class="label">Select Team</label>
                             <div class="toggle" id="mciGenderToggle">
                                <div class="opt active" data-gender="men">Men</div>
                                <div class="opt" data-gender="women">Women</div>
                             </div>
                        </div>
                    </div>

                    <div id="mciInitialPrompt" class="card pad" style="margin: auto; text-align: center; max-width: 500px;">
                        <h2 style="margin-bottom: 10px;">Meeting Check-In</h2>
                        <p style="color: var(--muted); line-height: 1.6;">
                            Please select a team to begin. Use the sidebar menu to load the latest Men's or Women's team roster and their check-in data.
                        </p>
                    </div>

                    <div id="mciMain" class="main-container" style="display: none;">
                        <div class="member-list">
                            <div class="list-header">
                                <span>Team Members (<span id="memberCount">0</span>)</span>
                                <button class="btn btn-danger btn-small" onclick="MCI.showClearOptionsModal()">Clear</button>
                            </div>
                            <div class="status-legend">
                                <span class="status-label">Meetings</span>
                                <span class="status-label">Weekend</span>
                                <span class="status-label">Team</span>
                                <span class="status-label">Palanca</span>
                            </div>
                            <div id="membersList" class="list-content">
                                <div class="empty-list-message">No team members loaded. Click 'Import Team' to begin.</div>
                            </div>
                        </div>

                        <div class="detail-panel">
                            <div class="status-bar" id="mciStatusBar"></div>
                            <div class="meeting-control-container">
                                <div id="detailPanelName">Select a Member</div>
                            </div>
                            <div id="detailContent">
                                <div class="empty-list-message" style="margin: auto;">Select a team member to check them in.</div>
                            </div>
                        </div>
                    </div>

                    <div id="budgetScreen" style="display:none; flex-direction:column; height: 100%;">
                        <div class="detail-panel" style="flex: 1;"> <!-- Use detail-panel class and make it grow -->
                            <div class="reports-header">
                                <h2 id="budget-header-title">Budget</h2>
                            </div>
                            <div id="budget-table-container" style="padding: 24px; overflow-y: auto; height: 100%;">
                                <!-- Budget table will be rendered here by JS -->
                            </div>
                        </div>
                    </div>

                    <div id="reportsScreen" style="display:none; flex-direction:column; height: 100%;">
                        <div class="detail-panel" style="flex: 1; display: flex; flex-direction: column;">
                            <div class="reports-header">
                                <h2>Team Reports</h2>
                            </div>
                            <div style="overflow-y: auto; flex-grow: 1; padding: 24px; display: flex; flex-direction: column; gap: 16px;">
                                <div class="summary-grid">
                                    <div class="card pad">
                                        <div class="label">Total Expected</div>
                                        <div id="totalExpected" style="font-size:28px;font-weight:900">$0.00</div>
                                    </div>
                                    <div class="card pad">
                                        <div class="label">Total Collected</div>
                                        <div id="totalCollected" style="font-size:28px;font-weight:900">$0.00</div>
                                    </div>
                                    <div class="card pad">
                                        <div class="label">Balance Due</div>
                                        <div id="balanceDue" style="font-size:28px;font-weight:900">$0.00</div>
                                    </div>
                                    <div class="card pad">
                                        <div class="label">Overdue Items</div>
                                        <div id="overdueItems" style="font-size:28px;font-weight:900">0</div>
                                    </div>
                                    <div id="noAttendanceCard" class="card pad summary-card-clickable">
                                        <div class="label">No Attendance</div>
                                        <div id="noAttendanceCount" style="font-size:28px;font-weight:900">0</div>
                                    </div>
                                </div>
                                <div class="card pad">
                                    <div class="section-title">Meeting Summary</div>
                                    <div class="grid grid-3">
                                        <div class="card pad">
                                            <div class="small-card-header">Meeting 1</div>
                                            <div class="financial-line"><span>Attended:</span><span id="meeting1Attendees">0</span></div>
                                            <div class="financial-line"><span>Percent:</span><span id="meeting1Percentage">0%</span></div>
                                        </div>
                                        <div class="card pad">
                                            <div class="small-card-header">Meeting 2</div>
                                            <div class="financial-line"><span>Attended:</span><span id="meeting2Attendees">0</span></div>
                                            <div class="financial-line"><span>Percent:</span><span id="meeting2Percentage">0%</span></div>
                                        </div>
                                        <div class="card pad">
                                            <div class="small-card-header">Meeting 3</div>
                                            <div class="financial-line"><span>Attended:</span><span id="meeting3Attendees">0</span></div>
                                            <div class="financial-line"><span>Percent:</span><span id="meeting3Percentage">0%</span></div>
                                        </div>
                                        <div class="card pad">
                                            <div class="small-card-header">Meeting 4</div>
                                            <div class="financial-line"><span>Attended:</span><span id="meeting4Attendees">0</span></div>
                                            <div class="financial-line"><span>Percent:</span><span id="meeting4Percentage">0%</span></div>
                                        </div>
                                        <div class="card pad">
                                            <div class="small-card-header">Meeting 5</div>
                                            <div class="financial-line"><span>Attended:</span><span id="meeting5Attendees">0</span></div>
                                            <div class="financial-line"><span>Percent:</span><span id="meeting5Percentage">0%</span></div>
                                        </div>
                                        <div class="card pad">
                                            <div class="small-card-header">Meeting 6</div>
                                            <div class="financial-line"><span>Attended:</span><span id="meeting6Attendees">0</span></div>
                                            <div class="financial-line"><span>Percent:</span><span id="meeting6Percentage">0%</span></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card pad">
                                    <div class="section-title">Financial Summary</div>
                                    <div class="grid grid-3">
                                        <div class="card pad">
                                            <div class="small-card-header">Weekend</div>
                                            <div class="financial-line"><span>Expected:</span><span id="weekendExpected">$0.00</span></div>
                                            <div class="financial-line"><span>Collected:</span><span id="weekendCollected">$0.00</span></div>
                                            <div class="financial-line"><span>Balance:</span><span id="weekendBalance">$0.00</span></div>
                                        </div>
                                        <div class="card pad">
                                            <div class="small-card-header">Team</div>
                                            <div class="financial-line"><span>Expected:</span><span id="teamExpected">$0.00</span></div>
                                            <div class="financial-line"><span>Collected:</span><span id="teamCollected">$0.00</span></div>
                                            <div class="financial-line"><span>Balance:</span><span id="teamBalance">$0.00</span></div>
                                        </div>
                                        <div class="card pad">
                                            <div class="small-card-header">Payment Methods</div>
                                            <div class="financial-line"><span>Cash:</span><span id="cashCollected" style="color: var(--accentA);">$0.00</span></div>
                                            <div class="financial-line"><span>Check:</span><span id="checkCollected" style="color: var(--accentB);">$0.00</span></div>
                                            <div class="financial-line"><span>Online:</span><span id="onlineCollected" style="color: var(--accentC);">$0.00</span></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card pad">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                        <div class="section-title" style="margin-bottom: 0;">Team Summary</div>
                                        <button class="btn btn-warning" onclick="MCI.printStatusReport()">Print PDF Report</button>
                                    </div>
                                    <table class="table" id="statusReportTable">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Role</th>
                                                <th style="text-align:center">Meetings</th>
                                                <th style="text-align:center">Weekend Fee</th>
                                                <th style="text-align:center">Team Fee</th>
                                                <th style="text-align:center">Palanca</th>
                                                <th style="text-align:center">Overall</th>
                                            </tr>
                                        </thead>
                                        <tbody id="statusTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="candidate-registration" class="app-panel" style="display:none">

                    <div id="cra-main-view">
                        <div id="cra-entry" class="cra-view card pad">
                            <div class="section-title">Candidate – General Information</div>
                            <div class="grid grid-3">
                                <div class="field"><label class="label">Last Name</label><input class="input" id="c_lastname" required></div>
                                <div class="field"><label class="label">Street Address</label><input class="input" id="c_address"></div>
                                <div class="field"><label class="label">City</label><input class="input" id="c_city"></div>
                                <div class="field"><label class="label">State</label><input class="input" id="c_state" maxlength="2"></div>
                                <div class="field"><label class="label">ZIP</label><input class="input" id="c_zip"></div>
                                <div class="field"><label class="label">Church</label><input class="input" id="c_church"></div>
                            </div>

                            <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px;">
                                <div class="field" style="flex: 1; min-width: 220px; margin-bottom: 0;">
                                    <label class="label">Married?</label>
                                    <div class="toggle" id="c_ms">
                                        <div class="opt active" data-val="no">No</div>
                                        <div class="opt" data-val="yes">Yes</div>
                                    </div>
                                </div>
                                <div class="field" style="flex: 1; min-width: 220px; margin-bottom: 0;">
                                    <label class="label">Pastor/Clergy?</label>
                                    <div class="toggle" id="c_clergy">
                                        <div class="opt active" data-val="no">No</div>
                                        <div class="opt" data-val="yes">Yes</div>
                                    </div>
                                </div>
                                <div class="field" style="flex: 1; min-width: 220px; margin-bottom: 0;">
                                    <label class="label">Spouse Attended Tres Dias?</label>
                                    <div class="toggle" id="c_spouseatt">
                                        <div class="opt active" data-val="no">No</div>
                                        <div class="opt" data-val="yes">Yes</div>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-2">
                                <div>
                                    <div class="section-title">Male Candidate</div>
                                    <div class="grid" style="grid-template-columns: repeat(6, 1fr); gap: 8px 16px;">
                                        <div class="field" style="grid-column: span 3;"><label class="label">First Name</label><input class="input" id="m_first"></div>
                                        <div class="field" style="grid-column: span 2;"><label class="label">Preferred Name</label><input class="input" id="m_pref"></div>
                                        <div class="field" style="grid-column: span 1;"><label class="label">Age</label><input type="text" class="input" id="m_age"></div>
                                        <div class="field" style="grid-column: span 3;"><label class="label">Cell</label><input class="input" id="m_cell"></div>
                                        <div class="field" style="grid-column: span 3;"><label class="label">Email</label><input type="email" class="input" id="m_email"></div>
                                        <div class="field" style="grid-column: span 3;"><label class="label">Emergency Contact</label><input class="input" id="m_emerg"></div>
                                        <div class="field" style="grid-column: span 3;"><label class="label">Emergency Phone</label><input class="input" id="m_emergphone"></div>
                                    </div>
                                </div>

                                <div>
                                    <div class="section-title">Female Candidate</div>
                                    <div class="grid" style="grid-template-columns: repeat(6, 1fr); gap: 8px 16px;">
                                        <div class="field" style="grid-column: span 3;"><label class="label">First Name</label><input class="input" id="f_first"></div>
                                        <div class="field" style="grid-column: span 2;"><label class="label">Preferred Name</label><input class="input" id="f_pref"></div>
                                        <div class="field" style="grid-column: span 1;"><label class="label">Age</label><input type="text" class="input" id="f_age"></div>
                                        <div class="field" style="grid-column: span 3;"><label class="label">Cell</label><input class="input" id="f_cell"></div>
                                        <div class="field" style="grid-column: span 3;"><label class="label">Email</label><input type="email" class="input" id="f_email"></div>
                                        <div class="field" style="grid-column: span 3;"><label class="label">Emergency Contact</label><input class="input" id="f_emerg"></div>
                                        <div class="field" style="grid-column: span 3;"><label class="label">Emergency Phone</label><input class="input" id="f_emergphone"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="section-title">Sponsor Information</div>
                            <div class="grid grid-3">
                                <div class="field"><label class="label">First Name</label><input class="input" id="s_first"></div>
                                <div class="field"><label class="label">Last Name</label><input class="input" id="s_last"></div>
                                <div class="field"><label class="label">Street Address</label><input class="input" id="s_address"></div>
                                <div class="field"><label class="label">City</label><input class="input" id="s_city"></div>
                                <div class="field"><label class="label">State</label><input class="input" id="s_state" maxlength="2"></div>
                                <div class="field"><label class="label">ZIP</label><input class="input" id="s_zip"></div>
                                <div class="field"><label class="label">Phone</label><input class="input" id="s_phone"></div>
                                <div class="field"><label class="label">Email</label><input type="email" class="input" id="s_email"></div>
                                <div class="field"><label class="label">Church</label><input class="input" id="s_church"></div>
                            </div>
                            <div class="grid" style="grid-template-columns: 2fr 1fr 2fr 1.5fr; align-items: end;">
                                <div class="field"><label class="label">Weekend Attended</label><input class="input" id="s_weekend"></div>
                                <div class="field"><label class="label">Wknd #</label><input class="input" id="s_weekendno"></div>
                                <div class="field"><label class="label">Community</label><input class="input" id="s_community"></div>
                                <div class="field">
                                    <label class="label">Christian?</label>
                                    <div class="toggle" id="c_ischristian">
                                        <div class="opt active" data-val="no">No</div>
                                        <div class="opt" data-val="yes">Yes</div>
                                    </div>
                                </div>
                            </div>

                            <div class="section-title">Payment Information</div>
                            <div class="grid grid-2">
                                <div class="card pad fee-card">
                                    <div class="label" style="font-size:1rem; font-weight: 800; margin-bottom: 10px;">Weekend Fee</div>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn" data-payment-btn="wk-cash" style="flex:1;">Cash</button>
                                        <button class="btn" data-payment-btn="wk-check" style="flex:1;">Check</button>
                                        <button class="btn" data-payment-btn="wk-scholarship" style="flex:1;">Scholarship</button>
                                    </div>
                                    <div id="scholarship-options" style="display: none; margin-top: 12px; background: var(--bg); padding: 12px; border-radius: 8px;">
                                        <div class="label">Scholarship Type</div>
                                        <div class="toggle">
                                            <div class="opt active" data-scholarship-type="full">Full</div>
                                            <div class="opt" data-scholarship-type="partial">Partial</div>
                                        </div>
                                        <div id="partial-amount-container" style="display: none; margin-top: 10px;">
                                            <label class="label">Amount Paid by Candidate</label>
                                            <input id="partial_amount" type="text" class="input" placeholder="0.00">
                                        </div>
                                    </div>
                                    <div id="weekendSummaryStatus" class="inline-status"></div>
                                </div>
                                <div class="card pad fee-card">
                                    <div class="label" style="font-size:1rem; font-weight: 800; margin-bottom: 10px;">Sponsor Fee</div>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn" data-payment-btn="sp-cash" style="flex:1;">Cash</button>
                                        <button class="btn" data-payment-btn="sp-check" style="flex:1;">Check</button>
                                    </div>
                                    <div id="sponsorSummaryStatus" class="inline-status"></div>
                                </div>
                            </div>
                            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 24px; border-top: 1px solid var(--border); padding-top: 24px;">
                                <button id="cra_clear" class="btn">Clear Form</button>
                                <div style="display: flex; justify-content: flex-end; align-items: center; gap: 16px;">
                                    <span id="craSaveStatus" style="font-weight: 700; opacity: 0; transition: opacity: 0.5s ease-in-out;"></span>
                                    <button id="cra_submit" class="btn btn-primary">Save Candidate</button>
                                </div>
                            </div>
                        </div>
                        <div id="cra-followup" class="cra-view" style="display:none">
                            <div class="card pad" style="margin-bottom:12px;">
                                <div style="max-width: 300px;">
                                     <label class="label">Filter by Gender</label>
                                     <div class="toggle" id="craFollowupFilter">
                                        <div class="opt active" data-filter="men">Men</div>
                                        <div class="opt" data-filter="women">Women</div>
                                     </div>
                                </div>
                            </div>
                            <div class="card pad">
                                <div class="section-title">Pending Follow-up Calls</div>
                                <p style="color: var(--muted); margin-top: -10px; margin-bottom: 20px;">
                                    This is your to-do list for candidates who need a follow-up call. Click on a candidate to record their information.
                                </p>
                                <div id="followup-list-container">
                                    <!-- List will be rendered here by JS -->
                                </div>
                            </div>
                        </div>
                        <div id="cra-apps" class="cra-view" style="display:none">
                             <div class="card pad" style="margin-bottom:12px;">
                                <div style="max-width: 300px; margin: 0 auto;">
                                     <label class="label" style="text-align:center;">Filter Applications</label>
                                     <div class="toggle" id="craAppsFilter">
                                        <div class="opt active" data-filter="men">Men</div>
                                        <div class="opt" data-filter="women">Women</div>
                                     </div>
                                </div>
                            </div>
                            <div class="card pad">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Candidate(s)</th>
                                            <th>Church</th>
                                            <th>City/State</th>
                                            <th>Sponsor</th>
                                            <th>Weekend Fee</th>
                                            <th>Sponsor Fee</th>
                                            <th>Status</th>
                                            <th style="width: 150px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="apps_tbody"></tbody>
                                </table>
                            </div>
                        </div>
                        <div id="cra-checkin" class="cra-view" style="display:none">
                            <div class="card pad" style="margin-bottom:12px;">
                                <div style="max-width: 300px; margin: 0 auto;">
                                     <label class="label" style="text-align:center;">Filter by Gender</label>
                                     <div class="toggle" id="craCheckinFilter">
                                        <div class="opt active" data-filter="men">Men</div>
                                        <div class="opt" data-filter="women">Women</div>
                                     </div>
                                </div>
                            </div>
                            <div class="card pad">
                                <div class="section-title">Live Check-In</div>
                                <p style="color: var(--muted); margin-top: -10px; margin-bottom: 20px;">
                                    Candidates, please find your name and verify that your information is correct. Click the "Approve" button to complete your check-in.
                                </p>
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Contact Information</th>
                                            <th>Church</th>
                                            <th>Emergency Contact</th>
                                            <th style="width: 150px; text-align: center;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="checkin_tbody">
                                        <!-- JS will render rows here -->
                                        <tr><td colspan="5" style="text-align:center;padding:20px;color:var(--muted);">This page is under construction.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div id="cra-reports" class="cra-view" style="display:none; flex-direction: column; gap: 16px;">
                            <div class="card pad">
                                <div class="section-title">Reports</div>
                                <div class="controls">
                                    <div>
                                        <div class="label">Select Report Group</div>
                                        <div class="toggle" id="craReportFilter">
                                            <div class="opt active" data-filter="men">Men</div>
                                            <div class="opt" data-filter="women">Women</div>
                                        </div>
                                    </div>
                                    <div style="display:flex;gap:10px;flex-wrap:wrap">
                                        <button class="btn btn-info" data-report="financial">View Financial Report</button>
                                        <button class="btn btn-info" data-report="attendees">View Attendee List</button>
                                        <button class="btn btn-info" data-report="payments">View Payment List</button>
                                        <button class="btn btn-info" data-report="checkin">Generate Check-In Report</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Financial Report Section -->
                            <div id="cra-financial-report" style="display:none; flex-direction: column; gap: 16px;">
                                <div class="grid grid-4">
                                    <div class="card pad">
                                        <div class="label">Total Expected</div>
                                        <div id="cra_totalExpected" style="font-size:28px;font-weight:900">$0.00</div>
                                    </div>
                                    <div class="card pad">
                                        <div class="label">Total Collected</div>
                                        <div id="cra_totalCollected" style="font-size:28px;font-weight:900">$0.00</div>
                                    </div>
                                    <div class="card pad">
                                        <div class="label">Balance Due</div>
                                        <div id="cra_balanceDue" style="font-size:28px;font-weight:900">$0.00</div>
                                    </div>
                                    <div class="card pad">
                                        <div class="label">Apps w/ Balance</div>
                                        <div id="cra_overdueItems" style="font-size:28px;font-weight:900">0</div>
                                    </div>
                                </div>
                                <div class="card pad">
                                    <div class="section-title">Financial Summary</div>
                                    <div class="grid grid-3">
                                        <div class="card pad">
                                            <div class="label">Weekend Fees</div>
                                            <div class="financial-line"><span>Expected:</span><span id="cra_weekendExpected">$0.00</span></div>
                                            <div class="financial-line"><span>Collected:</span><span id="cra_weekendCollected">$0.00</span></div>
                                            <div class="financial-line"><span>Balance:</span><span id="cra_weekendBalance">$0.00</span></div>
                                        </div>
                                        <div class="card pad">
                                            <div class="label">Sponsor Fees</div>
                                            <div class="financial-line"><span>Expected:</span><span id="cra_sponsorExpected">$0.00</span></div>
                                            <div class="financial-line"><span>Collected:</span><span id="cra_sponsorCollected">$0.00</span></div>
                                            <div class="financial-line"><span>Balance:</span><span id="cra_sponsorBalance">$0.00</span></div>
                                        </div>
                                        <div class="card pad">
                                            <div class="label">Payment Methods</div>
                                            <div class="financial-line"><span>Cash:</span><span id="cra_cashCollected" style="color: var(--accentA);">$0.00</span></div>
                                            <div class="financial-line"><span>Check:</span><span id="cra_checkCollected" style="color: var(--accentB);">$0.00</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="cra-report-output"></div>
                        </div>
                        <div id="cra-email" class="cra-view" style="display:none; flex-direction: column;">
                            <div class="card pad" style="margin-bottom: 24px;">
                                <div style="max-width: 300px; margin: 0 auto; margin-bottom: 20px;">
                                     <label class="label" style="text-align:center;">Filter Report Data by Gender</label>
                                     <div class="toggle" id="craEmailFilter">
                                        <div class="opt active" data-filter="men">Men</div>
                                        <div class="opt" data-filter="women">Women</div>
                                     </div>
                                </div>
                                <div class="section-title">Team Email Reports</div>
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Report</th>
                                            <th>Description</th>
                                            <th>Recipients</th>
                                            <th style="width: 250px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="emailReportsTbody">
                                        <!-- Rows will be rendered here by JS -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="card pad">
                                <div class="section-title">Email Settings</div>
                                <div class="grid grid-2">
                                    <div class="field"><label class="label">From Name</label><input id="emailFromName" class="input"></div>
                                    <div class="field"><label class="label">From Email</label><input id="emailFrom" class="input" type="email"></div>
                                    <div class="field"><label class="label">Reply-To</label><input id="emailReply" class="input" type="email"></div>
                                    <div class="field"><label class="label">BCC</label><input id="emailBcc" class="input" type="email"></div>
                                </div>
                                <div style="display:flex;gap:10px"><button id="saveEmailSettings" class="btn btn-primary">Save Settings</button><button id="resetEmailSettings" class="btn">Reset</button></div>
                            </div>
                        </div>
                    </div>

                </section>

                <section id="app-settings" class="app-panel" style="display:none">
                    <div class="card pad" style="margin-bottom:16px">
                        <div class="section-title">General Configuration</div>
                        <div class="grid grid-4">
                            <div class="field"><label class="label">Community Name</label><input id="communityName" class="input settings-input" placeholder="Placeholder Inc."></div>
                            <div class="field"><label class="label">Weekend Fee ($)</label><input id="weekendFee" class="input settings-input" type="number" min="0" placeholder="265.00"></div>
                            <div class="field"><label class="label">Team Fee ($)</label><input id="teamFee" class="input settings-input" type="number" min="0" placeholder="30.00"></div>
                            <div class="field"><label class="label">Sponsor Fee ($)</label><input id="sponsorFee" class="input settings-input" type="number" min="0" placeholder="50.00"></div>
                        </div>
                        <div style="display: flex; justify-content: flex-end; margin-top: 16px; border-top: 1px solid var(--border); padding-top: 16px;">
                            <button id="saveGeneralSettings" class="btn btn-primary">Save General Settings</button>
                        </div>
                    </div>
                    <div class="card pad" style="margin-top:16px">
                        <div class="section-title">Budget Configuration</div>
                        <p style="color: var(--muted); font-size: 0.9rem; margin-top: -10px; margin-bottom: 20px;">
                            Set the default budget amounts for each team role. These will be used in the MCI Budget screen.
                        </p>
                        <div class="grid grid-4" id="budgetSettingsContainer">
                             <div class="field"><label class="label">Rector ($)</label><input id="budgetRector" class="input settings-input" type="number" min="0" step="0.01" placeholder="0.00"></div>
                            <div class="field"><label class="label">Head ($)</label><input id="budgetHead" class="input settings-input" type="number" min="0" step="0.01" placeholder="0.00"></div>
                            <div class="field"><label class="label">Asst Head ($)</label><input id="budgetAsstHead" class="input settings-input" type="number" min="0" step="0.01" placeholder="0.00"></div>
                            <div class="field"><label class="label">Prayer ($)</label><input id="budgetPrayer" class="input settings-input" type="number" min="0" step="0.01" placeholder="0.00"></div>
                            <div class="field"><label class="label">Kitchen ($)</label><input id="budgetKitchen" class="input settings-input" type="number" min="0" step="0.01" placeholder="0.00"></div>
                            <div class="field"><label class="label">Dorm ($)</label><input id="budgetDorm" class="input settings-input" type="number" min="0" step="0.01" placeholder="0.00"></div>
                            <div class="field"><label class="label">Chapel ($)</label><input id="budgetChapel" class="input settings-input" type="number" min="0" step="0.01" placeholder="0.00"></div>
                            <div class="field"><label class="label">Table ($)</label><input id="budgetTable" class="input settings-input" type="number" min="0" step="0.01" placeholder="0.00"></div>
                            <div class="field"><label class="label">Worship ($)</label><input id="budgetWorship" class="input settings-input" type="number" min="0" step="0.01" placeholder="0.00"></div>
                            <div class="field"><label class="label">Palanca ($)</label><input id="budgetPalanca" class="input settings-input" type="number" min="0" step="0.01" placeholder="0.00"></div>
                            <div class="field"><label class="label">Storeroom ($)</label><input id="budgetStoreroom" class="input settings-input" type="number" min="0" step="0.01" placeholder="0.00"></div>
                        </div>
                        <div style="display: flex; justify-content: flex-end; margin-top: 16px; border-top: 1px solid var(--border); padding-top: 16px;">
                            <button id="saveBudgetSettingsBtn" class="btn btn-primary">Save Budget Settings</button>
                        </div>
                    </div>
                    <div class="card pad" style="margin-top:16px">
                        <div class="section-title">User Management</div>
                        <div id="user-management-container">
                             <div id="user-management-header">
                                <p style="color: var(--muted); font-size: 0.9rem; max-width: 75%; margin: 0;">
                                    Invite new users to your organization and manage their access permissions.
                                </p>
                                <button id="inviteUserBtn" class="btn btn-primary">Invite New User</button>
                            </div>
                            <div id="user-list-container">
                                <table id="user-list-table" class="table">
                                    <thead>
                                        <tr>
                                            <th>User Email</th>
                                            <th style="width: 120px;">Role</th>
                                            <th style="width: 200px; text-align: right;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="user-list-tbody">
                                        <!-- Example Row (will be replaced by JS) -->
                                        <tr>
                                            <td>admin.user@example.com</td>
                                            <td><span class="role-badge admin">Admin</span></td>
                                            <td class="actions-cell">
                                                <button class="btn btn-small">Manage</button>
                                                <button class="btn btn-small btn-danger">Delete</button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>standard.user@example.com</td>
                                            <td><span class="role-badge user">User</span></td>
                                            <td class="actions-cell">
                                                <button class="btn btn-small">Manage</button>
                                                <button class="btn btn-small btn-danger">Delete</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="card pad" style="margin-top:16px">
                        <div class="section-title">Secretariat Configuration</div>
                        <p style="color: var(--muted); font-size: 0.9rem; margin-top: -10px; margin-bottom: 20px;">
                           Define term lengths for each board position and manage the current roster assignments.
                        </p>
                        <div id="secretariat-config-container">
                            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                                <button id="manageRosterBtn" class="btn btn-info">Manage Board Roster</button>
                                <button id="saveTermLengthsBtn" class="btn btn-primary">Save Term Lengths</button>
                            </div>
                            <div id="secretariat-positions-grid">
                                <!-- Position items will be rendered here by JS -->
                            </div>
                        </div>
                    </div>
                    <div class="card pad" style="margin-top:16px">
                        <div class="section-title">Data Management</div>
                        <div class="grid grid-2" id="dataManagementContainer">
                            <div class="card pad data-management-card">
                                <h4>Meeting Check-In (MCI)</h4>
                                <p>Manage all stored check-in data including attendance, payments, and Palanca status.</p>
                                <div class="actions">
                                    <button class="btn btn-small" data-action="clear-mci-view">Clear Current View</button>
                                    <button class="btn btn-danger btn-small" data-action="delete-mci-db">Clear All Database Records</button>
                                </div>
                            </div>
                            <div class="card pad data-management-card">
                                <h4>Candidate Registration (CRA)</h4>
                                <p>Manage all stored candidate applications. This data is now stored in Supabase.</p>
                                <div class="actions">
                                    <button class="btn btn-small" data-action="clear-cra-form">Clear Current Form</button>
                                    <button class="btn btn-danger btn-small" data-action="delete-cra-db">Clear All Database Applications</button>
                                </div>
                            </div>
                            <div class="card pad data-management-card">
                                <h4>Team Viewer</h4>
                                <p>Functionality not yet implemented.</p>
                                <div class="actions">
                                    <button class="btn btn-small" disabled>Clear View</button>
                                    <button class="btn btn-danger btn-small" disabled>Clear Database</button>
                                </div>
                            </div>
                            <div class="card pad data-management-card">
                                <h4>Team Book</h4>
                                <p>Functionality not yet implemented.</p>
                                <div class="actions">
                                    <button class="btn btn-small" disabled>Clear View</button>
                                    <button class="btn btn-danger btn-small" disabled>Clear Database</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ====================================================== -->
                    <!-- =========== START: SUBSCRIPTION PANEL UI ============= -->
                    <!-- ====================================================== -->
                    <div class="card pad" style="margin-top:16px">
                        <div class="section-title">Subscription & Billing</div>
                        <div class="grid grid-2" style="gap: 24px; align-items: start;">
                            <!-- Left side: Status and plan details -->
                            <div>
                                <div class="label" style="font-size: 1rem; margin-bottom: 12px;">Current Plan</div>
                                <div id="subscriptionStatusContainer" style="margin-bottom: 16px;">
                                    <!-- Status badge will be rendered here by JS -->
                                </div>
                                <div style="background: var(--bg); padding: 16px; border-radius: 12px; border: 1px solid var(--border);">
                                    <div style="display: flex; justify-content: space-between; align-items: baseline;">
                                        <h3 style="font-size: 1.2rem; font-weight: 700;">Team Tools Pro</h3>
                                        <div>
                                            <span style="font-size: 2rem; font-weight: 800; color: var(--accentA);">$35</span>
                                            <span style="font-size: 0.9rem; color: var(--muted); font-weight: 600;">/mo</span>
                                        </div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: -4px; margin-bottom: 16px;">
                                        <p style="font-size: 0.85rem; color: var(--muted);">Billed monthly</p>
                                        <span style="font-weight: 700; color: var(--accentD);">Inactive</span>
                                    </div>
                                    
                                    <ul style="list-style: none; padding-left: 0; display: flex; flex-direction: column; gap: 8px; font-size: 0.9rem; border-top: 1px solid var(--border); padding-top: 16px;">
                                        <li style="display: flex; align-items: center; gap: 8px;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="color: var(--accentA); flex-shrink: 0;"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg> <span style="color: var(--ink);">Directory & Team Management</span></li>
                                        <li style="display: flex; align-items: center; gap: 8px;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="color: var(--accentA); flex-shrink: 0;"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg> <span style="color: var(--ink);">Candidate Registration</span></li>
                                        <li style="display: flex; align-items: center; gap: 8px;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="color: var(--accentA); flex-shrink: 0;"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg> <span style="color: var(--ink);">Meeting Check-In & Budgeting</span></li>
                                        <li style="display: flex; align-items: center; gap: 8px;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="color: var(--accentA); flex-shrink: 0;"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg> <span style="color: var(--ink);">Secretariat Dashboard</span></li>
                                        <li style="display: flex; align-items: center; gap: 8px;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="color: var(--accentA); flex-shrink: 0;"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg> <span style="color: var(--ink);">Secure Cloud Data Storage</span></li>
                                    </ul>
                                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                                        <button id="subscribeBtn" class="btn btn-primary" style="width: 100%;" onclick="redirectToCheckout()">Subscribe Now</button>
                                        <p style="font-size: 0.8rem; text-align: center; color: var(--muted); margin-top: 8px;">
                                            You will be redirected to our secure payment partner, Square.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <!-- Right side: Billing history -->
                            <div>
                                <div class="label" style="font-size: 1rem; margin-bottom: 12px;">Billing History</div>
                                <div style="text-align: center; padding: 40px 20px; color: var(--muted); border: 2px dashed var(--border); border-radius: 12px;">
                                    Your billing history will appear here once you subscribe.
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ====================================================== -->
                    <!-- ============ END: SUBSCRIPTION PANEL UI ============== -->
                    <!-- ====================================================== -->

                </section>
                
                <!-- ====================================================== -->
                <!-- ============== START: SUPER ADMIN PANEL ============== -->
                <!-- ====================================================== -->
                <section id="super-admin-app" class="app-panel" style="display:none;">
                    <div class="card pad">
                        <div class="section-title">Organization Management</div>
                        <p style="color: var(--muted); margin-top: -10px; margin-bottom: 20px;">
                            A list of all customer organizations currently using the Application Hub.
                        </p>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Organization Name</th>
                                        <th style="width: 150px;">Billing Status</th>
                                        <th style="width: 120px; text-align: right;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="organizationsTbody">
                                    <!-- Organization data will be rendered here by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                <!-- ====================================================== -->
                <!-- =============== END: SUPER ADMIN PANEL =============== -->
                <!-- ====================================================== -->

            </div>
        </main>
    </div>

    <!-- ====================================================== -->
    <!-- ========= START: SUPER ADMIN MANAGEMENT MODAL ======== -->
    <!-- ====================================================== -->
    <div id="orgManagementModal" class="modal">
        <div class="box">
            <div class="head" id="orgModalTitle">Manage Organization</div>
            <div class="body">
                <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 20px;">
                    Update the billing status for this organization. Changes are applied immediately.
                </p>
                <div class="grid grid-3">
                    <button class="btn btn-primary" data-action="set-status" data-status="active">Set to Active</button>
                    <button class="btn btn-info" data-action="set-status" data-status="waived">Set to Waived</button>
                    <button class="btn btn-warning" data-action="set-status" data-status="trial">Start 30-Day Trial</button>
                </div>
                <div id="org-status-feedback" style="text-align: center; margin-top: 20px; font-weight: 700; opacity: 0; transition: opacity 0.3s;"></div>
            </div>
            <div class="foot">
                <button id="orgModalCloseBtn" class="btn">Close</button>
            </div>
        </div>
    </div>
    <!-- ====================================================== -->
    <!-- ========== END: SUPER ADMIN MANAGEMENT MODAL ========= -->
    <!-- ====================================================== -->

    <div id="importModal" class="modal">
        <div class="box small">
            <div class="head">Import Team Roster</div>
            <div class="body">
                <div class="field" style="margin-bottom: 20px;">
                    <label class="label" style="text-align:center;">Load Latest Weekend</label>
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <button id="mciLoadMenBtn" class="btn btn-primary" style="flex: 1;" onclick="MCI.loadLatestTeam('men')">Men's Team</button>
                        <button id="mciLoadWomenBtn" class="btn btn-primary" style="flex: 1;" onclick="MCI.loadLatestTeam('women')">Women's Team</button>
                    </div>
                </div>
                <hr style="border:none; border-top: 1px solid var(--border); margin: 25px 0;">
                <label class="label" style="text-align:center;">Or type manually</label>
                <input id="teamIdInput" class="input" placeholder="Enter Weekend Identifier">
            </div>
            <div class="foot">
                <button class="btn" onclick="MCI.closeImport()">Cancel</button>
                <button class="btn btn-primary" onclick="MCI.importTeamFromModal()">Load Team</button>
            </div>
        </div>
    </div>

    <div id="manageRecipientsModal" class="modal">
        <div class="box">
            <div id="manageRecipientsModalTitle" class="head">Manage Recipients</div>
            <div class="body">
                <div class="field">
                    <label class="label">Current Recipients</label>
                    <div id="recipientListContainer" style="min-height: 50px; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
                        <!-- Recipient badges will be rendered here -->
                    </div>
                </div>
                <hr style="border:none; border-top: 1px solid var(--border); margin: 25px 0;">
                <div class="grid grid-2" style="align-items: start;">
                    <div class="field">
                        <label class="label">Add New Recipient</label>
                        <div style="display:flex;gap:8px;margin-top:6px">
                            <input id="recipientNewInput" class="input" type="email" placeholder="add email">
                            <button id="addRecipientBtn" class="btn btn-primary">Add</button>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label">Quick Add</label>
                        <div id="quickAddContainer" style="margin-top: 6px;">
                            <!-- Dynamic button will be added here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="foot">
                <button class="btn" onclick="CRA.closeManageRecipientsModal()">Done</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="box small">
            <div class="head" id="confirmModalTitle">
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: var(--accentC);">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                </svg>
                <span>Confirmation</span>
            </div>
            <div class="body" id="confirmModalBody">
                Are you sure you want to proceed with this action?
            </div>
            <div class="foot">
                <button id="confirmModalCancel" class="btn">Cancel</button>
                <button id="confirmModalConfirm" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="box" style="width: min(840px, 94vw);">
            <div class="head" id="reportModalTitle">Report</div>
            <div class="body" id="reportModalBody">
                <!-- Report preview content will be injected here -->
            </div>
            <div class="foot" style="flex-direction: column; align-items: stretch; gap: 16px;">
                <div id="report-email-tools">
                    <div class="grid grid-2" style="gap: 12px 20px;">
                        <div class="field" style="margin:0">
                            <label class="label">To:</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <input type="text" id="reportTo" class="input" readonly>
                                <button class="btn btn-primary" data-copy-target="reportTo">Copy</button>
                            </div>
                        </div>
                        <div class="field" style="margin:0">
                            <label class="label">Subject:</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <input id="reportSubject" class="input" readonly>
                                <button class="btn btn-primary" data-copy-target="reportSubject">Copy</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border); padding-top: 16px; margin-top: 0;">
                     <div id="reportModalStatusBar" style="font-weight: 700; color: var(--accentA); opacity: 0; transition: opacity 0.3s;">Copied!</div>
                     <div style="display: flex; gap: 8px;">
                        <button id="copyReportBodyBtn" class="btn btn-info">Copy Report Body</button>
                        <button id="reportModalClose" class="btn">Done</button>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <div id="followupModal" class="modal">
        <div class="box">
            <div class="head">Follow-up Call for <span id="followup-candidate-name" style="color: var(--accentB);"></span></div>
            <div class="body">
                <div class="grid grid-3">
                    <div class="field">
                        <label class="label">Sponsor Name</label>
                        <div id="followup-sponsor-name" style="font-weight: 600;">--</div>
                    </div>
                    <div class="field">
                        <label class="label">Sponsor Phone</label>
                        <div id="followup-sponsor-phone" style="font-weight: 600;">--</div>
                    </div>
                    <div class="field">
                        <label class="label">Candidate Phone</label>
                        <div id="followup-candidate-phone" style="font-weight: 600;">--</div>
                    </div>
                </div>
                <hr style="border: none; border-top: 1px solid var(--border); margin: 20px 0;">
                
                <div class="grid grid-2">
                     <div class="field" style="grid-column: span 2;">
                        <label class="label">Are they attending the upcoming weekend?</label>
                        <div class="toggle" id="followup_attendance">
                            <div class="opt active" data-val="no">No</div>
                            <div class="opt" data-val="yes">Yes</div>
                        </div>
                    </div>
                    <div class="field" style="margin-bottom: 0;">
                        <label class="label">Smoker?</label>
                        <div class="toggle" id="followup_smoker">
                            <div class="opt active" data-val="no">No</div>
                            <div class="opt" data-val="yes">Yes</div>
                        </div>
                    </div>
                     <div class="field" style="margin-bottom: 0;">
                        <label class="label">Special Diet?</label>
                        <div class="toggle" id="followup_diet">
                            <div class="opt active" data-val="no">No</div>
                            <div class="opt" data-val="yes">Yes</div>
                        </div>
                    </div>
                </div>
                <div class="field" id="followup_diet_details_container" style="display: none; margin-top: 16px;">
                    <label class="label">Dietary Details</label>
                    <textarea id="followup_diet_details" class="textarea" placeholder="e.g., Gluten-free, lactose intolerant, etc."></textarea>
                </div>
                <hr style="border: none; border-top: 1px solid var(--border); margin: 20px 0;">
                <div class="grid grid-2">
                    <div class="field" style="margin-bottom: 0;">
                        <label class="label">Sponsor Letter Sent?</label>
                        <div class="toggle" id="followup_sponsor_letter">
                            <div class="opt active" data-val="no">No</div>
                            <div class="opt" data-val="yes">Yes</div>
                        </div>
                    </div>
                    <div class="field" style="margin-bottom: 0;">
                        <label class="label">Candidate Letter Sent?</label>
                        <div class="toggle" id="followup_candidate_letter">
                            <div class="opt active" data-val="no">No</div>
                            <div class="opt" data-val="yes">Yes</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="foot">
                <button id="followupModalCancel" class="btn">Cancel</button>
                <button id="followupModalSave" class="btn btn-primary">Save & Complete</button>
            </div>
        </div>
    </div>

    <div id="paymentAmountModal" class="modal">
        <div class="box small">
            <div class="head" id="paymentAmountModalTitle">Enter Payment</div>
            <div class="body">
                <div class="field" style="margin-bottom: 12px;">
                    <label class="label">Enter the amount received</label>
                    <input id="paymentAmountInput" class="input" type="number" step="0.01" placeholder="0.00">
                </div>
                <button id="acceptFullPaymentBtn" class="btn" style="width: 100%;">Accept Full Fee</button>
            </div>
            <div class="foot">
                <button class="btn" onclick="MCI.closePaymentAmountModal()">Cancel</button>
                <button class="btn btn-primary" onclick="MCI.applyPaymentAmount()">Apply Payment</button>
            </div>
        </div>
    </div>
    
    <div id="noAttendanceModal" class="modal">
        <div class="box small">
            <div class="head">Members with No Recorded Attendance</div>
            <div class="body" id="noAttendanceList">
                <!-- List will be rendered here -->
            </div>
            <div class="foot">
                <button class="btn" onclick="MCI.closeNoAttendanceModal()">Close</button>
                <button id="copyEmailsBtn" class="btn btn-info">Copy Emails</button>
            </div>
        </div>
    </div>

    <!-- ====================================================== -->
    <!-- ============ START: USER MANAGEMENT MODAL ============ -->
    <!-- ====================================================== -->
    <div id="userManagementModal" class="modal">
        <div class="box">
            <div class="head" id="userModalTitle">Add User From Directory</div>
            <div class="body">
                <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 20px;">
                    Select a person from your community's directory to grant them access to this organization's hub. Their email must already be associated with a login account.
                </p>
                <div class="grid grid-2">
                    <div class="field">
                        <label class="label">Select Person</label>
                        <select id="userSelectDropdown" class="select">
                            <option value="">Loading directory...</option>
                        </select>
                    </div>
                    <div class="field">
                        <label class="label">User Email</label>
                        <input id="userEmailDisplay" class="input" type="email" placeholder="Email will appear here" readonly>
                    </div>
                </div>
                <div class="grid grid-2" style="margin-top: 16px;">
                     <div class="field">
                        <label class="label">User Role</label>
                        <select id="userRoleSelect" class="select">
                            <option value="User" selected>User</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div class="section-title" style="margin-top: 16px;">Access Permissions</div>
                <p style="color: var(--muted); font-size: 0.9rem; margin-top: -10px; margin-bottom: 20px;">
                    Select which application modules this user can access.
                </p>
                <div id="permissions-grid">
                    <div class="permission-item">
                        <label class="label" for="perm-team-viewer">Team Viewer</label>
                        <label class="switch"><input type="checkbox" id="perm-team-viewer-app" checked><span class="slider"></span></label>
                    </div>
                    <div class="permission-item">
                        <label class="label" for="perm-team-book">Team Book</label>
                        <label class="switch"><input type="checkbox" id="perm-team-book" checked><span class="slider"></span></label>
                    </div>
                    <div class="permission-item">
                        <label class="label" for="perm-team-meetings">Team Meetings</label>
                        <label class="switch"><input type="checkbox" id="perm-meeting-check-in-app" checked><span class="slider"></span></label>
                    </div>
                    <div class="permission-item">
                        <label class="label" for="perm-candidate-reg">Candidate Registration</label>
                        <label class="switch"><input type="checkbox" id="perm-candidate-registration" checked><span class="slider"></span></label>
                    </div>
                    <div class="permission-item">
                        <label class="label" for="perm-secretariat">Secretariat</label>
                        <label class="switch"><input type="checkbox" id="perm-secretariat-app" checked><span class="slider"></span></label>
                    </div>
                </div>
            </div>
            <div class="foot">
                <button id="userModalCancel" class="btn">Cancel</button>
                <button id="userModalSave" class="btn btn-primary">Add User</button>
            </div>
        </div>
    </div>
    <!-- ====================================================== -->
    <!-- ============= END: USER MANAGEMENT MODAL ============= -->
    <!-- ====================================================== -->

    <!-- ====================================================== -->
    <!-- ========== START: ROSTER MANAGEMENT MODAL ========== -->
    <!-- ====================================================== -->
    <div id="rosterManagementModal" class="modal">
        <div class="box">
            <div class="head" style="display: flex; justify-content: space-between; align-items: center;">
                <span>Manage Board Roster</span>
                <button id="refreshRosterListBtn" class="btn btn-small">Refresh List</button>
            </div>
            <div class="body modal-body-grid" id="rosterModalBody">
                <!-- Roster assignment items will be rendered here by JS -->
            </div>
            <div class="foot">
                <button id="rosterModalClose" class="btn">Done</button>
            </div>
        </div>
    </div>
    <!-- ====================================================== -->
    <!-- =========== END: ROSTER MANAGEMENT MODAL =========== -->
    <!-- ====================================================== -->

    <!-- ====================================================== -->
    <!-- ======== START: SECRETARIAT ASSIGNMENT MODAL ========= -->
    <!-- ====================================================== -->
    <div id="secretariatAssignmentModal" class="modal">
        <div class="box">
            <div class="status-bar" id="assignmentStatusBar"></div>
            <div class="head" id="assignmentModalTitle">Assign Position</div>
            <div class="body">
                <div id="assignment-inputs-container">
                    <!-- Inputs will be dynamically generated here -->
                </div>
                <div class="field" style="margin-top: 16px; background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 12px;">
                    <input type="checkbox" id="assignmentIsInterim" style="width: 18px; height: 18px; flex-shrink: 0; accent-color: var(--accentC);">
                    <label for="assignmentIsInterim" class="label" style="margin: 0; font-weight: 600; color: var(--ink);">This is an Interim assignment</label>
                </div>
                <div class="field" style="margin-top: 16px;">
                    <label class="label">Term Start Date</label>
                    <div id="assignmentStartDate" class="custom-date-input" tabindex="0" data-value="">
                        <span id="assignmentStartDateText" class="placeholder">Select Month & Year...</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="color: var(--muted);">
                            <path d="M4 .5a.5.5 0 0 0-1 0V1H2a2 2 0 0 0-2 2v1h16V3a2 2 0 0 0-2-2h-1V.5a.5.5 0 0 0-1 0V1H4V.5zM16 14V5H0v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2zM8.5 7.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h1z"/>
                        </svg>
                    </div>
                </div>
                <div id="intern-date-picker-container" class="field" style="margin-top: 16px; display: none;">
                    <label class="label" style="font-style: italic;">Intern Start Date (Optional)</label>
                    <div id="assignmentInternStartDate" class="custom-date-input" tabindex="0" data-value="">
                        <span id="assignmentInternStartDateText" class="placeholder">Select Month & Year...</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="color: var(--muted);">
                            <path d="M4 .5a.5.5 0 0 0-1 0V1H2a2 2 0 0 0-2 2v1h16V3a2 2 0 0 0-2-2h-1V.5a.5.5 0 0 0-1 0V1H4V.5zM16 14V5H0v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2zM8.5 7.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5.5h1z"/>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="foot">
                <button id="assignmentModalCancel" class="btn">Cancel</button>
                <button id="assignmentModalSave" class="btn btn-primary">Save Assignment</button>
            </div>
        </div>
    </div>
    <!-- ====================================================== -->
    <!-- ========== END: SECRETARIAT ASSIGNMENT MODAL ========= -->
    <!-- ====================================================== -->

    <!-- ====================================================== -->
    <!-- =========== START: MONTH/YEAR PICKER POPOVER ========= -->
    <!-- ====================================================== -->
    <div id="monthYearPicker" class="picker-popover">
        <div class="picker-header">
            <button id="pickerPrevYear">‹</button>
            <span id="pickerCurrentYear">2025</span>
            <button id="pickerNextYear">›</button>
        </div>
        <div id="pickerMonthGrid" class="picker-grid">
            <!-- Month buttons will be generated by JS -->
        </div>
    </div>
    <!-- ====================================================== -->
    <!-- ============ END: MONTH/YEAR PICKER POPOVER ========== -->
    <!-- ====================================================== -->


    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        let CONFIG = {
            COMMUNITY_NAME: 'Placeholder Inc.',
            WEEKEND_FEE: 265,
            TEAM_FEE: 30,
            MEETING_COUNT: 6,
            SPONSOR_FEE: 50
        };

        const DEFAULT_SETTINGS = {
            community_name: 'Placeholder Inc.',
            weekend_fee: 265,
            team_fee: 30,
            sponsor_fee: 50
        };

        const budgetKeys = [
            'Rector', 'Head', 'AsstHead', 'Prayer', 'Kitchen', 'Dorm',
            'Chapel', 'Table', 'Worship', 'Palanca', 'Storeroom'
        ];

        async function loadAppSettings() {
            try {
                const {
                    data,
                    error
                } = await supabaseClient
                    .from('app_settings')
                    .select('*')
                    .eq('id', 1)
                    .single();

                let settings = DEFAULT_SETTINGS;
                if (error) {
                    console.warn('Error fetching app settings:', error.message);
                } else if (data) {
                    settings = data;
                }

                CONFIG.COMMUNITY_NAME = settings.community_name || 'Placeholder Inc.';
                CONFIG.WEEKEND_FEE = settings.weekend_fee || 265;
                CONFIG.TEAM_FEE = settings.team_fee || 30;
                CONFIG.SPONSOR_FEE = settings.sponsor_fee || 50;

                // Update UI elements
                document.getElementById('sidebarCompanyName').textContent = CONFIG.COMMUNITY_NAME;
                document.getElementById('communityName').value = settings.community_name || '';
                document.getElementById('weekendFee').value = settings.weekend_fee || '';
                document.getElementById('teamFee').value = settings.team_fee || '';
                document.getElementById('sponsorFee').value = settings.sponsor_fee || '';

            } catch (e) {
                console.error("Critical error loading settings:", e);
                // In a real app, you might want a more user-friendly error display
            }
        }

        async function loadBudgetSettings() {
            const { data, error } = await supabaseClient
                .from('app_budgets')
                .select('*')
                .eq('id', 1)
                .single();

            if (error && error.code !== 'PGRST116') { // Ignore 'not found' error, it just means no settings are saved yet
                console.error('Error loading budget settings:', error.message);
                return;
            }

            if (data) {
                budgetKeys.forEach(key => {
                    const input = document.getElementById(`budget${key}`);
                    const dbKey = `budget_${key.toLowerCase()}`;
                    if (input) {
                        input.value = data[dbKey] || '';
                    }
                });
            }
        }

        async function resetAppSettings() {
            if (!confirm('Are you sure you want to reset all settings to their default values?')) {
                return;
            }

            const defaultWithId = {
                id: 1,
                ...DEFAULT_SETTINGS
            };

            const {
                error
            } = await supabaseClient
                .from('app_settings')
                .upsert(defaultWithId);

            if (error) {
                console.error('Error resetting settings:', error.message);
                alert('Failed to reset settings: ' + error.message);
            } else {
                alert('Reset settings to default.');
                await loadAppSettings();
            }
        }

        const sbURL = 'https://jtubjrksomudwjdhgmss.supabase.co';
        const sbKEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0dWJqcmtzb211ZHdqZGhnbXNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNTE2MjQsImV4cCI6MjA3MDYyNzYyNH0.JSKNAJacNaf3jZqDvm1Q5lWMlzjfQ4kjO9mmTS3w1vk';
        
        // --- GLOBAL STATE FOR CURRENT USER'S ORGANIZATION ---
        let currentUserOrgId = null;

        // --- FIX: Session initialization flag to prevent startup race condition ---
        let isSessionInitialized = false;

        // --- ROBUST FIX for SecurityError in constrained environments ---
                // This is a more complete mock of the browser's Storage API.
        const noOpStorage = {
            getItem: (key) => null,
            setItem: (key, value) => {},
            removeItem: (key) => {},
            clear: () => {},
            get length() { return 0; },
            key: (index) => null
        };

        function showMainStatus(message, isError = false) {
            const statusBar = document.querySelector('#mainStatusBar');
            if (!statusBar) return;

            statusBar.textContent = message;
            statusBar.classList.toggle('error', isError);
            statusBar.classList.add('visible');

            setTimeout(() => {
                statusBar.classList.remove('visible', 'error');
            }, 2500);
        }

        async function initializeUserSession(user) {
            console.log("Attempting to initialize user session for:", user.email);
            if (!user) {
                // If for some reason a null user is passed, ensure logout state
                updateUI(null);
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('memberships')
                    .select('org_id')
                    .eq('user_id', user.id)
                    .single();

                if (error) {
                    throw new Error(`Could not fetch organization details: ${error.message}`);
                }

                if (data && data.org_id) {
                    currentUserOrgId = data.org_id;
                    console.log('User session successfully initialized with Org ID:', currentUserOrgId);

                    // --- START: Super Admin Check ---
                    const { data: profileData, error: profileError } = await supabaseClient
                        .from('profiles')
                        .select('full_name')
                        .eq('user_id', user.id)
                        .single();

                    if (profileError) {
                        console.warn("Could not check for Super Admin status:", profileError.message);
                    } else if (profileData && profileData.full_name === 'Super Admin') {
                        console.log("Super Admin detected. Enabling admin panel.");
                        document.getElementById('superAdminLink').style.display = 'block';
                        SUPER_ADMIN.init(); // Initialize the Super Admin module
                    }
                    // --- END: Super Admin Check ---

                    // Now that we have the org ID, initialize all app modules
                    await loadAppSettings();
                    await loadBudgetSettings();
                    await loadSubscriptionStatus();
                    
                    // Initialize all modules
                    CRA.init();
                    MCI.init();
                    TV.init();
                    SECRETARIAT.init();
                    UM.init();

                } else {
                    // This case handles a valid user who isn't part of any organization.
                    // This might happen during signup or if their membership is removed.
                    throw new Error('User does not belong to an organization.');
                }
            } catch (error) {
                console.error('Failed to initialize user session:', error);
                showMainStatus(error.message, true);
                // If initialization fails, the user cannot use the app. Log them out.
                await supabaseClient.auth.signOut();
            }
        }

        async function loadSubscriptionStatus() {
            const container = document.getElementById('subscriptionStatusContainer');
            if (!container) return;
            container.innerHTML = `<span style="color: var(--muted);">Loading status...</span>`;

            try {
                const { data, error } = await supabaseClient
                    .from('organizations')
                    .select('billing_status, trial_expires_at')
                    .eq('id', currentUserOrgId)
                    .single();

                if (error) throw error;
                
                const status = data.billing_status || 'trial';
                const trialExpires = data.trial_expires_at ? new Date(data.trial_expires_at) : null;
                const now = new Date();
                
                let statusText = 'Unknown';
                let statusClass = '';
                let subText = '';

                if (status === 'active') {
                    statusText = 'Active';
                    statusClass = 'active';
                } else if (status === 'waived') {
                    statusText = 'Waived';
                    statusClass = 'waived';
                    subText = 'Your subscription is provided free of charge.';
                } else { // Trial
                    if (trialExpires && trialExpires > now) {
                        statusText = 'In Trial';
                        statusClass = 'trial';
                        const daysLeft = Math.ceil((trialExpires - now) / (1000 * 60 * 60 * 24));
                        subText = `Your trial expires in ${daysLeft} day(s).`;
                    } else {
                        statusText = 'Trial Expired';
                        statusClass = 'trial'; // Still use trial color, but looks like warning
                        subText = 'Your trial has expired. Please subscribe to continue.';
                    }
                }
                
                container.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 4px;">
                        <span class="label" style="margin: 0;">Status:</span>
                        <span class="status-badge-admin ${statusClass}">${statusText}</span>
                    </div>
                    <p style="font-size: 0.85rem; color: var(--muted);">${subText}</p>
                `;

                // Update the subscribe button based on status
                const subscribeBtn = document.getElementById('subscribeBtn');
                if (subscribeBtn) {
                    if (status === 'active' || status === 'waived') {
                        subscribeBtn.textContent = 'Manage Subscription';
                    } else {
                        subscribeBtn.textContent = 'Subscribe Now';
                    }
                }

            } catch(e) {
                console.error("Error loading subscription status:", e);
                container.innerHTML = `<span style="color: var(--accentD);">Could not load subscription status.</span>`;
            }
        }

        async function resetAppSettings() {
            if (!confirm('Are you sure you want to reset all settings to their default values?')) {
                return;
            }

            const defaultWithId = {
                id: 1,
                ...DEFAULT_SETTINGS
            };

            const {
                error
            } = await supabaseClient
                .from('app_settings')
                .upsert(defaultWithId);

            if (error) {
                console.error('Error resetting settings:', error.message);
                alert('Failed to reset settings: ' + error.message);
            } else {
                alert('Reset settings to default.');
                await loadAppSettings();
            }
        }

        const supabaseClient = supabase.createClient(sbURL, sbKEY, {
            auth: {
                storage: (() => {
                    try {
                        // Test if localStorage is accessible
                        window.localStorage.setItem('_supabase_test', '1');
                        window.localStorage.removeItem('_supabase_test');
                        return window.localStorage;
                    } catch (e) {
                        // If not, return our no-op mock storage
                        console.warn("localStorage is not available. Supabase session will not be persisted.");
                        return noOpStorage;
                    }
                })(),
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true
            },
        });

        // --- NEW: SUPER ADMIN MODULE ---
        const SUPER_ADMIN = (function() {
            const $ = sel => document.querySelector(sel);
            let currentManagingOrgId = null;

            async function loadOrganizations() {
                const tbody = $('#organizationsTbody');
                if (!tbody) return;

                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Loading organizations...</td></tr>';

                try {
                    // Super Admins can bypass RLS, so no .eq('org_id', ...) is needed here.
                    const { data, error } = await supabaseClient
                        .from('organizations')
                        .select('id, name, created_at, billing_status, trial_expires_at')
                        .order('created_at', { ascending: false });

                    if (error) throw error;

                    renderOrganizationsTable(data);
                } catch (error) {
                    console.error('Error loading organizations:', error);
                    tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; color: var(--accentD);">Failed to load organizations: ${error.message}</td></tr>`;
                }
            }

            function renderOrganizationsTable(orgs) {
                const tbody = $('#organizationsTbody');
                tbody.innerHTML = '';

                if (!orgs || orgs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No organizations found.</td></tr>';
                    return;
                }

                const now = new Date();

                orgs.forEach(org => {
                    const tr = document.createElement('tr');
                    
                    let status = org.billing_status || 'trial'; // Default to trial if not set
                    let statusText = status;

                    if (status === 'trial') {
                        const expires = org.trial_expires_at ? new Date(org.trial_expires_at) : null;
                        if (expires && expires < now) {
                            statusText = 'Trial Expired';
                        } else {
                            statusText = 'In Trial';
                        }
                    }

                    tr.innerHTML = `
                        <td>${org.name}</td>
                        <td><span class="status-badge-admin ${status}">${statusText}</span></td>
                        <td style="text-align: right;">
                            <button class="btn btn-small" data-action="manage" data-org-id="${org.id}" data-org-name="${org.name}">Manage</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            function openOrgManagementModal(orgId, orgName) {
                currentManagingOrgId = orgId;
                $('#orgModalTitle').textContent = `Manage: ${orgName}`;
                $('#org-status-feedback').style.opacity = '0'; // Hide feedback text
                $('#orgManagementModal').style.display = 'block';
            }

            function closeOrgManagementModal() {
                $('#orgManagementModal').style.display = 'none';
                currentManagingOrgId = null;
            }

            async function handleStatusChange(newStatus) {
                if (!currentManagingOrgId) return;

                const feedbackEl = $('#org-status-feedback');
                feedbackEl.style.opacity = '1';
                feedbackEl.style.color = 'var(--muted)';
                feedbackEl.textContent = 'Updating...';

                let updatePayload = { billing_status: newStatus };

                if (newStatus === 'trial') {
                    const expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + 30);
                    updatePayload.trial_expires_at = expiryDate.toISOString();
                } else {
                    updatePayload.trial_expires_at = null; // Clear expiry if not in trial
                }

                const { error } = await supabaseClient
                    .from('organizations')
                    .update(updatePayload)
                    .eq('id', currentManagingOrgId);

                if (error) {
                    feedbackEl.style.color = 'var(--accentD)';
                    feedbackEl.textContent = `Error: ${error.message}`;
                } else {
                    feedbackEl.style.color = 'var(--accentA)';
                    feedbackEl.textContent = 'Status Updated!';
                    loadOrganizations(); // Refresh the main list
                }
            }

            function init() {
                // Initial load when Super Admin is verified.
                loadOrganizations();

                // Delegated event listener for the table
                $('#organizationsTbody').addEventListener('click', e => {
                    const button = e.target.closest('button[data-action="manage"]');
                    if (button) {
                        openOrgManagementModal(button.dataset.orgId, button.dataset.orgName);
                    }
                });

                // Listeners for the management modal
                $('#orgManagementModal').addEventListener('click', e => {
                    const button = e.target.closest('button[data-action="set-status"]');
                    if (button) {
                        handleStatusChange(button.dataset.status);
                    }
                });
                $('#orgModalCloseBtn').addEventListener('click', closeOrgManagementModal);
            }

            return {
                init
            };
        })();

        const MCI = (function() {
            const $ = sel => document.querySelector(sel);
            const $$ = sel => document.querySelectorAll(sel);
            let memberDetails = {};
            let checkinData = {};
            let selectedMemberId = null;
            let currentTeamId = null;
            let currentGender = 'men';
            const feeExemptRoles = ['Rector', 'Head Spiritual Director', 'Spiritual Director'];
            let membersWithNoAttendance = [];
            let paymentAmountTarget = null;
            let paymentAmountMethod = null;
            let partialTarget = null;
            let budgetSettings = {};
            let disbursementData = [];
            
            const fmt = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n || 0);
            
            function showView(view) {
                // Hide all major MCI components first
                $('#mciInitialPrompt').style.display = 'none';
                $('#mciMain').style.display = 'none';
                $('#reportsScreen').style.display = 'none';
                $('#budgetScreen').style.display = 'none';

                // Show the requested one
                switch (view) {
                    case 'show_checkin':
                        $('#mciControls').style.display = 'flex'; // Show gender toggle
                        if (currentTeamId) {
                            $('#mciMain').style.display = 'grid';
                        } else {
                            $('#mciInitialPrompt').style.display = 'block';
                        }
                        break;
                    case 'show_reports':
                        $('#mciControls').style.display = 'flex';
                        showCurrentReportsView(); // This function already handles showing the reports screen
                        break;
                    case 'show_budget':
                        $('#mciControls').style.display = 'flex';
                        $('#budgetScreen').style.display = 'flex';
                        loadAndRenderBudgetView();
                        break;
                }
            }
            
            function init() {
                const parentNav = $('#mci-nav-parent');
                if (parentNav) {
                    parentNav.addEventListener('click', e => {
                        e.preventDefault();
                        const actionTarget = e.target.closest('[data-mci-action]');
                        if (!actionTarget) return;
            
                        const action = actionTarget.dataset.mciAction;
            
                        // Handle submenu active states
                        parentNav.querySelectorAll('.submenu-item a').forEach(link => link.classList.remove('active'));
                        actionTarget.classList.add('active');
            
                        showView(action);
                    });
                }
            
                // Listener for the clickable card in reports
                $('#reportsScreen').addEventListener('click', handleReportsClick);
            
                // Delegated listener for budget table actions
                $('#budget-table-container').addEventListener('click', handleBudgetTableClick);
            
                // Listener for payment modal
                $('#detailContent').addEventListener('click', e => {
                    const removeBtn = e.target.closest('[data-action="remove-payment"]');
                    if (removeBtn) {
                        removeWeekendPayment(parseInt(removeBtn.dataset.index, 10));
                    }
                });
            
                // Initialize the gender toggle
                $('#mciGenderToggle').addEventListener('click', e => {
                    const opt = e.target.closest('.opt');
                    if (!opt) return;
                    selectGender(opt.dataset.gender, opt);
                });
            }

            async function showCurrentReportsView() {
                 // This function replaces showReportsByGender
                const gender = currentGender;

                // Set UI state
                $('#mciInitialPrompt').style.display = 'none';
                $('#mciMain').style.display = 'none';
                $('#reportsScreen').style.display = 'flex';
                
                // Update the main header dynamically
                $('#reportsScreen h2').textContent = `${gender.charAt(0).toUpperCase() + gender.slice(1)}'s Meeting Report`;
                
                // Show a temporary loading state non-destructively
                $$('#reportsScreen [id*="Expected"], #reportsScreen [id*="Collected"], #reportsScreen [id*="Balance"]').forEach(el => el.textContent = '...');
                $('#statusTableBody').innerHTML = '<tr><td colspan="7" style="text-align:center;">Loading team data...</td></tr>';

                const rosterTable = gender === 'men' ? 'men_team_rosters' : 'women_team_rosters';
                const { data: teams, error } = await supabaseClient.from(rosterTable).select('weekend_identifier');
                if (error) {
                    alert(`Error fetching team list: ${error.message}`);
                    $('#statusTableBody').innerHTML = `<tr><td colspan="7" style="text-align:center; color: var(--accentD);">Error loading team list.</td></tr>`;
                    return;
                }

                const prefix = gender.charAt(0).toUpperCase() + gender.slice(1) + "'s ";
                let latest = { number: 0, identifier: null };
                teams.forEach(team => {
                    const idStr = (team.weekend_identifier || '').trim();
                    if (idStr.startsWith(prefix)) {
                        const num = parseInt(idStr.match(/\d+/)?.[0] || '0', 10);
                        if (num > latest.number) {
                            latest = { number: num, identifier: idStr };
                        }
                    }
                });

                if (latest.identifier) {
                    await importTeam(latest.identifier);
                    renderReports(); // Now render the reports with the loaded data
                } else {
                    alert(`No ${gender}'s team found to generate a report.`);
                    $('#statusTableBody').innerHTML = `<tr><td colspan="7" style="text-align:center;">No ${gender}'s team data found.</td></tr>`;
                    // You might want to clear other report fields here as well
                }
            }

            async function showImport() {
                $('#importModal').style.display = 'block';

                const { data: menTeams, error: menErr } = await supabaseClient.from('men_team_rosters').select('weekend_identifier');
                const { data: womenTeams, error: womenErr } = await supabaseClient.from('women_team_rosters').select('weekend_identifier');

                if (menErr || womenErr) {
                    console.error("Error fetching MCI team lists:", menErr || womenErr);
                    $('#mciLoadMenBtn').disabled = true;
                    $('#mciLoadWomenBtn').disabled = true;
                    return;
                }

                const getLatestIdentifier = (teams, gender) => {
                    if (!teams || !gender) return { number: 0, identifier: null };
                    
                    const prefix = gender.charAt(0).toUpperCase() + gender.slice(1) + "'s "; // e.g., "Men's "
                    let latest = { number: 0, identifier: null };
                    
                    teams.forEach(team => {
                        const identifierStr = team.weekend_identifier ? String(team.weekend_identifier).trim() : '';
                        
                        // Only consider identifiers that match this community's format
                        if (identifierStr.startsWith(prefix)) {
                            const numMatch = identifierStr.match(/\d+/);
                            const num = numMatch ? parseInt(numMatch[0], 10) : 0;

                            if (num > latest.number) {
                                latest = { number: num, identifier: identifierStr };
                            }
                        }
                    });
                    return latest;
                };

                const latestMen = getLatestIdentifier(menTeams, 'men');
                const menBtn = $('#mciLoadMenBtn');
                if (latestMen.identifier) {
                    menBtn.textContent = `Load Men's ${latestMen.number}`;
                    menBtn.dataset.identifier = latestMen.identifier;
                    menBtn.disabled = false;
                } else {
                    menBtn.textContent = 'No Men\'s Teams';
                    menBtn.disabled = true;
                }
                
                const latestWomen = getLatestIdentifier(womenTeams, 'women');
                const womenBtn = $('#mciLoadWomenBtn');
                if (latestWomen.identifier) {
                    womenBtn.textContent = `Load Women's ${latestWomen.number}`;
                    womenBtn.dataset.identifier = latestWomen.identifier;
                    womenBtn.disabled = false;
                } else {
                    womenBtn.textContent = 'No Women\'s Teams';
                    womenBtn.disabled = true;
                }
            }

            function closeImport() {
                $('#importModal').style.display = 'none';
            }

            function showClearOptionsModal() {
                $('#clearOptionsModal').style.display = 'block';
            }

            function closeClear() {
                $('#clearOptionsModal').style.display = 'none';
            }

            async function selectGender(g, el) {
                currentGender = g;
                const toggle = el.parentElement;
                toggle.querySelectorAll('.opt').forEach(o => o.classList.remove('active'));
                el.classList.add('active');
                await loadLatestTeamByGender(g);
            }

            async function loadLatestTeamByGender(gender) {
                // Show a loading state in the members list
                const listContainer = $('#membersList');
                listContainer.innerHTML = `<div class="empty-list-message">Loading latest ${gender}'s team...</div>`;
                $('#detailContent').innerHTML = '<div class="empty-list-message" style="margin: auto;">Loading...</div>';
                // Also, make sure the main container is visible while loading
                $('#mciMain').style.display = 'grid';
                $('#mciInitialPrompt').style.display = 'none';

                const rosterTable = gender === 'men' ? 'men_team_rosters' : 'women_team_rosters';
                const { data: teams, error } = await supabaseClient.from(rosterTable).select('weekend_identifier');
                
                if (error) {
                    alert(`Error fetching team list: ${error.message}`);
                    clearTeamView();
                    return;
                }

                const prefix = gender.charAt(0).toUpperCase() + gender.slice(1) + "'s ";
                let latest = { number: 0, identifier: null };
                
                (teams || []).forEach(team => {
                    const idStr = (team.weekend_identifier || '').trim();
                    if (idStr.startsWith(prefix)) {
                        const num = parseInt(idStr.match(/\d+/)?.[0] || '0', 10);
                        if (num > latest.number) {
                            latest = { number: num, identifier: idStr };
                        }
                    }
                });

                if (latest.identifier) {
                    await importTeam(latest.identifier); // This will load data and render the list
                } else {
                    // No team found, so reset to the initial state
                    clearTeamView();
                    // But then, re-show the controls and update the prompt message.
                    $('#mciControls').style.display = 'flex';
                    $('#mciInitialPrompt').style.display = 'block';
                    $('#mciInitialPrompt p').textContent = `No ${gender}'s team roster could be found. Use Team Viewer to create one.`;
                    $('#mciMain').style.display = 'none';
                }
            }

            async function loadLatestTeam(gender) {
                const button = $(`#mciLoad${gender.charAt(0).toUpperCase() + gender.slice(1)}Btn`);
                const identifier = button.dataset.identifier;
                if (!identifier) {
                    alert('Could not find a team identifier to load.');
                    return;
                }
                
                $('#teamIdInput').value = identifier;
                await importTeam(identifier);
            }

            async function loadWeekendOptions() {
                const rosterTable = currentGender === 'men' ? 'men_team_rosters' : 'women_team_rosters';
                const {
                    data,
                    error
                } = await supabaseClient
                    .from(rosterTable)
                    .select('weekend_identifier')
                    .order('weekend_identifier', {
                        ascending: true
                    });

                const sel = document.getElementById('weekendSelect');
                if (!sel) return; // Guard against error if dropdown is removed
                sel.innerHTML = '';
                if (error) {
                    sel.innerHTML = '<option value="">Error loading</option>';
                    return;
                }
                const uniq = [...new Set((data || []).map(r => r.weekend_identifier))];
                if (!uniq.length) {
                    sel.innerHTML = '<option value="">No weekends found</option>';
                    return;
                }
                sel.appendChild(new Option('Select weekend…', ''));
                uniq.forEach(w => sel.appendChild(new Option(w, w)));
            }

            async function importTeam(teamIdToLoad) {
                let teamId = teamIdToLoad;

                if (!teamId) {
                    // This block handles the manual import from the old modal, can be kept for fallback
                    const teamIdInput = $('#teamIdInput');
                    const teamIdFromSelect = $('#weekendSelect') ? $('#weekendSelect').value : '';
                    teamId = (teamIdFromSelect || (teamIdInput ? teamIdInput.value : '')).trim();

                    if (!teamId) {
                        alert('Please pick or enter a weekend identifier.');
                        return;
                    }
                }
                
                currentTeamId = teamId;
                currentGender = teamId.toLowerCase().startsWith('women') ? 'women' : 'men';

                const rosterTable = currentGender === 'men' ? 'men_team_rosters' : 'women_team_rosters';
                const rawTable = currentGender === 'men' ? 'men_raw' : 'women_raw';

                const {
                    data: rosterEntries,
                    error: rosterError
                } = await supabaseClient.from(rosterTable).select('pescadore_key, role').eq('weekend_identifier', teamId);
                if (rosterError || !rosterEntries || rosterEntries.length === 0) {
                    alert(rosterError ? `Roster load error: ${rosterError.message}` : `No roster found for "${teamId}".`);
                    return;
                }

                const keys = [...new Set(rosterEntries.map(r => r.pescadore_key))];
                const {
                    data: profiles,
                    error: profileError
                } = await supabaseClient.from(rawTable).select('PescadoreKey, First, Last, Email').in('PescadoreKey', keys);
                if (profileError) {
                    alert(`Profile load error: ${profileError.message}`);
                    return;
                }

                const profileMap = (profiles || []).reduce((acc, p) => {
                    acc[String(p.PescadoreKey)] = p;
                    return acc;
                }, {});
                memberDetails = {};
                rosterEntries.forEach(r => {
                    const prof = profileMap[String(r.pescadore_key)];
                    const name = prof ? `${prof.First||''} ${prof.Last||''}`.trim() : 'Unknown Member';
                    const role = (r.role || '').replace('Prof_', '');
                    memberDetails[String(r.pescadore_key)] = {
                        name,
                        role,
                        email: prof ? prof.Email : ''
                    };
                });

                const {
                    data: saved,
                    error: loadErr
                } = await supabaseClient
                    .from('mci_checkin_data')
                    .select('member_id, checkin_details')
                    .eq('team_id', teamId);

                if (loadErr) {
                    console.warn('Checkin load error:', loadErr);
                }

                checkinData = {};
                Object.keys(memberDetails).forEach(id => {
                    const row = (saved || []).find(x => String(x.member_id) === String(id));
                    checkinData[id] = row?.checkin_details || {
                        attendance: {},
                        weekendFee: [],
                        teamFee: {},
                        palancaLetter: false
                    };
                    // Ensure backward compatibility for old data format
                    if (checkinData[id].weekendFee && typeof checkinData[id].weekendFee === 'object' && !Array.isArray(checkinData[id].weekendFee)) {
                        checkinData[id].weekendFee = [checkinData[id].weekendFee];
                    }
                });

                renderMembersList();
                $('#detailContent').innerHTML = '<div style="text-align:center;color:var(--muted); margin: auto;">Select a team member to check them in.</div>';
                closeImport();
            }

            function clearTeamView() {
                memberDetails = {};
                checkinData = {};
                selectedMemberId = null;
                currentTeamId = null;
                
                $('#mciMain').style.display = 'none';
                $('#reportsScreen').style.display = 'none';
                $('#mciInitialPrompt').style.display = 'block';
                $('#mciControls').style.display = 'none'; // Also hide controls when view is cleared
                 $('#mciInitialPrompt p').textContent = "Please select a team to begin. Use the sidebar menu to load the latest Men's or Women's team roster and their check-in data.";


                const teamIdInput = $('#teamIdInput');
                if (teamIdInput) teamIdInput.value = '';

                renderMembersList();
                $('#detailContent').innerHTML = '<div style="text-align:center;color:var(--muted); margin: auto;">Team cleared. Use the sidebar to load a team.</div>';
            }

            function confirmClearApplicationData() {
                if (!currentTeamId) {
                    alert('No team loaded.');
                    return;
                }
                if (!confirm(`Are you sure you want to permanently delete all check-in data for team "${currentTeamId}"? This cannot be undone.`)) return;

                supabaseClient.from('mci_checkin_data').delete().eq('team_id', currentTeamId).then(({
                    error
                }) => {
                    if (error) {
                        alert('Error clearing: ' + error.message);
                        return;
                    }
                    alert('All check-in data cleared for this team.');
                    clearTeamView();
                    closeClear();
                });
            }

            function renderMembersList() {
                const c = document.getElementById('membersList');
                const entries = Object.entries(memberDetails)
                    .sort(([, a], [, b]) => a.name.localeCompare(b.name));

                document.getElementById('memberCount').textContent = String(entries.length);
                c.innerHTML = '';
                if (!entries.length) {
                    c.innerHTML = `<div class="empty-list-message">No team members loaded. Click 'Import Team' to begin.</div>`;
                    return;
                }
                entries.forEach(([id, m]) => {
                    const chk = checkinData[id] || {};
                    const meetings = Object.values(chk.attendance || {}).filter(Boolean).length;
                    const row = document.createElement('div');
                    row.className = 'member-item' + (selectedMemberId === id ? ' selected' : '');

                    const isFeeWaived = feeExemptRoles.includes(m.role);
                    const weekendPaidAmount = chk.weekendFee?.amount || 0;
                    const isWeekendPaid = isFeeWaived || weekendPaidAmount >= CONFIG.WEEKEND_FEE;

                    row.innerHTML = `
          <div>
            <div class="member-name">${m.name}</div>
            <div style="color:var(--muted);font-size:12px">${m.role||''}</div>
          </div>
          <div style="display:flex;align-items:center;gap:12px">
            <div style="font-size:12px;color:var(--muted)">${meetings}/${CONFIG.MEETING_COUNT}</div>
            <div style="display:flex;gap:10px">
              <span class="status-dot ${isWeekendPaid ? 'complete' : ''}"></span>
              <span class="status-dot ${(chk.teamFee?.paid)?'complete':''}"></span>
              <span class="status-dot ${chk.palancaLetter?'complete':''}"></span>
            </div>
          </div>`;
                    row.addEventListener('click', () => selectMember(id));
                    c.appendChild(row);
                });
            }

            function selectMember(id) {
                selectedMemberId = id;
                renderMembersList();
                renderDetailPanel();
            }

            function renderDetailPanel() {
                const detail = document.getElementById('detailContent');
                if (!selectedMemberId) {
                    detail.innerHTML = '<div class="empty-list-message" style="margin: auto;">Select a team member to check them in.</div>';
                    return;
                }
                const member = memberDetails[selectedMemberId];
                const chk = checkinData[selectedMemberId];

                document.getElementById('detailPanelName').textContent = member.name;

                const wkAmt = CONFIG.WEEKEND_FEE;
                const tmAmt = CONFIG.TEAM_FEE;

                const isFeeWaived = feeExemptRoles.includes(member.role);
                const wkPaid = isFeeWaived ? wkAmt : (chk.weekendFee || []).reduce((sum, p) => sum + (p.amount || 0), 0);
                const wkDue = isFeeWaived ? 0 : Math.max(0, wkAmt - wkPaid);
                const tmPaid = chk.teamFee?.paid ? tmAmt : 0;
                const tmDue = Math.max(0, tmAmt - tmPaid);

                const weekendButtonsDisabled = isFeeWaived ? 'disabled' : '';

                // Logic for button styling based on payment status
                const weekendFeeStatus = isFeeWaived ? 'waived' : (wkPaid >= wkAmt ? 'paid' : (wkPaid > 0 ? 'partial' : 'due'));
                const getBtnClass = (method) => {
                    if (!chk.weekendFee || chk.weekendFee.length === 0) return '';
                    const hasPaymentOfMethod = chk.weekendFee.some(p => p.method === method);
                    if (!hasPaymentOfMethod) return '';
                    if (weekendFeeStatus === 'paid') return 'btn-primary';
                    if (weekendFeeStatus === 'partial') return 'btn-warning';
                    return '';
                };
                const cashBtnClass = getBtnClass('cash');
                const checkBtnClass = getBtnClass('check');
                const onlineBtnClass = getBtnClass('online');
                const sponsorshipBtnClass = getBtnClass('sponsorship');


                detail.innerHTML = `
          <div class="section-title">Meetings</div>
          <div id="attendanceGrid" class="attendance-grid"></div>

          <div class="section-title" style="margin-top:18px">Payments</div>
          <div class="grid grid-2">
            <div class="card fee-card">
              <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px;">
                <div class="label" style="margin-bottom: 0;">Weekend Fee</div>
                ${isFeeWaived ? '<div style="color:var(--accentA); font-weight:600; font-size: 0.8rem;">Fee Waived for this Role</div>' : ''}
              </div>
              <div class="payment-options-grid">
                <button class="btn ${cashBtnClass}" onclick="MCI.handleWeekendFeeClick('cash')" ${weekendButtonsDisabled}>Cash</button>
                <button class="btn ${checkBtnClass}" onclick="MCI.handleWeekendFeeClick('check')" ${weekendButtonsDisabled}>Check</button>
                <button class="btn ${onlineBtnClass}" onclick="MCI.handleWeekendFeeClick('online')" ${weekendButtonsDisabled}>Online</button>
              </div>
              <div style="margin-top: 8px;">
                <button class="btn ${sponsorshipBtnClass}" onclick="MCI.handleWeekendFeeClick('sponsorship')" style="width: 100%;" ${weekendButtonsDisabled}>Sponsorship</button>
              </div>
              <div id="paymentBadgesContainer" style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; min-height: 28px;"></div>
              <div class="inline-status">
                <span class="label">Paid:</span><span class="amount-paid">${fmt(wkPaid)}</span>
                <span class="label">Due:</span><span class="amount-due">${fmt(wkDue)}</span>
              </div>
            </div>

            <div class="card fee-card">
              <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px;">
                <div class="label" style="margin-bottom: 0;">Team Fee</div>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn ${chk.teamFee?.paid?'btn-primary':''}" data-fee="team" data-method="paid">Paid</button>
              </div>
              <div class="inline-status">
                <span class="label">Paid:</span><span class="amount-paid">${fmt(tmPaid)}</span>
                <span class="label">Due:</span><span class="amount-due">${fmt(tmDue)}</span>
              </div>
            </div>
          </div>
          
          <div style="margin-top:auto; padding-top: 24px; display:flex; align-items:stretch; gap: 16px; border-top: 1px solid var(--border); margin-top: 24px;">
              <button id="palancaBtn" class="btn ${chk.palancaLetter ? 'btn-primary' : ''}">Palanca Letter Received</button>
              <button class="btn btn-primary" id="saveBtn" style="flex-grow: 1;">Save & Update</button>
          </div>
      `;

                const grid = document.getElementById('attendanceGrid');
                grid.innerHTML = '';
                for (let i = 1; i <= CONFIG.MEETING_COUNT; i++) {
                    const btn = document.createElement('button');
                    const val = chk.attendance?.[i];
                    btn.className = 'meet-btn';
                    btn.textContent = String(i);
                    if (val === true) btn.classList.add('attended');
                    else if (val === 'zoom') btn.classList.add('zoom');
                    btn.addEventListener('click', () => {
                        chk.attendance = chk.attendance || {};
                        const cur = chk.attendance[i];
                        if (cur === false || cur === undefined) chk.attendance[i] = true;
                        else if (cur === true) chk.attendance[i] = 'zoom';
                        else chk.attendance[i] = false;
                        renderDetailPanel();
                        renderMembersList();
                    });
                    grid.appendChild(btn);
                }

                detail.querySelectorAll('[data-fee="team"]').forEach(b => {
                    b.addEventListener('click', () => {
                        chk.teamFee = chk.teamFee || {};
                        chk.teamFee.paid = !chk.teamFee.paid;
                        chk.teamFee.amount = chk.teamFee.paid ? CONFIG.TEAM_FEE : 0;
                        renderDetailPanel();
                        renderMembersList();
                    });
                });

                document.getElementById('palancaBtn').addEventListener('click', () => {
                    chk.palancaLetter = !chk.palancaLetter;
                    renderDetailPanel();
                    renderMembersList();
                });

                document.getElementById('saveBtn').addEventListener('click', saveCheckinData);

                const badgesContainer = detail.querySelector('#paymentBadgesContainer');
                if (badgesContainer) {
                    badgesContainer.innerHTML = '';
                    (chk.weekendFee || []).forEach((payment, index) => {
                        // Only render a badge if the payment object is valid and has an amount.
                        if (payment && payment.method && payment.amount > 0) {
                            const badge = document.createElement('span');
                            badge.className = `payment-badge ${payment.method}`;
                            badge.innerHTML = `
                                <span>${payment.method}: ${fmt(payment.amount)}</span>
                                <button class="remove-payment-btn" data-action="remove-payment" data-index="${index}">×</button>
                            `;
                            badgesContainer.appendChild(badge);
                        }
                    });
                }
            }

            function showMciStatus(message, isError = false) {
                const statusBar = $('#mciStatusBar');
                if (!statusBar) return;

                statusBar.textContent = message;
                statusBar.classList.toggle('error', isError);
                statusBar.classList.add('visible');

                // Hide the bar after 2.5 seconds
                setTimeout(() => {
                    statusBar.classList.remove('visible', 'error');
                }, 2500);
            }

            function handleWeekendFeeClick(method) {
                if (!selectedMemberId) return;
                const chk = checkinData[selectedMemberId];

                if (method === 'online') {
                    const isAlreadyOnline = chk.weekendFee && chk.weekendFee.length > 0 && chk.weekendFee[0].method === 'online';
                    if (isAlreadyOnline) {
                        chk.weekendFee = [];
                    } else {
                        chk.weekendFee = [{
                            method: 'online',
                            amount: CONFIG.WEEKEND_FEE
                        }];
                    }
                    renderDetailPanel();
                    renderMembersList();
                } else if (method === 'cash' || method === 'check') {
                    openPaymentAmountModal(method, chk);
                } else if (method === 'sponsorship') {
                    openPartial(chk);
                }
            }

            function openPartial(chk) {
                partialTarget = chk;
                document.getElementById('partialAmount').value = ''; // Always open empty for a new payment
                document.getElementById('partialModal').style.display = 'block';
            }

            function closePartial() {
                document.getElementById('partialModal').style.display = 'none';
                partialTarget = null;
            }

            function applyPartial() {
                if (!partialTarget) {
                    closePartial();
                    return;
                }
                const amt = parseFloat(document.getElementById('partialAmount').value || '0');

                if (amt > 0) {
                    partialTarget.weekendFee.push({
                        method: 'sponsorship',
                        amount: amt,
                        sponsorshipType: amt >= CONFIG.WEEKEND_FEE ? 'full' : 'partial'
                    });
                }
                closePartial();
                renderDetailPanel();
                renderMembersList();
            }

            function openPaymentAmountModal(method, chk) {
                paymentAmountTarget = chk;
                paymentAmountMethod = method;
                $('#paymentAmountModalTitle').textContent = `Enter ${method.charAt(0).toUpperCase() + method.slice(1)} Payment`;
                $('#paymentAmountInput').value = ''; // Always open fresh for a new payment
                
                const fullAmountBtn = $('#acceptFullPaymentBtn');
                if (fullAmountBtn) {
                    fullAmountBtn.textContent = `Accept Full Fee (${fmt(CONFIG.WEEKEND_FEE)})`;
                    fullAmountBtn.onclick = () => {
                        $('#paymentAmountInput').value = CONFIG.WEEKEND_FEE;
                    };
                }

                $('#paymentAmountModal').style.display = 'block';
                $('#paymentAmountInput').focus();
            }

            function closePaymentAmountModal() {
                $('#paymentAmountModal').style.display = 'none';
                paymentAmountTarget = null;
                paymentAmountMethod = null;
            }

            function applyPaymentAmount() {
                if (!paymentAmountTarget || !paymentAmountMethod) {
                    closePaymentAmountModal();
                    return;
                }
                const amt = parseFloat($('#paymentAmountInput').value || '0');
                if (amt > 0) {
                    if (!Array.isArray(paymentAmountTarget.weekendFee)) {
                        paymentAmountTarget.weekendFee = [];
                    }
                    paymentAmountTarget.weekendFee.push({
                        method: paymentAmountMethod,
                        amount: amt
                    });
                }
                closePaymentAmountModal();
                renderDetailPanel();
                renderMembersList();
            }

            async function saveCheckinData() {
                if (!selectedMemberId || !currentTeamId) {
                    showMciStatus('No team loaded or member selected.', true);
                    return;
                }
            
                // 1. Get the current, complete in-memory state of the user's check-in data.
                // This object has all the changes the user just made.
                const currentDetailsInMemory = checkinData[selectedMemberId];
            
                // 2. Fetch the LAST SAVED version from the database to prevent data loss.
                const { data: existingRecord, error: fetchError } = await supabaseClient
                    .from('mci_checkin_data')
                    .select('checkin_details')
                    .eq('team_id', currentTeamId)
                    .eq('member_id', selectedMemberId)
                    .single();
            
                if (fetchError && fetchError.code !== 'PGRST116') { // PGRST116 means "not found", which is fine for a first save.
                    console.error('Error fetching existing record before save:', fetchError);
                    showMciStatus('❌ Error fetching before save', true);
                    return;
                }
            
                // 3. Intelligently merge the two versions. Start with the last saved data,
                // then overwrite it with all the current data from the screen.
                // This ensures we always save a complete object.
                const mergedDetails = {
                    ...(existingRecord?.checkin_details || {}),
                    ...currentDetailsInMemory
                };
            
                // 4. Create the final payload with the complete, merged data.
                const payload = {
                    team_id: currentTeamId,
                    member_id: selectedMemberId,
                    checkin_details: mergedDetails
                };
            
                // 5. Upsert the complete payload.
                const { error } = await supabaseClient
                    .from('mci_checkin_data')
                    .upsert(payload, { onConflict: 'team_id, member_id' }); // Explicitly define conflict target for robust saving.
            
                if (error) {
                    showMciStatus('❌ Save Failed', true);
                    console.error('Save failed:', error);
                    return;
                }
            
                // IMPORTANT: Update the local in-memory state with the newly merged and saved version.
                // This keeps the UI and the database perfectly in sync.
                checkinData[selectedMemberId] = mergedDetails;
            
                showMciStatus('Saved Successfully');
                renderMembersList();
            }

            function removeWeekendPayment(index) {
                if (!selectedMemberId || !checkinData[selectedMemberId]) return;
                const chk = checkinData[selectedMemberId];
                if (chk.weekendFee && chk.weekendFee[index] !== undefined) {
                    showConfirmation(
                        'Remove Payment?',
                        `Are you sure you want to remove the ${chk.weekendFee[index].method} payment of ${fmt(chk.weekendFee[index].amount)}?`,
                        () => {
                            chk.weekendFee.splice(index, 1);
                            renderDetailPanel();
                            renderMembersList();
                            saveCheckinData(); 
                        }
                    );
                }
            }

            function computeTotals() {
                const t = {
                    expected: 0,
                    collected: 0,
                    weekendExpected: 0,
                    teamExpected: 0,
                    weekendCollected: 0,
                    teamCollected: 0,
                    overdue: 0,
                    cashCollected: 0,
                    checkCollected: 0, // FIX: Initialize checkCollected
                    onlineCollected: 0,
                    noAttendanceMembers: []
                };
                Object.keys(memberDetails).forEach(id => {
                    const m = memberDetails[id];
                    const chk = checkinData[id];
                    if (!m || !chk) return;

                    const isFeeWaived = feeExemptRoles.includes(m.role);

                    const wkExp = isFeeWaived ? 0 : CONFIG.WEEKEND_FEE;
                    const tmExp = CONFIG.TEAM_FEE;

                    // --- FIX START: Correctly calculate weekend fee totals from the payment array ---
                    const wkColl = isFeeWaived ? 0 : (chk.weekendFee || []).reduce((sum, p) => sum + (p.amount || 0), 0);
                    // --- FIX END ---
                    const tmColl = chk.teamFee?.paid ? tmExp : 0;

                    t.weekendExpected += wkExp;
                    t.teamExpected += tmExp;
                    t.weekendCollected += wkColl;
                    t.teamCollected += tmColl;
                    t.expected += wkExp + tmExp;
                    t.collected += wkColl + tmColl;

                    // --- FIX START: Correctly break down payments by method from the array ---
                    (chk.weekendFee || []).forEach(payment => {
                        if (payment.amount > 0) {
                            if (payment.method === 'cash') t.cashCollected += payment.amount;
                            else if (payment.method === 'check') t.checkCollected += payment.amount;
                            else if (payment.method === 'online') t.onlineCollected += payment.amount;
                            // 'sponsorship' payments are tracked but not displayed in the cash/check/online summary
                        }
                    });
                    // --- FIX END ---

                    if (chk.teamFee?.paid) {
                        // The UI doesn't specify a method for team fee, so assuming Cash for now to maintain original logic.
                        t.cashCollected += tmExp;
                    }

                    const due = (wkExp - wkColl) + (tmExp - tmColl);
                    if (due > 0.01) t.overdue += 1;

                    const meetingsAttended = Object.values(chk.attendance || {}).filter(Boolean).length;
                    if (meetingsAttended === 0) {
                        t.noAttendanceMembers.push({name: m.name, email: m.email});
                    }
                });

                // --- Store the list for the modal ---
                membersWithNoAttendance = t.noAttendanceMembers;

                // --- NEW: Meeting Attendance Calculation ---
                t.meetings = {};
                for (let i = 1; i <= CONFIG.MEETING_COUNT; i++) {
                    t.meetings[i] = { attended: 0, percentage: 0 };
                }
                const totalMembers = Object.keys(memberDetails).length;
                
                if(totalMembers > 0) {
                    Object.values(checkinData).forEach(chk => {
                        for (let i = 1; i <= CONFIG.MEETING_COUNT; i++) {
                            if (chk.attendance?.[i] === true || chk.attendance?.[i] === 'zoom') {
                                t.meetings[i].attended++;
                            }
                        }
                    });
                    
                    for (let i = 1; i <= CONFIG.MEETING_COUNT; i++) {
                        t.meetings[i].percentage = (t.meetings[i].attended / totalMembers) * 100;
                    }
                }
                // --- END: Meeting Attendance Calculation ---

                return t;
            }

            function renderReports() {
                const t = computeTotals();
                const set = (id, v) => document.getElementById(id).textContent = v;
                const fmtc = (n) => new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD'
                }).format(n || 0);
                set('totalExpected', fmtc(t.expected));
                set('totalCollected', fmtc(t.collected));
                set('balanceDue', fmtc(t.expected - t.collected));
                set('overdueItems', String(t.overdue));
                set('noAttendanceCount', String(t.noAttendanceMembers.length));

                // The onclick is now handled by the delegated listener in init()

                // --- NEW: Render Meeting Summary ---
                for (let i = 1; i <= CONFIG.MEETING_COUNT; i++) {
                    const meetingStats = t.meetings[i];
                    if (meetingStats) {
                        set(`meeting${i}Attendees`, String(meetingStats.attended));
                        const percentageEl = $(`#meeting${i}Percentage`);
                        percentageEl.textContent = `${meetingStats.percentage.toFixed(0)}%`;
                        // Change color based on attendance
                        if(meetingStats.percentage >= 80) percentageEl.style.color = 'var(--accentA)';
                        else if (meetingStats.percentage >= 50) percentageEl.style.color = 'var(--accentC)';
                        else percentageEl.style.color = 'var(--accentD)';
                    }
                }
                // --- END: Render Meeting Summary ---

                document.getElementById('weekendExpected').textContent = fmtc(t.weekendExpected);
                const weekendCollectedEl = document.getElementById('weekendCollected');
                weekendCollectedEl.textContent = fmtc(t.weekendCollected);
                weekendCollectedEl.style.color = 'var(--accentA)';

                const weekendBalance = t.weekendExpected - t.weekendCollected;
                const weekendBalanceEl = document.getElementById('weekendBalance');
                weekendBalanceEl.textContent = fmtc(weekendBalance);
                weekendBalanceEl.style.color = weekendBalance > 0.01 ? 'var(--accentD)' : 'var(--accentA)';

                document.getElementById('teamExpected').textContent = fmtc(t.teamExpected);
                const teamCollectedEl = document.getElementById('teamCollected');
                teamCollectedEl.textContent = fmtc(t.teamCollected);
                teamCollectedEl.style.color = 'var(--accentA)';

                const teamBalance = t.teamExpected - t.teamCollected;
                const teamBalanceEl = document.getElementById('teamBalance');
                teamBalanceEl.textContent = fmtc(teamBalance);
                teamBalanceEl.style.color = teamBalance > 0.01 ? 'var(--accentD)' : 'var(--accentA)';

                // Update payment method breakdowns
                document.getElementById('cashCollected').textContent = fmtc(t.cashCollected);
                document.getElementById('checkCollected').textContent = fmtc(t.checkCollected);
                document.getElementById('onlineCollected').textContent = fmtc(t.onlineCollected);

                const stBody = document.getElementById('statusTableBody');
                stBody.innerHTML = '';
                Object.keys(memberDetails).sort((a, b) => memberDetails[a].name.localeCompare(memberDetails[b].name)).forEach(id => {
                    const m = memberDetails[id];
                    const chk = checkinData[id];

                    let meetingDotsHTML = '<div class="meeting-dots-container">';
                    for (let i = 1; i <= CONFIG.MEETING_COUNT; i++) {
                        const attended = chk.attendance?.[i] === true || chk.attendance?.[i] === 'zoom';
                        meetingDotsHTML += `<span class="meeting-status-dot ${attended ? 'attended' : ''}"></span>`;
                    }
                    meetingDotsHTML += '</div>';

                    const isFeeWaived = feeExemptRoles.includes(m.role);
                    // --- FIX: Correctly sum payments from the weekendFee array ---
                    const wkPaid = isFeeWaived ? CONFIG.WEEKEND_FEE : (chk.weekendFee || []).reduce((sum, p) => sum + (p.amount || 0), 0);
                    const wkDue = isFeeWaived ? 0 : Math.max(0, CONFIG.WEEKEND_FEE - wkPaid);

                    // --- FIX: Logic to display "PARTIAL" status and render new status pills ---
                    let weekendStatus = 'DUE';
                    let paymentBadge = '';
                    const weekendPayments = chk.weekendFee || [];

                    if (isFeeWaived) {
                        weekendStatus = 'WAIVED';
                    } else if (wkDue < 0.01) {
                        weekendStatus = 'PAID';
                        paymentBadge = weekendPayments.map(p => `<span class="status-pill ${p.method}">${p.method}</span>`).join(' ');
                    } else if (wkPaid > 0) {
                        weekendStatus = 'PARTIAL'; // This now works correctly
                        paymentBadge = weekendPayments.map(p => `<span class="status-pill ${p.method}">${p.method}</span>`).join(' ');
                    }

                    // Team fee status with the new pill style
                    let teamStatus = 'DUE';
                    let teamBadge = '';
                    if (chk.teamFee?.paid) {
                        teamStatus = 'PAID';
                        teamBadge = '<span class="status-pill cash">cash</span>';
                    }
                    
                    // --- NEW: Create uniform cell HTML ---
                    const weekendStatusClass = weekendStatus.toLowerCase();
                    const weekendCellHTML = `
                        <div class="payment-cell-container">
                            <span class="payment-status-text ${weekendStatusClass}">${weekendStatus}</span>
                            <div class="payment-pills-container">${paymentBadge}</div>
                        </div>
                    `;

                    const teamStatusClass = teamStatus.toLowerCase();
                    const teamCellHTML = `
                        <div class="payment-cell-container">
                            <span class="payment-status-text ${teamStatusClass}">${teamStatus}</span>
                            <div class="payment-pills-container">${teamBadge}</div>
                        </div>
                    `;

                    const overall = (Object.values(chk.attendance || {}).filter(Boolean).length >= 3 && (wkDue < 0.01) && chk.teamFee?.paid && chk.palancaLetter) ? 'Complete' : 'Pending';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${m.name}</td>
          <td>${m.role||''}</td>
          <td>${meetingDotsHTML}</td>
          <td>${weekendCellHTML}</td>
          <td>${teamCellHTML}</td>
          <td style="text-align:center">${chk.palancaLetter?'Yes':'No'}</td>
          <td style="text-align:center; font-weight: ${overall==='Complete' ? '800; color: var(--accentA);' : ''}">${overall}</td>`;
                    stBody.appendChild(tr);
                });
            }

            function handleReportsClick(event) {
                const noAttCard = event.target.closest('#noAttendanceCard');
                if (noAttCard) {
                    showNoAttendanceModal(membersWithNoAttendance);
                }
            }

            function showNoAttendanceModal(members) {
                const listEl = $('#noAttendanceList');
                if (!members || members.length === 0) {
                    listEl.innerHTML = '<p style="text-align:center; color: var(--muted);">All members have recorded attendance.</p>';
                } else {
                    listEl.innerHTML = `<ul>${members.sort((a,b) => a.name.localeCompare(b.name)).map(member => `<li>${member.name}</li>`).join('')}</ul>`;
                }

                const copyBtn = $('#copyEmailsBtn');
                copyBtn.textContent = 'Copy Emails'; // Reset button text
                copyBtn.onclick = () => {
                    const emails = members
                        .map(m => m.email)
                        .filter(Boolean) // Remove any null/empty emails
                        .join(', ');

                    if (!emails) {
                        alert('No emails to copy for this list.');
                        return;
                    }

                    const tempTextarea = document.createElement('textarea');
                    tempTextarea.value = emails;
                    document.body.appendChild(tempTextarea);
                    tempTextarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextarea);
                    
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => { copyBtn.textContent = 'Copy Emails'; }, 2000);
                };

                $('#noAttendanceModal').style.display = 'block';
            }

            function closeNoAttendanceModal() {
                $('#noAttendanceModal').style.display = 'none';
            }

            function printStatusReport() {
                const t = computeTotals();
                const genderText = currentGender.charAt(0).toUpperCase() + currentGender.slice(1);
                const weekendNumber = extractWeekendNumber(currentTeamId);

                // Create printable HTML content
                let printContent = `
        <div style="padding: 15px; font-family: 'Arial', sans-serif; color: #333; font-size: 12px;">
          <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 12px;">
            <h1 style="margin: 0; font-size: 22px; font-weight: 900; color: #000;">${CONFIG.COMMUNITY_NAME}</h1>
            <h2 style="margin: 6px 0 0 0; font-size: 16px; color: #333;">${genderText} Weekend #${weekendNumber}</h2>
            <p style="margin: 4px 0 0 0; color: #666; font-size: 12px;">Complete Status Report - ${new Date().toLocaleDateString()}</p>
          </div>

          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 15px;">
            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #ddd;">
              <div style="color: #666; font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Balance Due</div>
              <div style="font-size: 14px; font-weight: 900; color: #000;">${new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(t.expected - t.collected)}</div>
            </div>
             <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #ddd;">
              <div style="color: #666; font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Overdue Items</div>
              <div style="font-size: 14px; font-weight: 900; color: #000;">${t.overdue}</div>
            </div>
          </div>
          
          <table style="width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 15px;">
            <thead style="background: #e9ecef;">
              <tr>
                <th style="padding: 6px; border: 1px solid #dee2e6; text-align: left;">Name</th>
                <th style="padding: 6px; border: 1px solid #dee2e6; text-align: left;">Role</th>
                <th style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">Meetings</th>
                <th style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">Weekend Fee</th>
                <th style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">Team Fee</th>
                <th style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">Palanca</th>
                <th style="padding: 6px; border: 1px solid #dee2e6; text-align: center;">Overall</th>
              </tr>
            </thead>
            <tbody>
              ${Object.keys(memberDetails).sort((a,b)=>memberDetails[a].name.localeCompare(memberDetails[b].name)).map(id => {
                  const m = memberDetails[id];
                  const chk = checkinData[id];
                  
                  let meetingDots = '<div style="display:flex; gap: 4px; justify-content: center;">';
                  for(let i=1;i<=CONFIG.MEETING_COUNT;i++){
                    const attended = chk.attendance?.[i] === true || chk.attendance?.[i] === 'zoom';
                    meetingDots += `<span style="width:12px; height:12px; border-radius: 50%; background: ${attended ? '#28a745' : '#ccc'};"></span>`;
                  }
                  meetingDots += '</div>';

                  const isFeeWaived = feeExemptRoles.includes(m.role);
                  const wkPaid = isFeeWaived ? CONFIG.WEEKEND_FEE : (chk.weekendFee?.amount || 0);
                  const wkDue = isFeeWaived ? 0 : Math.max(0, CONFIG.WEEKEND_FEE - wkPaid);
                  let weekendStatus = 'DUE';
                  if(isFeeWaived) weekendStatus = 'WAIVED';
                  else if(wkDue < 0.01) weekendStatus = `PAID ${chk.weekendFee?.method || ''}`;
                  else if(wkPaid > 0) weekendStatus = 'PARTIAL';

                  const teamStatus = chk.teamFee?.paid ? 'PAID (Cash)' : 'DUE';

                  const overall = (Object.values(chk.attendance || {}).filter(Boolean).length >= 3 && (wkDue < 0.01) && chk.teamFee?.paid && chk.palancaLetter) ? 'Complete' : 'Pending';

                  return `
                    <tr style="background: #fff;">
                      <td style="padding: 5px; border: 1px solid #dee2e6;">${m.name}</td>
                      <td style="padding: 5px; border: 1px solid #dee2e6;">${m.role||''}</td>
                      <td style="padding: 5px; border: 1px solid #dee2e6;">${meetingDots}</td>
                      <td style="padding: 5px; border: 1px solid #dee2e6; text-align:center;">${weekendStatus}</td>
                      <td style="padding: 5px; border: 1px solid #dee2e6; text-align:center;">${teamStatus}</td>
                      <td style="padding: 5px; border: 1px solid #dee2e6; text-align:center;">${chk.palancaLetter ? 'Yes' : 'No'}</td>
                      <td style="padding: 5px; border: 1px solid #dee2e6; text-align:center; font-weight: ${overall === 'Complete' ? 'bold' : 'normal'}; color: ${overall === 'Complete' ? '#28a745' : '#333'}">${overall}</td>
                    </tr>
                  `;
              }).join('')}
            </tbody>
          </table>
        </div>
        `;
                const tempDiv = document.createElement('div');
                tempDiv.id = 'printable-content';
                tempDiv.innerHTML = printContent;
                document.body.appendChild(tempDiv);

                printJS({
                    printable: 'printable-content',
                    type: 'html',
                    documentTitle: `${CONFIG.COMMUNITY_NAME} - ${genderText} #${weekendNumber} Status`,
                    targetStyles: ['*'],
                    onPrintDialogClose: () => {
                        document.body.removeChild(tempDiv);
                    }
                });
            }

            async function loadAndRenderBudgetView() {
                const container = $('#budget-table-container');
                container.innerHTML = '<p style="text-align:center; color: var(--muted);">Loading team and budget data...</p>';
                $('#budget-header-title').textContent = `${currentGender.charAt(0).toUpperCase() + currentGender.slice(1)}'s Budget`;

                try {
                    // Step 1: Ensure the latest team roster is loaded into memory if it's not already.
                    if (!currentTeamId || !currentTeamId.toLowerCase().includes(currentGender)) {
                        const rosterTable = currentGender === 'men' ? 'men_team_rosters' : 'women_team_rosters';
                        const { data: teams, error: teamError } = await supabaseClient.from(rosterTable).select('weekend_identifier');
                        if (teamError) throw teamError;
                        
                        const prefix = currentGender.charAt(0).toUpperCase() + currentGender.slice(1) + "'s ";
                        let latest = { number: 0, identifier: null };
                        
                        teams.forEach(team => {
                            const idStr = (team.weekend_identifier || '').trim();
                            if (idStr.startsWith(prefix)) {
                                const num = parseInt(idStr.match(/\d+/)?.[0] || '0', 10);
                                if (num > latest.number) {
                                    latest = { number: num, identifier: idStr };
                                }
                            }
                        });

                        if (latest.identifier) {
                            await importTeam(latest.identifier); // This populates `memberDetails`
                        } else {
                            throw new Error(`No ${currentGender}'s team found. Please create or load one in Team Viewer first.`);
                        }
                    }

                    // Step 2: Load budget settings and existing disbursement data.
                    const budgetPromise = supabaseClient.from('app_budgets').select('*').eq('id', 1).single();
                    const disbursementPromise = supabaseClient.from('mci_budgets').select('*').eq('team_gender', currentGender);

                    const [budgetResult, disbursementResult] = await Promise.all([budgetPromise, disbursementPromise]);

                    if (budgetResult.error && budgetResult.error.code !== 'PGRST116') throw budgetResult.error;
                    if (disbursementResult.error) throw disbursementResult.error;

                    budgetSettings = budgetResult.data || {};
                    disbursementData = disbursementResult.data || [];

                    renderBudgetView();

                } catch (error) {
                    console.error("Error loading budget view:", error);
                    container.innerHTML = `<p style="text-align:center; color: var(--accentD);">Failed to load budget data: ${error.message}</p>`;
                }
            }

            function renderBudgetView() {
                const container = document.getElementById('budget-table-container');
                
                const teamMembers = Object.entries(memberDetails).sort(([, a], [, b]) => a.name.localeCompare(b.name));
                let memberOptionsHTML = '<option value="" selected>Given to...</option>';
                teamMembers.forEach(([id, member]) => {
                    memberOptionsHTML += `<option value="${id}">${member.name}</option>`;
                });
                
                if (teamMembers.length === 0) {
                    container.innerHTML = `<p style="text-align:center; color: var(--muted);">No team members loaded. Please load a team on the Check-In page first.</p>`;
                    return;
                }

                container.innerHTML = `
                    <div class="budget-container">
                        <div id="financial-summary-card" class="card pad"></div>
                        <div class="budget-layout-grid">
                            <div id="budget-col-1" class="budget-column"></div>
                            <div id="budget-col-2" class="budget-column"></div>
                        </div>
                    </div>
                `;

                const col1 = document.getElementById('budget-col-1');
                const col2 = document.getElementById('budget-col-2');
                
                const leftColumnKeys = ['Rector', 'Head', 'AsstHead', 'Prayer', 'Kitchen', 'Dorm'];
                const rightColumnKeys = ['Chapel', 'Table', 'Worship', 'Palanca', 'Storeroom'];

                const createBudgetItem = (roleKey) => {
                    const disbursementRecord = disbursementData.find(d => d.role === roleKey);
                    const disbursements = disbursementRecord?.disbursements || [];
                    
                    const item = document.createElement('div');
                    item.className = 'budget-item';
                    item.dataset.role = roleKey;

                    let disbursementHTML = '';
                    disbursements.forEach(d => {
                        if (d && d.amount > 0) {
                            const selectedAttribute = `value="${d.given_to}" selected`;
                            disbursementHTML += `
                                <div class="disbursement-entry">
                                    <input type="number" class="input disbursement-amount" value="${parseFloat(d.amount).toFixed(2)}" step="0.01" min="0">
                                    <select class="select disbursement-recipient">
                                        ${memberOptionsHTML.replace(`value="${d.given_to}"`, selectedAttribute)}
                                    </select>
                                    <button class="btn btn-danger btn-small disbursement-delete-btn" style="padding: 0.5rem 0.6rem; line-height: 1;">×</button>
                                </div>`;
                        }
                    });

                    item.innerHTML = `
                        <div class="budget-item-header">
                            <span class="role">${roleKey}</span>
                            <button class="btn btn-info btn-small add-disbursement-btn">+ Add</button>
                        </div>
                        <div class="budget-item-body">
                            <div class="disbursement-inputs">${disbursementHTML}</div>
                            <div class="financial-summary">
                                <div class="financial-line">
                                    <span>Budget:</span>
                                    <span class="budget-value budget-amount"></span>
                                </div>
                                <div class="financial-line">
                                    <span>Disbursed:</span>
                                    <span class="budget-value disbursed-total"></span>
                                </div>
                                <div class="financial-line" style="font-weight: bold;">
                                    <span>Balance:</span>
                                    <span class="budget-value balance"></span>
                                </div>
                            </div>
                        </div>
                    `;
                    updateBudgetItemUI(item);
                    return item;
                };
                
                leftColumnKeys.forEach(key => col1.appendChild(createBudgetItem(key)));
                rightColumnKeys.forEach(key => col2.appendChild(createBudgetItem(key)));

                updateFinancialSummaryUI();

                container.querySelectorAll('.disbursement-amount, .disbursement-recipient').forEach(input => {
                    input.addEventListener('blur', handleDisbursementChange);
                });
            }

            function handleBudgetTableClick(event) {
                const addBtn = event.target.closest('.add-disbursement-btn');
                const deleteBtn = event.target.closest('.disbursement-delete-btn');

                if (addBtn) {
                    const item = addBtn.closest('.budget-item');
                    const inputsContainer = item.querySelector('.disbursement-inputs');
                    
                    let memberOptionsHTML = '<option value="" selected>Given to...</option>';
                    Object.entries(memberDetails).sort(([, a], [, b]) => a.name.localeCompare(b.name)).forEach(([id, member]) => {
                        memberOptionsHTML += `<option value="${id}">${member.name}</option>`;
                    });

                    const newEntry = document.createElement('div');
                    newEntry.className = 'disbursement-entry';
                    newEntry.innerHTML = `
                        <input type="number" class="input disbursement-amount" placeholder="0.00" step="0.01" min="0">
                        <select class="select disbursement-recipient">${memberOptionsHTML}</select>
                        <button class="btn btn-danger btn-small disbursement-delete-btn" style="padding: 0.5rem 0.6rem; line-height: 1;">×</button>
                    `;
                    
                    inputsContainer.appendChild(newEntry);
                    
                    newEntry.querySelectorAll('.disbursement-amount, .disbursement-recipient').forEach(el => {
                        el.addEventListener('blur', handleDisbursementChange);
                    });

                    newEntry.querySelector('.disbursement-amount').focus();
                } else if (deleteBtn) {
                    const entryToRemove = deleteBtn.closest('.disbursement-entry');
                    const budgetItem = deleteBtn.closest('.budget-item');
                    if (entryToRemove && budgetItem) {
                        entryToRemove.remove();
                        handleDisbursementChange({ target: budgetItem });
                    }
                }
            }

            function handleDisbursementChange(event) {
                const triggerElement = event.target;
                const item = triggerElement.closest('.budget-item');
                if (!item || !item.dataset.role) return;
                const roleKey = item.dataset.role;

                const inputsContainer = item.querySelector('.disbursement-inputs');
                const allEntries = Array.from(inputsContainer.querySelectorAll('.disbursement-entry'));
                
                const newDisbursements = allEntries
                    .map(entry => {
                        const amountInput = entry.querySelector('.disbursement-amount');
                        const recipientSelect = entry.querySelector('.disbursement-recipient');
                        const amount = parseFloat(amountInput.value);
                        const given_to = recipientSelect.value;
                        return { amount, given_to };
                    })
                    .filter(d => d && !isNaN(d.amount) && d.amount > 0 && d.given_to);

                saveDisbursements(roleKey, newDisbursements);
                
                let record = disbursementData.find(d => d.role === roleKey);
                if (record) {
                    record.disbursements = newDisbursements;
                } else {
                    disbursementData.push({ role: roleKey, team_gender: currentGender, disbursements: newDisbursements });
                }

                updateBudgetItemUI(item);
            }

            function updateBudgetItemUI(itemElement) {
                const roleKey = itemElement.dataset.role;
                if (!roleKey) return; 

                const budgetAmount = parseFloat(budgetSettings[`budget_${roleKey.toLowerCase()}`] || 0);
                const record = disbursementData.find(d => d.role === roleKey);
                const disbursedAmount = record ? record.disbursements.reduce((sum, item) => sum + item.amount, 0) : 0;
                const balance = budgetAmount - disbursedAmount;
                
                itemElement.querySelector('.budget-amount').textContent = fmt(budgetAmount);
                itemElement.querySelector('.disbursed-total').textContent = fmt(disbursedAmount);
                const balanceEl = itemElement.querySelector('.balance');
                balanceEl.textContent = fmt(balance);
                balanceEl.className = `budget-value balance ${balance >= 0 ? 'balance-positive' : 'balance-negative'}`;

                updateFinancialSummaryUI();
            }
            
            function updateFinancialSummaryUI() {
                const card = document.getElementById('financial-summary-card');
                if (!card) return;

                let totalBudget = 0;
                let totalDisbursedOverall = 0;
                budgetKeys.forEach(rKey => {
                    totalBudget += parseFloat(budgetSettings[`budget_${rKey.toLowerCase()}`] || 0);
                    const rec = disbursementData.find(d => d.role === rKey);
                    if (rec) {
                        totalDisbursedOverall += rec.disbursements.reduce((sum, item) => sum + item.amount, 0);
                    }
                });
                
                const totalBalance = totalBudget - totalDisbursedOverall;
                
                card.innerHTML = `
                    <div class="section-title" style="margin-bottom: 0;">Financial Summary</div>
                    <div class="grid grid-3" style="margin-top: 10px;">
                        <div><div class="label">Total Budget</div><div style="font-size:1.5rem;font-weight:900">${fmt(totalBudget)}</div></div>
                        <div><div class="label">Total Disbursed</div><div style="font-size:1.5rem;font-weight:900">${fmt(totalDisbursedOverall)}</div></div>
                        <div><div class="label">Remaining Cash</div><div style="font-size:1.5rem;font-weight:900" class="${totalBalance >= 0 ? 'balance-positive' : 'balance-negative'}">${fmt(totalBalance)}</div></div>
                    </div>
                `;
            }

            async function saveDisbursements(role, disbursementsArray) {
                const payload = {
                    team_gender: currentGender,
                    role: role,
                    disbursements: disbursementsArray
                };

                const { error } = await supabaseClient
                    .from('mci_budgets')
                    .upsert(payload, { onConflict: 'team_gender, role' });

                if (error) {
                    console.error('Error saving disbursement:', error);
                    // Optionally show a user-facing error
                }
            }

            return {
                showImport,
                closeImport,
                selectGender,
                importTeam,
                clearTeamView,
                showClearOptionsModal,
                closeClear,
                confirmClearApplicationData,
                printStatusReport,
                handleWeekendFeeClick,
                openPartial,
                closePartial,
                applyPartial,
                openPaymentAmountModal,
                closePaymentAmountModal,
                applyPaymentAmount,
                loadLatestTeam,
                closeNoAttendanceModal,
                init, // Expose init
                showView // Expose showView
            };
        })();

        const CRA = (function() {
            const $ = sel => document.querySelector(sel);
            const $$ = sel => document.querySelectorAll(sel);
            const getVal = id => {
                const el = $(`#${id}`);
                return el ? el.value.trim() : '';
            };
            const setVal = (id, val) => {
                const el = $(`#${id}`);
                if (el) el.value = val || '';
            };

            const formFields = [
                'c_lastname', 'c_address', 'c_city', 'c_state', 'c_zip', 'c_church',
                'm_first', 'm_pref', 'm_age', 'm_cell', 'm_email', 'm_emerg', 'm_emergphone',
                'f_first', 'f_pref', 'f_age', 'f_cell', 'f_email', 'f_emerg', 'f_emergphone',
                's_first', 's_last', 's_address', 's_city', 's_state', 's_zip',
                's_phone', 's_email', 's_church', 's_weekend', 's_weekendno', 's_community'
            ];
            const toggleFields = ['c_ms', 'c_clergy', 'c_spouseatt', 'c_ischristian'];
            const paymentFields = {
                wk: {
                    cash: false,
                    check: false,
                    scholarship: false,
                    scholarshipType: 'full',
                    partialAmount: 0
                },
                sp: {
                    cash: false,
                    check: false
                }
            };
            let currentApps = [];
            let editingAppId = null;
            let currentReportType = null;
            let emailLists = { rector: [], prayer: [], dorm: [], kitchen: [] };
            let currentManagingEmailList = null;
            let pendingApps = [];
            let editingFollowupId = null;

            function init() {
                // --- NEW: Add the missing navigation listener ---
                const parentNav = $('#cra-nav-parent');
                if (parentNav) {
                    parentNav.addEventListener('click', e => {
                        e.preventDefault();
                        const actionTarget = e.target.closest('[data-cra-action]');
                        if (!actionTarget) return;
            
                        const action = actionTarget.dataset.craAction;
            
                        // Handle submenu active states
                        parentNav.querySelectorAll('.submenu-item a').forEach(link => link.classList.remove('active'));
                        actionTarget.classList.add('active');
            
                        switchView(action);
                    });
                }
                // --- END: New Listener ---

                // The old tab init logic is removed, as it's now handled by the main navigation.
                // The new switchView function will be called by the nav instead.

                $$('.toggle').forEach(el => el.addEventListener('click', e => {
                    if (!e.target.classList.contains('opt')) return;
                    el.querySelectorAll('.opt').forEach(opt => opt.classList.remove('active'));
                    e.target.classList.add('active');

                    if (el.id === 'm_diet' && e.target.dataset.val === 'yes') $('#m_dietText').style.display = 'block';
                    if (el.id === 'm_diet' && e.target.dataset.val === 'no') $('#m_dietText').style.display = 'none';
                    if (el.id === 'f_diet' && e.target.dataset.val === 'yes') $('#f_dietText').style.display = 'block';
                    if (el.id === 'f_diet' && e.target.dataset.val === 'no') $('#f_dietText').style.display = 'none';
                }));

                $$('[data-payment-btn]').forEach(b => b.addEventListener('click', () => handlePayment(b.dataset.paymentBtn)));
                $$('[data-scholarship-type]').forEach(b => b.addEventListener('click', () => {
                    paymentFields.wk.scholarshipType = b.dataset.scholarshipType;
                    $('#partial-amount-container').style.display = paymentFields.wk.scholarshipType === 'partial' ? 'block' : 'none';
                    updatePaymentUI();
                }));
                $('#partial_amount').addEventListener('input', e => paymentFields.wk.partialAmount = parseFloat(e.target.value) || 0);

                $('#cra_submit').addEventListener('click', saveApplication);
                $('#cra_clear').addEventListener('click', () => {
                    if (editingAppId) { // If in edit mode, this becomes a "Cancel Edit" button
                        cancelEdit();
                    } else {
                        clearForm();
                    }
                });
                
                $('#apps_tbody').addEventListener('click', handleTableActions);

                // Add event listener for the new gender toggle in the Apps view
                $('#craAppsFilter').addEventListener('click', (e) => {
                    if (e.target.classList.contains('opt')) {
                        // Use a timeout to ensure the UI updates the active toggle before the list re-renders
                        setTimeout(() => renderApps(), 0);
                    }
                });

                $('#craFollowupFilter').addEventListener('click', (e) => {
                    if (e.target.classList.contains('opt')) {
                        setTimeout(() => renderPendingApps(), 0);
                    }
                });

                $('#craEmailFilter').addEventListener('click', (e) => {
                    if (e.target.classList.contains('opt')) {
                        // Placeholder for future logic when reports are generated
                    }
                });

                $$('#cra-reports [data-report]').forEach(btn => btn.addEventListener('click', () => generateReport(btn.dataset.report)));
                // Add event listener to re-run financial report when gender filter changes
                $('#craReportFilter').addEventListener('click', (e) => {
                    if (e.target.classList.contains('opt') && currentReportType) {
                        // Use a timeout to ensure the UI updates the active toggle before the report re-renders
                        setTimeout(() => generateReport(currentReportType), 0);
                    }
                });

                // Event listeners for new followup modal and list
                $('#followup-list-container').addEventListener('click', e => {
                    const button = e.target.closest('button[data-id]');
                    if (button) {
                        openFollowupModal(parseInt(button.dataset.id, 10));
                    }
                });

                $('#followupModalSave').addEventListener('click', saveFollowup);
                $('#followupModalCancel').addEventListener('click', closeFollowupModal);

                // Listener for the diet toggle in the new modal
                $('#followup_diet').addEventListener('click', e => {
                    if (e.target.classList.contains('opt')) {
                        const showDetails = e.target.dataset.val === 'yes';
                        $('#followup_diet_details_container').style.display = showDetails ? 'block' : 'none';
                    }
                });

                // --- NEW: Delegated listener for the email reports table ---
                $('#emailReportsTbody').addEventListener('click', e => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;

                    const reportType = button.dataset.type;
                    const action = button.dataset.action;

                    if (action === 'manage') {
                        openManageRecipientsModal(reportType);
                    } else if (action === 'view-send') {
                        openReportModal(reportType);
                    }
                });

                // --- NEW: Listeners for the manage recipients modal ---
                $('#addRecipientBtn').addEventListener('click', () => {
                    const reportType = $('#addRecipientBtn').dataset.type;
                    if (reportType) {
                        addRecipient(reportType, $('#recipientNewInput').value);
                    }
                });
                $('#recipientListContainer').addEventListener('click', e => {
                    const deleteBtn = e.target.closest('.delete-recipient-btn');
                    if (deleteBtn) {
                        const reportType = deleteBtn.dataset.type;
                        const email = deleteBtn.dataset.email;
                        deleteRecipient(reportType, email);
                    }
                });


                // Add blur event listeners for phone number formatting
                const phoneInputs = ['#m_cell', '#m_emergphone', '#f_cell', '#f_emergphone', '#s_phone'];
                phoneInputs.forEach(id => {
                    const input = $(id);
                    if (input) {
                        input.addEventListener('blur', () => formatPhoneNumber(input));
                    }
                });

                $('#saveEmailSettings').addEventListener('click', saveEmailSettings);
                $('#resetEmailSettings').addEventListener('click', resetEmailSettings);
                
                // --- NEW: Listener for the email prep modal copy buttons ---
                $('#reportModal').addEventListener('click', e => {
                    const target = e.target;
                    if (target.id === 'reportModalClose') {
                        closeReportModal();
                    } else if (target.id === 'copyReportBodyBtn') {
                        copyReportBodyForEmail();
                    } else {
                        const copyBtn = target.closest('[data-copy-target]');
                        if (copyBtn) {
                            copyReportField(copyBtn.dataset.copyTarget);
                        }
                    }
                });
            }

            function switchView(viewId) {
                // Hide all views
                $$('.cra-view').forEach(v => v.style.display = 'none');
                
                // Show the correct view
                const view = $(`#cra-${viewId}`);
                if (view) {
                    if (viewId === 'reports') {
                        view.style.display = 'flex'; // Reports has a special layout
                    } else {
                        view.style.display = 'block';
                    }
                }

                // If switching to the apps list, load the data
                if (viewId === 'apps') {
                    loadApps();
                } else if (viewId === 'followup') {
                    loadPendingApps();
                } else if (viewId === 'email') {
                    loadEmailConfig(); // This now also triggers the table render and loads settings
                    loadApps(); // Ensure candidate data is ready for reports
                }

                // Activate the corresponding submenu link for visual consistency
                $$('#cra-nav-parent .submenu-item a').forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.craAction === viewId) {
                        link.classList.add('active');
                    }
                });
            }

            function handlePayment(key) {
                const [type, method] = key.split('-');
                const wasActive = paymentFields[type][method];

                // Reset the relevant group before setting the new value
                if (type === 'wk') {
                    paymentFields.wk.cash = false;
                    paymentFields.wk.check = false;
                    paymentFields.wk.scholarship = false;
                } else if (type === 'sp') {
                    paymentFields.sp.cash = false;
                    paymentFields.sp.check = false;
                }
                
                // If the button was not active, activate it. This creates the toggle-off behavior.
                if (!wasActive) {
                    paymentFields[type][method] = true;
                }

                // Handle special UI for scholarship
                if (paymentFields.wk.scholarship) {
                    $('#scholarship-options').style.display = 'block';
                } else {
                    $('#scholarship-options').style.display = 'none';
                }

                updatePaymentUI();
            }

            function updatePaymentUI() {
                Object.entries(paymentFields).forEach(([type, methods]) => {
                    Object.entries(methods).forEach(([method, active]) => {
                        const btn = $(`[data-payment-btn="${type}-${method}"]`);
                        if (!btn) return;
                        if (active) {
                            btn.classList.add('active', 'btn-primary');
                        } else {
                            btn.classList.remove('active', 'btn-primary');
                        }
                    });
                });
                $('.section-title').textContent = 'Candidate – General Information';
            }

            async function saveApplication() {
                // Create a flat object with all form data.
                const data = {};
                formFields.forEach(id => data[id] = getVal(id));
                toggleFields.forEach(id => data[id] = $(`#${id} .active`).dataset.val === 'yes');
                
                // Flatten payment info
                data.payment_wk_cash = paymentFields.wk.cash;
                data.payment_wk_check = paymentFields.wk.check;
                data.payment_wk_scholarship = paymentFields.wk.scholarship;
                data.payment_wk_scholarshiptype = paymentFields.wk.scholarshipType;
                data.payment_wk_partialamount = paymentFields.wk.partialAmount;
                data.payment_sp_cash = paymentFields.sp.cash;
                data.payment_sp_check = paymentFields.sp.check;

                // --- NEW: Data Sanitization for Numeric Fields ---
                // This ensures empty number fields are sent as null, preventing the database error.
                const numericFields = ['m_age', 'f_age', 's_weekendno'];
                numericFields.forEach(field => {
                    if (data[field] === '') {
                        data[field] = null;
                    } else if (data[field] !== null) {
                        const parsed = parseInt(data[field], 10);
                        data[field] = isNaN(parsed) ? null : parsed;
                    }
                });
                // --- END: Data Sanitization ---

                if (!getVal('c_lastname') || (!getVal('m_first') && !getVal('f_first'))) {
                    alert('Last name and at least one first name are required.');
                    return;
                }
                
                let error;
                if (editingAppId) {
                    // This is an UPDATE operation
                    const { error: updateError } = await supabaseClient
                        .from('cra_applications')
                        .update(data)
                        .eq('id', editingAppId);
                    error = updateError;
                } else {
                    // This is a new INSERT operation
                    const { error: insertError } = await supabaseClient.from('cra_applications').insert([data]);
                    error = insertError;
                }


                if (error) {
                    alert('Error: ' + error.message);
                    return;
                }
                
                showMainStatus('CANDIDATE SAVED');
                
                if (editingAppId) {
                    cancelEdit(); // Reset form and UI
                    switchView('apps');
                } else {
                    clearForm();
                }
            }

            async function loadApps() {
                const {
                    data,
                    error
                } = await supabaseClient.from('cra_applications').select('*').order('created_at', {
                    ascending: false
                });
                if (error) {
                    alert('Error loading: ' + error.message);
                    return;
                }
                currentApps = data || [];
                renderApps();
            }

            function renderApps() {
                const tbody = $('#apps_tbody');
                tbody.innerHTML = '';
                
                // Get the active gender filter
                const group = $('#craAppsFilter .active').dataset.filter;

                // Filter applications based on the selected gender
                const filtered = currentApps.filter(app => {
                    const hasMan = app.m_first && app.m_first.trim() !== '';
                    const hasWoman = app.f_first && app.f_first.trim() !== '';
                    if (group === 'men') return hasMan;
                    if (group === 'women') return hasWoman;
                    return false; // Should not happen
                });

                if (!filtered.length) {
                    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:20px;">No ${group} applications found.</td></tr>`;
                    return;
                }

                filtered.forEach(app => {
                    const tr = document.createElement('tr');
                    tr.dataset.id = app.id; // Add ID to the row for easy access
                    const candName = [app.m_first, app.f_first].filter(Boolean).join(' & ') + ' ' + app.c_lastname;
                    const wkFee = app.payment_wk_scholarship ? 'Scholarship' : (app.payment_wk_cash || app.payment_wk_check ? 'Paid' : 'Due');
                    const spFee = (app.payment_sp_cash || app.payment_sp_check) ? 'Paid' : 'Due';
                    const statusClass = (app.status || '').replace(/ /g, '-').toLowerCase();

                    tr.innerHTML = `
                        <td>${candName}</td>
                        <td>${app.c_church}</td>
                        <td>${app.c_city}, ${app.c_state}</td>
                        <td>${app.s_first} ${app.s_last}</td>
                        <td>${wkFee}</td>
                        <td>${spFee}</td>
                        <td><span class="status-badge status-${statusClass}">${app.status || 'N/A'}</span></td>
                        <td class="actions-cell">
                            <button class="btn btn-small btn-info" data-action="edit">Edit</button>
                            <button class="btn btn-small btn-danger" data-action="delete">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            function handleTableActions(e) {
                const button = e.target.closest('[data-action]');
                if (!button) return;
                
                const action = button.dataset.action;
                const row = button.closest('tr');
                const id = row.dataset.id;

                if (action === 'edit') {
                    editApplication(id);
                } else if (action === 'delete') {
                    deleteApplication(id);
                }
            }

            function editApplication(id) {
                const appData = currentApps.find(app => String(app.id) === String(id));
                if (!appData) {
                    alert('Could not find application data to edit.');
                    return;
                }

                // Switch to the entry form using the new method
                switchView('entry');

                // Populate all fields
                formFields.forEach(fieldId => setVal(fieldId, appData[fieldId]));
                toggleFields.forEach(fieldId => {
                    const toggle = $(`#${fieldId}`);
                    if (!toggle) return;
                    toggle.querySelectorAll('.opt').forEach(opt => opt.classList.remove('active'));
                    const valueToSet = appData[fieldId] ? 'yes' : 'no';
                    toggle.querySelector(`[data-val="${valueToSet}"]`)?.classList.add('active');
                });
                
                // Populate payment fields
                paymentFields.wk.cash = appData.payment_wk_cash || false;
                paymentFields.wk.check = appData.payment_wk_check || false;
                paymentFields.wk.scholarship = appData.payment_wk_scholarship || false;
                paymentFields.wk.scholarshipType = appData.payment_wk_scholarshiptype || 'full';
                paymentFields.wk.partialAmount = appData.payment_wk_partialamount || 0;
                paymentFields.sp.cash = appData.payment_sp_cash || false;
                paymentFields.sp.check = appData.payment_sp_check || false;
                
                if (paymentFields.wk.scholarship) {
                    $('#scholarship-options').style.display = 'block';
                    $$('#scholarship-options .toggle .opt').forEach(opt => opt.classList.toggle('active', opt.dataset.scholarshipType === paymentFields.wk.scholarshipType));
                    if (paymentFields.wk.scholarshipType === 'partial') {
                        $('#partial-amount-container').style.display = 'block';
                        setVal('partial_amount', paymentFields.wk.partialAmount);
                    } else {
                        $('#partial-amount-container').style.display = 'none';
                    }
                } else {
                     $('#scholarship-options').style.display = 'none';
                }

                updatePaymentUI();

                // Enter "Edit Mode"
                editingAppId = id;
                $('#cra_submit').textContent = 'Update Application';
                $('#cra_clear').textContent = 'Cancel Edit';
            }

            function cancelEdit() {
                editingAppId = null;
                clearForm(false); // Clear form without confirmation
                $('#cra_submit').textContent = 'Save Candidate';
                $('#cra_clear').textContent = 'Clear Form';
            }
            
            function deleteApplication(id) {
                showConfirmation(
                    'Delete Application?',
                    'Are you sure you want to permanently delete this application? This action cannot be undone.',
                    async () => {
                        const { error } = await supabaseClient.from('cra_applications').delete().eq('id', id);
                        if (error) {
                            alert('Error deleting application: ' + error.message);
                        } else {
                            alert('Application deleted successfully.');
                            loadApps(); // Refresh the list
                        }
                    }
                );
            }

            function exportApps() {
                if (!currentApps.length) return alert('No applications to export.');
                let csv = 'LastName,Address,City,State,Zip,Church,Marital,Clergy,SpouseAttended,M_First,M_Pref,M_Age,M_Cell,M_Email,M_Emerg,M_EmergPhone,M_Smoke,M_Diet,M_DietTxt,F_First,F_Pref,F_Age,F_Cell,F_Email,F_Emerg,F_EmergPhone,F_Smoke,F_Diet,F_DietTxt,S_First,S_Last,S_Address,S_City,S_State,S_Zip,S_Phone,S_Email,S_Church,S_Wknd,S_WkndNo,S_Comm,IsChristian,WkFeePaid,SpFeePaid,Submitted\n';
                currentApps.forEach(a => {
                    const row = [
                        a.c_lastname, a.c_address, a.c_city, a.c_state, a.c_zip, a.c_church, a.c_ms, a.c_clergy, a.c_spouseatt,
                        a.m_first, a.m_pref, a.m_age, a.m_cell, a.m_email, a.m_emerg, a.m_emergphone, a.m_smoke, a.m_diet, a.m_diettext,
                        a.f_first, a.f_pref, a.f_age, a.f_cell, a.f_email, a.f_emerg, a.f_emergphone, a.f_smoke, a.f_diet, a.f_diettext,
                        a.s_first, a.s_last, a.s_address, a.s_city, a.s_state, a.s_zip, a.s_phone, a.s_email, a.s_church, a.s_weekend, a.s_weekendno, a.s_community,
                        a.c_ischristian,
                        (a.payment_wk_cash || a.payment_wk_check || a.payment_wk_scholarship), (a.payment_sp_cash || a.payment_sp_check),
                        a.submitted_at
                    ].map(v => `"${(v||'').toString().replace(/"/g, '""')}"`).join(',');
                    csv += row + '\n';
                });

                const blob = new Blob([csv], {
                    type: 'text/csv;charset=utf-8;'
                });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `applications_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            async function loadPendingApps() {
                const listContainer = $('#followup-list-container');
                listContainer.innerHTML = '<p>Loading pending calls...</p>';
                const { data, error } = await supabaseClient
                    .from('cra_applications')
                    .select('*')
                    .order('created_at', { ascending: true });

                if (error) {
                    listContainer.innerHTML = '<p style="color: var(--accentD);">Error loading applications.</p>';
                    console.error(error);
                    return;
                }
                pendingApps = data || [];
                renderPendingApps();
            }

            function renderPendingApps() {
                const listContainer = $('#followup-list-container');
                const group = $('#craFollowupFilter .active').dataset.filter;
                
                const filtered = pendingApps.filter(app => {
                    const hasMan = app.m_first && app.m_first.trim() !== '';
                    const hasWoman = app.f_first && app.f_first.trim() !== '';
                    if (group === 'men') return hasMan;
                    if (group === 'women') return hasWoman;
                    return false;
                });

                if (filtered.length === 0) {
                    listContainer.innerHTML = `<p style="text-align:center; color: var(--muted); padding: 20px;">No pending ${group} follow-up calls.</p>`;
                    return;
                }

                const table = document.createElement('table');
                table.className = 'table';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Candidate(s)</th>
                            <th>Sponsor</th>
                            <th>Cand. Phone</th>
                            <th>App Date</th>
                            <th>Sponsor Letter</th>
                            <th>Cand. Letter</th>
                            <th style="width: 120px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="pending_apps_tbody"></tbody>
                `;
                const tbody = table.querySelector('#pending_apps_tbody');
                filtered.forEach(app => {
                    const tr = document.createElement('tr');
                    const candName = [app.m_first, app.f_first].filter(Boolean).join(' & ') + ' ' + app.c_lastname;
                    const submittedDate = new Date(app.created_at).toLocaleDateString();
                    const phone = group === 'men' ? app.m_cell : app.f_cell;
                    const sponsorLetterSent = app.letter_sent_sponsor ? 'Yes' : 'No';
                    const candidateLetterSent = app.letter_sent_candidate ? 'Yes' : 'No';
                    tr.innerHTML = `
                        <td>${candName}</td>
                        <td>${app.s_first} ${app.s_last}</td>
                        <td>${phone || 'N/A'}</td>
                        <td>${submittedDate}</td>
                        <td>${sponsorLetterSent}</td>
                        <td>${candidateLetterSent}</td>
                        <td><button class="btn btn-small btn-info" data-id="${app.id}">Start Call</button></td>
                    `;
                    tbody.appendChild(tr);
                });
                listContainer.innerHTML = '';
                listContainer.appendChild(table);
            }

            function openFollowupModal(id) {
                const app = pendingApps.find(a => a.id === id);
                if (!app) return;
                
                editingFollowupId = id;
                
                const candName = [app.m_first, app.f_first].filter(Boolean).join(' & ') + ' ' + app.c_lastname;
                $('#followup-candidate-name').textContent = candName;
                $('#followup-sponsor-name').textContent = `${app.s_first} ${app.s_last}`;
                $('#followup-sponsor-phone').textContent = app.s_phone;

                const isMen = app.m_first && app.m_first.trim() !== '';
                const isWomen = app.f_first && app.f_first.trim() !== '';
                let phoneToShow = 'N/A';
                if (isMen && !isWomen) phoneToShow = app.m_cell;
                else if (!isMen && isWomen) phoneToShow = app.f_cell;
                else if (isMen && isWomen) phoneToShow = `M: ${app.m_cell || 'N/A'}<br>W: ${app.f_cell || 'N/A'}`;
                $('#followup-candidate-phone').innerHTML = phoneToShow;

                // Reset fields
                $('#followup_attendance').querySelectorAll('.opt').forEach(o => o.classList.remove('active'));
                $('#followup_attendance').querySelector('[data-val="no"]').classList.add('active');
                $('#followup_smoker').querySelectorAll('.opt').forEach(o => o.classList.remove('active'));
                $('#followup_smoker').querySelector('[data-val="no"]').classList.add('active');
                $('#followup_diet').querySelectorAll('.opt').forEach(o => o.classList.remove('active'));
                $('#followup_diet').querySelector('[data-val="no"]').classList.add('active');
                $('#followup_diet_details').value = '';
                $('#followup_diet_details_container').style.display = 'none';
                $('#followup_sponsor_letter').querySelectorAll('.opt').forEach(o => o.classList.remove('active'));
                $('#followup_sponsor_letter').querySelector('[data-val="no"]').classList.add('active');
                $('#followup_candidate_letter').querySelectorAll('.opt').forEach(o => o.classList.remove('active'));
                $('#followup_candidate_letter').querySelector('[data-val="no"]').classList.add('active');

                $('#followupModal').style.display = 'block';
            }

            function closeFollowupModal() {
                $('#followupModal').style.display = 'none';
                editingFollowupId = null;
            }

            async function saveFollowup() {
                if (!editingFollowupId) return;

                const dataToUpdate = {
                    attendance_confirmed: $('#followup_attendance .active').dataset.val === 'yes',
                    smoker: $('#followup_smoker .active').dataset.val === 'yes',
                    diet: $('#followup_diet .active').dataset.val === 'yes',
                    diet_details: $('#followup_diet_details').value.trim(),
                    status: 'Confirmed',
                    letter_sent_sponsor: $('#followup_sponsor_letter .active').dataset.val === 'yes',
                    letter_sent_candidate: $('#followup_candidate_letter .active').dataset.val === 'yes'
                };

                const { error } = await supabaseClient
                    .from('cra_applications')
                    .update(dataToUpdate)
                    .eq('id', editingFollowupId);

                if (error) {
                    alert('Error saving follow-up: ' + error.message);
                    console.error(error);
                    return;
                }

                closeFollowupModal();
                loadPendingApps(); // Refresh the list
            }

            function renderEmailReportsTable() {
                const tbody = $('#emailReportsTbody');
                if (!tbody) return;
                tbody.innerHTML = '';

                const reportMeta = {
                    rector: { title: 'Rector Report', desc: 'Weekend, food, and status details' },
                    prayer: { title: 'Prayer Team Report', desc: 'Names, weekend type & church for prayer support' },
                    dorm: { title: 'Dorm Team Report', desc: 'Assignments and candidate info for dorm heads' },
                    kitchen: { title: 'Kitchen Team Report', desc: 'Dietary needs and headcounts for meals' }
                };

                Object.entries(reportMeta).forEach(([type, meta]) => {
                    const recipientCount = emailLists[type]?.length || 0;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${meta.title}</strong></td>
                        <td>${meta.desc}</td>
                        <td>${recipientCount} recipient(s)</td>
                        <td class="actions-cell">
                            <button class="btn btn-small" data-action="manage" data-type="${type}">Manage</button>
                            <button class="btn btn-small btn-primary" data-action="view-send" data-type="${type}">View / Send Report</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            function openManageRecipientsModal(type) {
                currentManagingEmailList = type;
                $('#manageRecipientsModalTitle').textContent = `Manage ${type.charAt(0).toUpperCase() + type.slice(1)} Report Recipients`;
                $('#addRecipientBtn').dataset.type = type; // Pass type to the add button
                
                // --- NEW: Dynamic "Quick Add" button logic ---
                const quickAddContainer = $('#quickAddContainer');
                quickAddContainer.innerHTML = ''; // Clear previous
                
                const roleMap = {
                    rector: { role: 'Rector', label: 'Add Rector' },
                    prayer: { role: 'Head Prayer', label: 'Add Head Prayer' },
                    dorm: { role: 'Head Dorm', label: 'Add Head Dorm' },
                    kitchen: { role: 'Head Kitchen', label: 'Add Head Kitchen' }
                };

                if (roleMap[type]) {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-info';
                    btn.textContent = roleMap[type].label;
                    btn.onclick = (e) => addRoleEmailToReportList(type, roleMap[type].role, e.target);
                    quickAddContainer.appendChild(btn);
                }
                // --- END: Dynamic button logic ---

                renderRecipientList(type);
                $('#manageRecipientsModal').style.display = 'block';
                $('#recipientNewInput').focus();
            }

            function closeManageRecipientsModal() {
                $('#manageRecipientsModal').style.display = 'none';
                currentManagingEmailList = null;
                $('#recipientNewInput').value = '';
            }

            function renderRecipientList(type) {
                const container = $('#recipientListContainer');
                const list = emailLists[type] || [];
                if (list.length === 0) {
                    container.innerHTML = '<p style="color: var(--muted); font-style: italic;">No recipients added yet.</p>';
                    return;
                }
                container.innerHTML = list.map(email => `
                    <div class="recipient-badge">
                        <span>${email}</span>
                        <button class="delete-recipient-btn" data-email="${email}" data-type="${type}">×</button>
                    </div>
                `).join('');
            }

            function generateReport(type) {
                currentReportType = type; // Store the current report type
                const out = $('#cra-report-output');
                out.innerHTML = ''; // Clear previous table-based reports
                $('#cra-financial-report').style.display = 'none'; // Hide financial report by default

                if (!currentApps.length) {
                    out.innerHTML = '<p>No applications available to generate report.</p>';
                    return;
                }
                
                if (type === 'financial') {
                    renderFinancialReport();
                    return; // Financial report has its own container, so we're done.
                }

                if (type === 'checkin') {
                    renderCheckinReport();
                    return;
                }

                const group = $('#craReportFilter .active').dataset.filter;
                let apps = currentApps.filter(a => (group === 'men' && a.m_first) || (group === 'women' && a.f_first));

                let html = `<div class="card pad">`;
                if (type === 'attendees') {
                    html += `<div class="section-title">${group.toUpperCase()} Attendee List</div><table class="table"><thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Emergency Contact</th><th>Smoker</th><th>Diet</th></tr></thead><tbody>`;
                    apps.forEach(a => {
                        const p = (group === 'men') ? 'm_' : 'f_';
                        html += `<tr>
              <td>${a[p+'first']} ${a[p+'pref']?`(${a[p+'pref']}) `:''}${a.c_lastname}</td>
              <td>${a[p+'cell']}</td>
              <td>${a[p+'email']}</td>
              <td>${a[p+'emerg']} ${a[p+'emergphone']}</td>
              <td>${a.smoker ? 'Yes' : 'No'}</td>
              <td>${a.diet ? (a.diet_details || 'Yes') : 'None'}</td>
            </tr>`;
                    });
                    html += `</tbody></table>`;
                } else if (type === 'payments') {
                    html += `<div class="section-title">${group.toUpperCase()} Payment Report</div><table class="table"><thead><tr><th>Name</th><th>Weekend Fee</th><th>Sponsor Fee</th></tr></thead><tbody>`;
                    apps.forEach(a => {
                        let wkFee;
                        if (a.payment_wk_scholarship) {
                            wkFee = a.payment_wk_scholarshiptype === 'full' ? 'Full Scholarship' : `Partial ($${a.payment_wk_partialamount})`;
                        } else {
                            wkFee = (a.payment_wk_cash || a.payment_wk_check) ? 'Paid' : 'Due';
                        }
                        const spFee = (a.payment_sp_cash || a.payment_sp_check) ? 'Paid' : 'Due';

                        html += `<tr><td>${group==='men'?a.m_first:a.f_first} ${a.c_lastname}</td><td>${wkFee}</td><td>${spFee}</td></tr>`;
                    });
                    html += `</tbody></table>`;
                }
                html += `</div>`;
                out.innerHTML = html;
            }

            function renderCheckinReport() {
                const group = $('#craReportFilter .active').dataset.filter;
                const apps = currentApps.filter(a => (group === 'men' && a.m_first) || (group === 'women' && a.f_first));
                const out = $('#cra-report-output');

                let reportHtml = `
                    <div class="card pad checkin-report-container" id="checkin-report-printable">
                        <div class="checkin-report-header">
                            <h1>${CONFIG.COMMUNITY_NAME}</h1>
                            <h2>${group.charAt(0).toUpperCase() + group.slice(1)}'s Weekend Check-In Sheet</h2>
                        </div>
                        <table class="table checkin-report-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Contact Information</th>
                                    <th>Church</th>
                                    <th>Emergency Contact</th>
                                    <th style="width: 150px; text-align: center;">Info Verified</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                apps.forEach(app => {
                    const p = (group === 'men') ? 'm_' : 'f_';
                    const smokerInfo = app.smoker ? '<span class="checkin-badge smoker">Smoker</span>' : '';
                    const dietInfo = app.diet ? `<span class="checkin-badge diet">Diet: ${app.diet_details || 'Yes'}</span>` : '';
                    const name = `<strong>${app[p+'first'] || ''} ${app.c_lastname || ''}</strong><br><span style="font-size: 0.8em; color: var(--muted);">${app[p+'pref'] ? `(Prefers: ${app[p+'pref']})` : ''}</span><div class="checkin-info">${smokerInfo}${dietInfo}</div>`;
                    const address = `${app.c_address || ''}<br>${app.c_city || ''}, ${app.c_state || ''} ${app.c_zip || ''}`;
                    const contact = `${address}<br>${app[p+'cell'] || 'N/A'}<br>${app[p+'email'] || 'N/A'}`;
                    const emergency = `${app[p+'emerg'] || 'N/A'}<br><strong>P:</strong> ${app[p+'emergphone'] || 'N/A'}`;

                    reportHtml += `
                        <tr>
                            <td>${name}</td>
                            <td>${contact}</td>
                            <td>${app.c_church || 'N/A'}</td>
                            <td>${emergency}</td>
                            <td style="text-align: center;"><div class="checkbox"></div></td>
                        </tr>
                    `;
                });

                reportHtml += `
                            </tbody>
                        </table>
                    </div>
                     <button class="btn btn-primary" onclick="CRA.printCheckinReport()" style="margin-top: 16px; width: 100%;">Print Report</button>
                `;

                out.innerHTML = reportHtml;
            }

            function printCheckinReport() {
                const landscapeCss = '@page { size: landscape; margin: 0.5in; }';
                
                // These styles are explicitly defined to mimic the on-screen look for a perfect printout.
                const printStyles = `
                    body { 
                        font-family: 'Source Sans Pro', sans-serif; 
                        color: #212529; 
                        -webkit-print-color-adjust: exact; 
                        print-color-adjust: exact;
                    }
                    .table td {
                        padding-top: 16px;
                        padding-bottom: 16px;
                        vertical-align: top;
                        font-size: 0.85rem;
                        font-weight: 600;
                    }
                    .table td strong { font-weight: 700; }
                    .table .checkbox {
                        width: 24px;
                        height: 24px;
                        border: 2px solid #6c757d;
                        border-radius: 4px;
                        margin: 0 auto;
                    }
                `;

                printJS({
                    printable: 'checkin-report-printable',
                    type: 'html',
                    documentTitle: 'Candidate Check-In Report',
                    style: [landscapeCss, printStyles].join(' '),
                    scanStyles: false // We provide all styles, so no need to scan the page.
                });
            }

            function computeFinancialTotals() {
                const group = $('#craReportFilter .active').dataset.filter;
                const apps = currentApps; // We process all apps and filter inside

                const totals = {
                    weekendExpected: 0,
                    sponsorExpected: 0,
                    weekendCollected: 0,
                    sponsorCollected: 0,
                    cashCollected: 0,
                    checkCollected: 0,
                    overdueItems: 0,
                };

                apps.forEach(app => {
                    const hasMan = app.m_first && app.m_first.trim() !== '';
                    const hasWoman = app.f_first && app.f_first.trim() !== '';
                    let peopleCountThisApp = 0;

                    if (group === 'men' && hasMan) peopleCountThisApp = 1;
                    if (group === 'women' && hasWoman) peopleCountThisApp = 1;
                    
                    if (peopleCountThisApp === 0) return; // Skip app if it doesn't match gender filter

                    // --- Calculate Expected Fees (per person) ---
                    const w_expected_per_person = (app.payment_wk_scholarship && app.payment_wk_scholarshiptype === 'full') ? 0 : CONFIG.WEEKEND_FEE;
                    const s_expected_per_person = CONFIG.SPONSOR_FEE;
                    
                    totals.weekendExpected += w_expected_per_person * peopleCountThisApp;
                    totals.sponsorExpected += s_expected_per_person * peopleCountThisApp;

                    // --- Calculate Collected Fees (per application) ---
                    // For couples, we assume payment covers both unless specified otherwise.
                    // This is a simplification based on the current UI.
                    let numPeopleOnApp = (hasMan ? 1 : 0) + (hasWoman ? 1 : 0);

                    // Weekend fee collected
                    let w_collected_total = 0;
                    if (app.payment_wk_scholarship && app.payment_wk_scholarshiptype === 'partial') {
                        w_collected_total = app.payment_wk_partialamount || 0;
                    } else if (app.payment_wk_cash || app.payment_wk_check) {
                        w_collected_total = CONFIG.WEEKEND_FEE * numPeopleOnApp;
                    } else if (app.payment_wk_scholarship && app.payment_wk_scholarshiptype === 'full') {
                        w_collected_total = CONFIG.WEEKEND_FEE * numPeopleOnApp;
                    }

                    // Sponsor fee collected
                    let s_collected_total = (app.payment_sp_cash || app.payment_sp_check) ? (CONFIG.SPONSOR_FEE * numPeopleOnApp) : 0;
                    
                    // Distribute collected amounts based on the number of people in the report
                    const weekendCollectedForReport = (w_collected_total / numPeopleOnApp) * peopleCountThisApp;
                    const sponsorCollectedForReport = (s_collected_total / numPeopleOnApp) * peopleCountThisApp;

                    totals.weekendCollected += weekendCollectedForReport;
                    totals.sponsorCollected += sponsorCollectedForReport;

                    if (app.payment_wk_cash) totals.cashCollected += weekendCollectedForReport;
                    if (app.payment_wk_check) totals.checkCollected += weekendCollectedForReport;
                    if (app.payment_sp_cash) totals.cashCollected += sponsorCollectedForReport;
                    if (app.payment_sp_check) totals.checkCollected += sponsorCollectedForReport;

                    const totalExpectedThisApp = (w_expected_per_person + s_expected_per_person) * peopleCountThisApp;
                    const totalCollectedThisApp = weekendCollectedForReport + sponsorCollectedForReport;

                    if ((totalExpectedThisApp - totalCollectedThisApp) > 0.01) {
                        totals.overdueItems++;
                    }
                });
                return totals;
            }

            function renderFinancialReport() {
                const t = computeFinancialTotals();
                const set = (id, v) => $(`#${id}`).textContent = v;
                const fmtc = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n || 0);

                const totalExpected = t.weekendExpected + t.sponsorExpected;
                const totalCollected = t.weekendCollected + t.sponsorCollected;
                set('cra_totalExpected', fmtc(totalExpected));
                set('cra_totalCollected', fmtc(totalCollected));
                set('cra_balanceDue', fmtc(totalExpected - totalCollected));
                set('cra_overdueItems', String(t.overdueItems));

                // --- Weekend Fees ---
                set('cra_weekendExpected', fmtc(t.weekendExpected));
                const weekendCollectedEl = $('#cra_weekendCollected');
                weekendCollectedEl.textContent = fmtc(t.weekendCollected);
                weekendCollectedEl.style.color = 'var(--accentA)';

                const weekendBalance = t.weekendExpected - t.weekendCollected;
                const weekendBalanceEl = $('#cra_weekendBalance');
                weekendBalanceEl.textContent = fmtc(weekendBalance);
                weekendBalanceEl.style.color = weekendBalance > 0.01 ? 'var(--accentD)' : 'var(--accentA)';
                
                // --- Sponsor Fees ---
                set('cra_sponsorExpected', fmtc(t.sponsorExpected));
                const sponsorCollectedEl = $('#cra_sponsorCollected');
                sponsorCollectedEl.textContent = fmtc(t.sponsorCollected);
                sponsorCollectedEl.style.color = 'var(--accentA)';
                
                const sponsorBalance = t.sponsorExpected - t.sponsorCollected;
                const sponsorBalanceEl = $('#cra_sponsorBalance');
                sponsorBalanceEl.textContent = fmtc(sponsorBalance);
                sponsorBalanceEl.style.color = sponsorBalance > 0.01 ? 'var(--accentD)' : 'var(--accentA)';
                
                set('cra_cashCollected', fmtc(t.cashCollected));
                set('cra_checkCollected', fmtc(t.checkCollected));
                
                $('#cra-financial-report').style.display = 'flex';
            }

            function generateReportHTML(type, gender, apps) {
                let reportHTML = '';
                let reportTitle = '';
                const generatedDate = new Date().toLocaleString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true });
                const genderTitle = gender.charAt(0).toUpperCase() + gender.slice(1);

                if (type === 'rector') {
                    reportTitle = `Rector's Report: ${genderTitle}'s Candidates`;
                    const totalCandidates = apps.length;
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    const newCandidatesCount = apps.filter(app => new Date(app.created_at) > sevenDaysAgo).length;

                    let tableRows = '';
                    apps.forEach(app => {
                        const p = (gender === 'men') ? 'm_' : 'f_';
                        const name = `${app[p + 'first'] || ''} ${app[p + 'pref'] ? '('+app[p + 'pref']+') ' : ''}${app.c_lastname || ''}`;
                        const church = app.c_church || 'N/A';
                        const age = app[p + 'age'] || 'N/A';
                        tableRows += `<tr><td>${name}</td><td>${church}</td><td style="text-align: center;">${age}</td></tr>`;
                    });

                    reportHTML = `
                        <div class="report-header">
                            <h3 class="report-title">${reportTitle}</h3>
                            <p class="report-subtitle">Generated on ${generatedDate}</p>
                        </div>
                        <div class="report-stats">
                            <div class="stat-card"><div class="stat-value">${totalCandidates}</div><div class="stat-label">Total Candidates</div></div>
                            <div class="stat-card"><div class="stat-value">${newCandidatesCount}</div><div class="stat-label">New This Week</div></div>
                        </div>
                        <div class="section-title">Candidate Roster</div>
                        <table class="table">
                            <thead><tr><th>Name</th><th>Church</th><th style="text-align: center;">Age</th></tr></thead>
                            <tbody>${tableRows}</tbody>
                        </table>`;
                }
                return { html: reportHTML, title: reportTitle };
            }

            async function openReportModal(type) {
                // Store type globally for the copy function
                currentReportType = type; 
                
                const reportTypeTitle = type.charAt(0).toUpperCase() + type.slice(1);
                const gender = $('#craEmailFilter .active').dataset.filter;
            
                // 1. Get Recipients
                const recipients = emailLists[type];
                if (!recipients || recipients.length === 0) {
                    alert(`No recipients are configured for the ${reportTypeTitle} Report. Please manage recipients first.`);
                    return;
                }
                const recipientString = recipients.join(', ');
            
                // 2. Get Candidate Data
                const apps = currentApps.filter(app => (gender === 'men' && app.m_first) || (gender === 'women' && app.f_first));
                 if (apps.length === 0) {
                    alert(`No ${gender} candidates to generate a report for.`);
                    return;
                }
                
                // 3. Generate Report Content and Title (which is the subject)
                const { html: reportContent, title: reportSubject } = generateReportHTML(type, gender, apps);
            
                // 4. Populate and show the modal
                $('#reportModalTitle').textContent = `View / Send: ${reportSubject}`;
                $('#reportModalBody').innerHTML = `<div id="report-preview-content">${reportContent}</div>`;
                $('#reportTo').value = recipientString;
                $('#reportSubject').value = reportSubject;
                $('#reportModal').style.display = 'block';
            }

            function copyReportBodyForEmail() {
                if (!currentReportType) return;
                
                const type = currentReportType;
                const gender = $('#craEmailFilter .active').dataset.filter;
                const apps = currentApps.filter(app => (gender === 'men' && app.m_first) || (gender === 'women' && app.f_first));
                
                if (apps.length === 0) {
                    showReportModalStatus(`No ${gender} candidates for this report.`, true);
                    return;
                }
            
                const { html: reportContent } = generateReportHTML(type, gender, apps);
            
                const emailBody = `
                    <!DOCTYPE html><html><head><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet"><style>body{font-family:'Source Sans Pro',sans-serif;background-color:#f4f4f4;color:#333;padding:20px;margin:0;}.container{background-color:#ffffff;border:1px solid #ddd;border-radius:12px;padding:24px;max-width:700px;margin:auto;}.report-header{text-align:center;border-bottom:1px solid #eee;padding-bottom:16px;margin-bottom:20px;}.report-title{font-size:1.5rem;font-weight:700;margin:0;}.report-subtitle{font-size:.9rem;color:#666;margin-top:4px;}.report-stats{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;}.stat-card{background-color:#f8f9fa;border:1px solid #eee;border-radius:12px;padding:16px;text-align:center;}.stat-value{font-size:2rem;font-weight:700;color:#00a3ff;}.stat-label{font-size:.85rem;color:#666;margin-top:4px;}.table{width:100%;border-collapse:collapse;font-size:.9rem;}.table th,.table td{padding:10px 8px;border-bottom:1px solid #eee;text-align:left;}.table th{font-weight:700;}.table .badge{display:inline-block;padding:3px 8px;font-size:.75rem;font-weight:700;border-radius:999px;text-transform:uppercase;}.table .badge.badge-warning{background-color:#fff3cd;color:#856404;}.section-title{font-size:1rem;font-weight:900;border-bottom:2px solid #00a3ff;padding-bottom:10px;margin-bottom:14px}</style></head><body><div class="container">${reportContent}</div></body></html>`;
            
                const listener = (event) => {
                    event.clipboardData.setData('text/html', emailBody);
                    event.clipboardData.setData('text/plain', "Please paste into an HTML-enabled email client to see the report.");
                    event.preventDefault();
                };
                document.addEventListener('copy', listener);
                document.execCommand('copy');
                document.removeEventListener('copy', listener);
            
                showReportModalStatus('Report Body Copied!');
            }

            function closeReportModal() {
                $('#reportModal').style.display = 'none';
                $('#reportModalBody').innerHTML = ''; // Clear content
                currentReportType = null; // Clear the stored type
            }

            function showReportModalStatus(message, isError = false) {
                const statusBar = $('#reportModalStatusBar');
                statusBar.textContent = message;
                statusBar.style.color = isError ? 'var(--accentD)' : 'var(--accentA)';
                statusBar.style.opacity = '1';
                setTimeout(() => statusBar.style.opacity = '0', 2000);
            }

            function copyReportField(targetId) {
                const field = document.getElementById(targetId);
                if (!field || !field.value) return;

                const tempTextarea = document.createElement('textarea');
                tempTextarea.value = field.value;
                document.body.appendChild(tempTextarea);
                tempTextarea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextarea);
                
                const fieldName = targetId === 'reportTo' ? 'Recipients' : 'Subject';
                showReportModalStatus(`${fieldName} Copied!`);
            }

            async function loadEmailConfig() {
                const { data, error } = await supabaseClient.from('cra_email_lists').select('*');
                if (error) {
                    console.error('Failed to load email configuration:', error);
                    // Don't show a breaking alert, just log it. The UI will appear empty.
                    return;
                }

                if (!data) return; // Guard against null data

                // Load recipient lists
                emailLists.rector = data.find(d => d.list_name === 'rector')?.emails || [];
                emailLists.prayer = data.find(d => d.list_name === 'prayer')?.emails || [];
                emailLists.dorm = data.find(d => d.list_name === 'dorm')?.emails || [];
                emailLists.kitchen = data.find(d => d.list_name === 'kitchen')?.emails || [];
                
                // Load general settings from the special 'settings' entry
                // The settings object is stored in the 'emails' column (as JSONB)
                const settingsData = data.find(d => d.list_name === 'settings')?.emails; 
                
                if (settingsData && typeof settingsData === 'object') {
                    setVal('emailFromName', settingsData.from_name);
                    setVal('emailFrom', settingsData.from_email);
                    setVal('emailReply', settingsData.reply_to);
                    setVal('emailBcc', settingsData.bcc);
                } else {
                    // Clear fields if no settings are found
                    setVal('emailFromName', '');
                    setVal('emailFrom', '');
                    setVal('emailReply', '');
                    setVal('emailBcc', '');
                }
                
                renderEmailReportsTable();
            }

            async function saveEmailList(type) {
                const { error } = await supabaseClient
                    .from('cra_email_lists')
                    .upsert({ list_name: type, emails: emailLists[type] }, { onConflict: 'list_name' });

                if (error) {
                    console.error('Error saving email list:', error);
                    alert(`Failed to save ${type} recipient list.`);
                }
            }

            async function addRoleEmailToReportList(reportType, roleToFind, buttonElement) {
                const gender = $('#craEmailFilter .active').dataset.filter;
                const rosterTable = gender === 'men' ? 'men_team_rosters' : 'women_team_rosters';
                const rawTable = gender === 'men' ? 'men_raw' : 'women_raw';

                const originalButtonText = buttonElement.textContent;
                buttonElement.textContent = 'Searching...';
                buttonElement.disabled = true;

                try {
                    // 1. Find the latest weekend identifier
                    const { data: teams, error: teamsError } = await supabaseClient.from(rosterTable).select('weekend_identifier');
                    if (teamsError) throw teamsError;

                    const prefix = gender.charAt(0).toUpperCase() + gender.slice(1) + "'s ";
                    let latest = { number: 0, identifier: null };
                    teams.forEach(team => {
                        const idStr = (team.weekend_identifier || '').trim();
                        if (idStr.startsWith(prefix)) {
                            const num = parseInt(idStr.match(/\d+/)?.[0] || '0', 10);
                            if (num > latest.number) {
                                latest = { number: num, identifier: idStr };
                            }
                        }
                    });

                    if (!latest.identifier) {
                        throw new Error(`No ${gender}'s team roster could be found.`);
                    }

                    // 2. Find the person with the specified role on that team
                    const { data: roleMember, error: roleError } = await supabaseClient
                        .from(rosterTable)
                        .select('pescadore_key')
                        .eq('weekend_identifier', latest.identifier)
                        .eq('role', roleToFind)
                        .limit(1)
                        .single();

                    if (roleError || !roleMember) {
                        throw new Error(`Could not find anyone assigned as "${roleToFind}" on Weekend #${latest.number}.`);
                    }

                    // 3. Get that person's email from the raw data table
                    const { data: profile, error: profileError } = await supabaseClient
                        .from(rawTable)
                        .select('Email')
                        .eq('PescadoreKey', roleMember.pescadore_key)
                        .single();

                    if (profileError || !profile || !profile.Email) {
                        throw new Error(`Found the person, but they do not have an email address on file.`);
                    }

                    // 4. Add the email to the list
                    addRecipient(reportType, profile.Email);

                } catch (error) {
                    console.error('Quick Add Error:', error);
                    alert(`Could not add email: ${error.message}`);
                } finally {
                    buttonElement.textContent = originalButtonText;
                    buttonElement.disabled = false;
                }
            }

            async function addRecipient(type, email) {
                const newEmail = email.trim();
                if (!newEmail || !/^\S+@\S+\.\S+$/.test(newEmail)) {
                    alert('Please enter a valid email address.');
                    return;
                }
                if (!emailLists[type].includes(newEmail)) {
                    emailLists[type].push(newEmail);
                    await saveEmailList(type);
                    renderRecipientList(type);
                    renderEmailReportsTable();
                    $('#recipientNewInput').value = '';
                    $('#recipientNewInput').focus();
                } else {
                    alert('This email address is already in the list.');
                }
            }
            
            async function deleteRecipient(type, emailToDelete) {
                emailLists[type] = emailLists[type].filter(e => e !== emailToDelete);
                await saveEmailList(type);
                renderRecipientList(type);
                renderEmailReportsTable();
            }

            async function saveEmailSettings() {
                 const settingsPayload = {
                    from_name: getVal('emailFromName'),
                    from_email: getVal('emailFrom'),
                    reply_to: getVal('emailReply'),
                    bcc: getVal('emailBcc')
                };

                // Upsert into the 'cra_email_lists' table.
                // We use a special row where list_name is 'settings'.
                // The settings object is stored in the 'emails' column, which should be a JSONB type.
                const { error } = await supabaseClient
                    .from('cra_email_lists')
                    .upsert({ list_name: 'settings', emails: settingsPayload }, { onConflict: 'list_name' });

                if (error) {
                    alert('Error saving email settings: ' + error.message);
                } else {
                    alert('Email settings saved.');
                }
            }

            function resetEmailSettings() {
                showConfirmation(
                    'Reset Settings?',
                    'Are you sure you want to clear and save these empty email settings?',
                    () => {
                        setVal('emailFromName', '');
                        setVal('emailFrom', '');
                        setVal('emailReply', '');
                        setVal('emailBcc', '');
                        saveEmailSettings(); // This will save the empty values
                    }
                );
            }

            return {
                init,
                printCheckinReport, // Expose the new print function
                closeManageRecipientsModal,
                switchView, // Expose the new view switcher
                closeReportModal
            };
        })();


        // ======================================================
        // ============== START: TEAM VIEWER SCRIPT =============
        // ======================================================
        const TV = (function() {
            // State management
            let allPescadores = { men: [], women: [] };
            let filteredPescadores = [];
            let currentProfileIndex = -1;
            let currentGender = 'men'; 
            let nameFormat = 'firstLast';
            let currentTeam = { men: [], women: [] };
            let editMode = false;
        let dataFetchPromise = null;
        let weekendIdentifier = '';
        let pendingChanges = {};

        const EDIT_PASSWORD = "edit";

            // --- REUSABLE CORE FUNCTION to generate the entire printable HTML for one profile ---
            function generatePrintableProfileHTML(profile) {
                // --- Helper function to generate a role item ---
                const createRoleItemHTML = (displayName, status, serviceNumber, quantityNumber) => {
                    const sanitizedStatus = (status || 'N').toUpperCase();
                    return `
                        <div class="role-item">
                            <div class="role-name">${displayName}</div>
                            <div class="role-status-cell">
                                <span class="role-status status-${sanitizedStatus}">${sanitizedStatus}</span>
                            </div>
                            <div class="role-last-cell"><span class="service-number">${serviceNumber || ''}</span></div>
                            <div class="role-qty-cell"><span class="quantity-number">${quantityNumber || ''}</span></div>
                        </div>`;
                };
                
                // --- Helper to generate Rector Qualification Section ---
                const createRectorCriteriaHTML = (person) => {
                    const speakingProfRoles = ROLE_CONFIG.professor.filter(r => r.key !== 'Prof_Silent').map(r => r.key);
                    const allTeamRoles = ROLE_CONFIG.team.map(r => r.key);
                    const hasHeadRole = (person['Head'] === 'E' || person['Asst Head'] === 'E');
                    const hasKitchenHeadRole = (person['Head Kitchen'] === 'E' || person['Asst Head Kitchen'] === 'E');
                    const experiencedProfRoles = ROLE_CONFIG.professor.map(r => r.key).filter(role => person[role] === 'E');
                    const hasTwoProfRoles = experiencedProfRoles.length >= 2;
                    const hasOneSpeakingRole = experiencedProfRoles.some(role => speakingProfRoles.includes(role));
                    const hasProfRequirement = hasTwoProfRoles && hasOneSpeakingRole;
                    const experiencedChaRoles = allTeamRoles.filter(role => person[role] === 'E');
                    const hasTwoChaRoles = experiencedChaRoles.length >= 2;
                    const hasCoreChaRole = experiencedChaRoles.some(role => ['Palanca', 'Chapel', 'Gopher'].includes(role));
                    const hasChaRequirement = hasTwoChaRoles && hasCoreChaRole;

                    const createRectorCriteriaItem = (displayName, status) => `
                        <div class="role-item">
                            <span class="role-name">${displayName}</span>
                            <div class="status-container">
                                <span class="role-status status-${status ? 'E' : 'N'}"></span>
                            </div>
                        </div>`;

                    return `
                        <div class="roles-section">
                            <div class="roles-title">Rector Qualification Criteria</div>
                            <div class="rector-qualification-grid">
                                    <div class="qualification-labels">
                                        <div class="qualification-label">Head / Asst Head</div>
                                        <div class="qualification-label">Head / Asst Kitchen</div>
                                        <div class="qualification-label">2 Prof Roles (1 Speaking)</div>
                                        <div class="qualification-label">2 Cha Roles (1 Timed)</div>
                                    </div>
                                    <div class="segmented-bar-container">
                                        <div class="bar-segment ${hasHeadRole ? 'pass' : 'fail'}"></div>
                                        <div class="bar-segment ${hasKitchenHeadRole ? 'pass' : 'fail'}"></div>
                                        <div class="bar-segment ${hasProfRequirement ? 'pass' : 'fail'}"></div>
                                        <div class="bar-segment ${hasChaRequirement ? 'pass' : 'fail'}"></div>
                                    </div>
                                </div>
                        </div>`;
                };

                // --- Generate HTML for each section ---
                const teamRolesHTML = ROLE_CONFIG.team.map(role => {
                    const status = profile[role.key];
                    const serviceNumber = profile[`${role.key} Service`];
                    const quantityNumber = profile[`${role.key.replace(/ /g, '_')}_Service_Qty`];
                    return createRoleItemHTML(role.name, status, serviceNumber, quantityNumber);
                }).join('');

                const professorRolesHTML = ROLE_CONFIG.professor.map(role => {
                    const status = profile[role.key];
                    const serviceNumber = profile[`${role.key} Service`];
                    const quantityNumber = profile[`${role.key}_Service_Qty`];
                    return createRoleItemHTML(role.name, status, serviceNumber, quantityNumber);
                }).join('');
                
                const rectorCriteriaHTML = createRectorCriteriaHTML(profile);

                // Add classes for Do Not Call / Deceased
                const isDeceased = profile.Deceased === true || (profile.Deceased || '').toLowerCase() === 'y' || (profile.Deceased || '').toLowerCase() === 'yes';
                const isDoNotCall = profile.Do_Not_Call === true || (profile.Do_Not_Call || '').toLowerCase() === 'y' || (profile.Do_Not_Call || '').toLowerCase() === 'yes';
                let statusClasses = '';
                if (isDeceased) statusClasses = ' deceased';
                else if (isDoNotCall) statusClasses = ' do-not-call';


                return `
                    <div class="profile-main-info${statusClasses}">
                        <div class="profile-header">
                            <h2 class="profile-name">${profile.First || ''} ${profile.Last || ''}</h2>
                            ${profile["Candidate Weekend"] ? `<span class="profile-weekend-info">Candidate: <span class="last-served-highlight">${profile["Candidate Weekend"]}</span></span>` : ''}
                            ${profile["Last weekend worked"] ? `<span class="profile-weekend-info">Last Served: <span class="last-served-highlight">${profile["Last weekend worked"]}</span></span>` : ''}
                        </div>
                        <div class="main-info-item"><span class="main-info-label">Address:</span><span>${profile.Address || ''}, ${profile.City || ''}, ${profile.State || ''} ${profile.Zip || ''}</span></div>
                        <div class="main-info-item"><span class="main-info-label">Church:</span><span>${profile.Church || 'N/A'}</span></div>
                        <div class="main-info-item"><span class="main-info-label">Email:</span><span>${profile.Email || 'N/A'}</span></div>
                        <div class="main-info-item"><span class="main-info-label">Phone:</span><span>${profile.Phone1 || 'N/A'}</span></div>
                    </div>
                    ${rectorCriteriaHTML}
                    <div class="legend">
                        <div class="legend-item"><div class="legend-color status-N"></div><span>N - Never Worked</span></div>
                        <div class="legend-item"><div class="legend-color status-I"></div><span>I - Inexperienced</span></div>
                        <div class="legend-item"><div class="legend-color status-E"></div><span>E - Experienced</span></div>
                    </div>
                    <div class="roles-section">
                        <div class="roles-title">Team Roles</div>
                        <div class="role-header-legend team-headers">
                            ${Array(3).fill('<div class="role-header-set"><div class="role-header-name">Role</div><div class="role-header-status">Status</div><div class="role-header-last">Last</div><div class="role-header-qty">Qty</div></div>').join('')}
                        </div>
                        <div class="role-grid team-grid">${teamRolesHTML}</div>
                    </div>
                    <div class="roles-section">
                        <div class="roles-title">Professor Roles</div>
                         <div class="role-header-legend professor-headers">
                            ${Array(2).fill('<div class="role-header-set"><div class="role-header-name">Role</div><div class="role-header-status">Status</div><div class="role-header-last">Last</div><div class="role-header-qty">Qty</div></div>').join('')}
                        </div>
                        <div class="role-grid professor-grid">${professorRolesHTML}</div>
                    </div>
                `;
            }

        // DOM element cache
            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);

            // Role definitions - Mapped to the exact keys from the database object
            const ROLE_CONFIG = {
                team: [
                    { name: 'Rector', key: 'Rector' },
                    { name: 'BUR', key: 'BUR' },
                    { name: 'Rover', key: 'Rover' },
                    { name: 'Head', key: 'Head' },
                    { name: 'Asst Head', key: 'Asst Head' },
                    { name: 'Head Spiritual Director', key: 'Head Spiritual Director' },
                    { name: 'Spiritual Director', key: 'Spiritual Director' },
                    { name: 'Head Prayer', key: 'Head Prayer' },
                    { name: 'Prayer', key: 'Prayer' },
                    { name: 'Head Kitchen', key: 'Head Kitchen' },
                    { name: 'Asst Head Kitchen', key: 'Asst Head Kitchen' },
                    { name: 'Kitchen', key: 'Kitchen' },
                    { name: 'Head Table', key: 'Head Table' },
                    { name: 'Table', key: 'Table' },
                    { name: 'Head Chapel', key: 'Head Chapel' },
                    { name: 'Chapel', key: 'Chapel' },
                    { name: 'Head Dorm', key: 'Head Dorm' },
                    { name: 'Dorm', key: 'Dorm' },
                    { name: 'Head Palanca', key: 'Head Palanca' },
                    { name: 'Palanca', key: 'Palanca' },
                    { name: 'Head Gopher', key: 'Head Gopher' },
                    { name: 'Gopher', key: 'Gopher' },
                    { name: 'Head Storeroom', key: 'Head Storeroom' },
                    { name: 'Storeroom', key: 'Storeroom' },
                    { name: 'Head Floater Supply', key: 'Head Floater Supply' },
                    { name: 'Floater Supply', key: 'Floater Supply' },
                    { name: 'Head Worship', key: 'Head Worship' },
                    { name: 'Worship', key: 'Worship' },
                    { name: 'Head Media', key: 'Head Media' },
                    { name: 'Media', key: 'Media' }
                ],
                professor: [
                    { name: 'Silent', key: 'Prof_Silent' },
                    { name: 'Ideals', key: 'Prof_Ideals' },
                    { name: 'Church', key: 'Prof_Church' },
                    { name: 'Piety', key: 'Prof_Piety' },
                    { name: 'Study', key: 'Prof_Study' },
                    { name: 'Action', key: 'Prof_Action' },
                    { name: 'Leaders', key: 'Prof_Leaders' },
                    { name: 'Environments', key: 'Prof_Environments' },
                    { name: 'CCIA', key: 'Prof_CCIA' },
                    { name: 'Reunion', key: 'Prof_Reunion' }
                ]
            };
            
            // A master list of role names in their intended sort order.
            const allRoleDisplayNames = [
                ...ROLE_CONFIG.team.map(r => r.name),
                ...ROLE_CONFIG.professor.map(r => r.name)
            ];

            // Initialization
            function init() {
                console.log("Team Viewer Initializing...");
                dataFetchPromise = fetchDataFromSupabase(); // Start fetching data immediately and store the promise
                renderWhenReady(); // This ensures the initial view renders after data is fetched.
                
                // Initialize custom dropdowns
                $$('.dropdown-container').forEach(setupDropdown);

                 $('#teamListGenderToggle')?.addEventListener('click', e => {
                    const opt = e.target.closest('.opt');
                    if (!opt) return;
                    loadTeamByGender(opt.dataset.gender, opt);
                });
            }

            // Public functions will be returned at the end.
            // Private functions (helpers) will be defined here.

            // --- NEW: Custom Dropdown Logic ---
            function setupDropdown(dropdown) {
                const btn = dropdown.querySelector('.dropdown-btn');
                const content = dropdown.querySelector('.dropdown-content');

                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (btn.classList.contains('disabled')) return;
                    
                    // Close all other dropdowns before opening this one
                    $$('.dropdown-container.open').forEach(other => {
                        if (other !== dropdown) other.classList.remove('open');
                    });
                    
                    dropdown.classList.toggle('open');
                });

                content.addEventListener('click', (e) => {
                    e.preventDefault();
                    const link = e.target.closest('a');
                    if (link) {
                        const value = link.dataset.value;
                        
                        // Update UI
                        btn.textContent = link.textContent;
                        content.querySelectorAll('a').forEach(a => a.classList.remove('selected'));
                        link.classList.add('selected');
                        
                        // Store the value
                        dropdown.dataset.selectedValue = value;

                        // Trigger search
                        performSearch();
                        
                        dropdown.classList.remove('open');
                    }
                });
            }

            document.addEventListener('click', () => {
                $$('.dropdown-container.open').forEach(d => d.classList.remove('open'));
            });
            // --- END: Custom Dropdown Logic ---

            function selectGender(gender, element) {
                currentGender = gender;
                const container = element.parentElement;
                container.querySelectorAll('.toggle-inset-option').forEach(el => el.classList.remove('active'));
                element.classList.add('active');
                
                // --- NEW: Sync the other toggle when this one changes ---
                const listToggle = $('#teamListGenderToggle');
                if (listToggle) {
                    listToggle.querySelectorAll('.opt').forEach(opt => {
                        opt.classList.toggle('active', opt.dataset.gender === gender);
                    });
                }
                // --- END NEW ---
                
                // Safely update gender display in modals, checking if the element exists first.
                const teamDisplay = $('#teamGenderDisplay');
                if (teamDisplay) teamDisplay.textContent = gender.charAt(0).toUpperCase() + gender.slice(1);
                
                const teamIndicator = $('#teamGenderIndicator');
                if (teamIndicator) teamIndicator.textContent = `${gender.charAt(0).toUpperCase() + gender.slice(1)}'s Team`;
                
                const badgeIndicator = $('#badgeGenderIndicator');
                if (badgeIndicator) badgeIndicator.textContent = `${gender.charAt(0).toUpperCase() + gender.slice(1)}'s Team Badges`;

                // FIX: Clear existing filters when toggling gender. This prevents
                // applying a filter that might yield no results for the new list.
                $('#nameSearch').value = '';
                $('#sortSelect').selectedIndex = 0;
                $('#secondarySortSelect').selectedIndex = 0;

                performSearch();
                updateTeamUI();
            }

            async function loadTeamByGender(gender, element) {
                currentGender = gender;

                // Sync UI for the toggle that was clicked
                const container = element.parentElement;
                container.querySelectorAll('.opt').forEach(el => el.classList.remove('active'));
                element.classList.add('active');

                // Sync the other toggle on the Directory page
                const directoryToggle = $('#genderToggleContainer');
                if (directoryToggle) {
                    directoryToggle.querySelectorAll('.toggle-inset-option').forEach(el => el.classList.remove('active'));
                    const dirOpt = directoryToggle.querySelector(`.toggle-inset-option[onclick*="'${gender}'"]`);
                    if (dirOpt) dirOpt.classList.add('active');
                }

                const grid = $('#teamListGrid');
                grid.innerHTML = '<div class="progress-bar-container"><div class="progress-bar-label">Loading Roster...</div><div class="progress-bar-track"><div class="progress-bar-fill"></div></div></div>';

                const rosterTable = gender === 'men' ? 'men_team_rosters' : 'women_team_rosters';
                const { data: teams, error } = await supabaseClient.from(rosterTable).select('weekend_identifier');

                if (error) {
                    showNotification('Error', `Failed to fetch team list: ${error.message}`);
                    grid.innerHTML = `<p style="text-align:center; color: var(--accentD);">Error loading team list.</p>`;
                    return;
                }

                const prefix = gender.charAt(0).toUpperCase() + gender.slice(1) + "'s ";
                let latest = { number: 0, identifier: null };

                (teams || []).forEach(team => {
                    const idStr = (team.weekend_identifier || '').trim();
                    if (idStr.startsWith(prefix)) {
                        const num = parseInt(idStr.match(/\d+/)?.[0] || '0', 10);
                        if (num > latest.number) {
                            latest = { number: num, identifier: idStr };
                        }
                    }
                });

                if (latest.identifier) {
                    weekendIdentifier = latest.identifier;
                    await loadTeamRoster();
                } else {
                    weekendIdentifier = '';
                    currentTeam[gender] = [];
                    renderTeamListPage(); // This will clear the grid and show correct titles/empty state
                }
            }

            function selectNameFormat(format, element){
                nameFormat = format;
                const container = element.parentElement;
                container.querySelectorAll('.toggle-inset-option').forEach(el => el.classList.remove('active'));
                element.classList.add('active');
                renderNamesGrid();
            }

            async function fetchDataFromSupabase() {
                // This function now only fetches data and populates the state.
                // It no longer calls performSearch().
                showLoadingState(true, "Fetching latest data from Supabase...");
                try {
                    const { data: menData, error: menError } = await supabaseClient.from('men_raw').select('*').eq('org_id', currentUserOrgId);
                    if (menError) throw menError;
                    allPescadores.men = menData;

                    const { data: womenData, error: womenError } = await supabaseClient.from('women_raw').select('*').eq('org_id', currentUserOrgId);
                    if (womenError) throw womenError;
                    allPescadores.women = womenData;
                    
                    $('#lastUpdated').textContent = `Data last refreshed: ${new Date().toLocaleString()}`;
                } catch (error) {
                    console.error("Error fetching data:", error);
                    showLoadingState(true, "Error fetching data. Please try again.");
                } finally {
                   showLoadingState(false);
                }
            }
            
            function performSearch() {
                const searchTerm = $('#nameSearch').value.toLowerCase();
                const primaryFilter = $('#primaryFilterDropdown').dataset.selectedValue;
                const secondarySort = $('#secondaryFilterDropdown').dataset.selectedValue;

                // Enable/disable secondary sort based on primary filter
                const secondaryBtn = $('#secondaryFilterDropdown .dropdown-btn');
                if (primaryFilter) {
                    secondaryBtn.classList.remove('disabled');
                } else {
                    secondaryBtn.classList.add('disabled');
                }

                let data = [...allPescadores[currentGender]];

                // 1. Apply search term filter
                if (searchTerm) {
                    const serviceKeys = [
                        ...ROLE_CONFIG.team.map(r => ({ dbKey: `${r.key} Service`, displayName: r.name })),
                        ...ROLE_CONFIG.professor.map(r => ({ dbKey: `${r.key} Service`, displayName: r.name }))
                    ];

                    data = data.filter(p => {
                        // Always clear previous search match info from the object
                        delete p.searchMatch;

                        // Check against name fields first. If it matches, we're done with this person.
                        const searchableName = `${p.First || ''} ${p.Last || ''} ${p.Preferred || ''}`.toLowerCase();
                        if (searchableName.includes(searchTerm)) {
                            return true;
                        }

                        // Check against Candidate Weekend field. If it matches, tag it and we're done.
                        const candidateWeekend = (p["Candidate Weekend"] || '').toString().toLowerCase();
                        if (candidateWeekend.includes(searchTerm)) {
                            p.searchMatch = { type: 'candidate' };
                            return true;
                        }

                        // Check against all '... Service' fields. If one matches, tag it and stop checking for this person.
                        for (const role of serviceKeys) {
                            const serviceValue = (p[role.dbKey] || '').toString().toLowerCase();
                            if (serviceValue.includes(searchTerm)) {
                                p.searchMatch = { type: 'service', role: role.displayName };
                                return true;
                            }
                        }

                        return false;
                    });
                } else {
                    // If the search term is empty, ensure all labels are cleared from the data.
                    data.forEach(p => delete p.searchMatch);
                }
                
                // 2. Apply primary filter
                switch (primaryFilter) {
                    case 'recent':
                        // This is a sort, not a filter, handled below.
                        break;
                    case 'never-served':
                        data = data.filter(p => !p["Last weekend worked"]);
                        break;
                    case 'spiritual-director-qualified':
                        data = data.filter(p => p['Spiritual Director'] === 'E');
                        break;
                    case 'role-rector-e':
                        data = data.filter(p => p['Rector'] === 'E');
                        break;
                    case 'rector-qualified':
                        data = data.filter(p => getRectorQualificationStatus(p) === 4);
                        break;
                    case 'rector-qualified-minus-1':
                        data = data.filter(p => getRectorQualificationStatus(p) === 3);
                        break;
                    case 'rector-qualified-minus-2':
                        data = data.filter(p => getRectorQualificationStatus(p) === 2);
                        break;
                    case 'head-asst-head-qualified':
                        data = data.filter(p => p['Head'] === 'E' || p['Asst Head'] === 'E');
                        break;
                    case 'kitchen-qualified':
                        data = data.filter(p => p['Head Kitchen'] === 'E' || p['Asst Head Kitchen'] === 'E');
                        break;
                    case 'bur-qualified':
                        data = data.filter(p => p['BUR'] === 'E');
                        break;
                    case 'dorm-qualified':
                        data = data.filter(p => p['Head Dorm'] === 'E');
                        break;
                    case 'prayer-qualified':
                        data = data.filter(p => p['Head Prayer'] === 'E');
                        break;
                    case 'chapel-qualified':
                        data = data.filter(p => p['Head Chapel'] === 'E');
                        break;
                    case 'table-qualified':
                        data = data.filter(p => p['Head Table'] === 'E');
                        break;
                    case 'worship-qualified':
                        data = data.filter(p => p['Head Worship'] === 'E');
                        break;
                    case 'palanca-qualified':
                        data = data.filter(p => p['Head Palanca'] === 'E');
                        break;
                    case 'gopher-qualified':
                        data = data.filter(p => p['Head Gopher'] === 'E');
                        break;
                    case 'storeroom-qualified':
                        data = data.filter(p => p['Head Storeroom'] === 'E');
                        break;
                    case 'floater-supply-qualified':
                        data = data.filter(p => p['Head Floater Supply'] === 'E');
                        break;
                }

                // 3. Apply Sorting (Combined Primary and Secondary)
                const parseWeekendNumber = (str) => {
                    if (!str) return 0;
                    const match = str.match(/\d+$/);
                    return match ? parseInt(match[0], 10) : 0;
                };

                data.sort((a, b) => {
                    // Primary sorting criteria: candidates always come first.
                    const aIsCandidate = a.searchMatch && a.searchMatch.type === 'candidate';
                    const bIsCandidate = b.searchMatch && b.searchMatch.type === 'candidate';

                    if (aIsCandidate && !bIsCandidate) return -1; // a comes first
                    if (!aIsCandidate && bIsCandidate) return 1;  // b comes first

                    // Secondary criteria: if both are service matches, sort by role order.
                    const aIsService = a.searchMatch && a.searchMatch.type === 'service';
                    const bIsService = b.searchMatch && b.searchMatch.type === 'service';

                    if (aIsService && bIsService) {
                        const aRoleIndex = allRoleDisplayNames.indexOf(a.searchMatch.role);
                        const bRoleIndex = allRoleDisplayNames.indexOf(b.searchMatch.role);
                        if (aRoleIndex !== bRoleIndex) {
                            return (aRoleIndex > -1 ? aRoleIndex : 999) - (bRoleIndex > -1 ? bRoleIndex : 999);
                        }
                    }

                    // Fallback sort: If roles are the same or it's not a service search, use the user's selected sort order.
                    switch (secondarySort) {
                        case 'alpha-asc':
                            return (a.Last || '').localeCompare(b.Last || '');
                        case 'alpha-desc':
                            return (b.Last || '').localeCompare(a.Last || '');
                        case 'weekend-desc':
                            return parseWeekendNumber(b["Last weekend worked"]) - parseWeekendNumber(a["Last weekend worked"]);
                        case 'weekend-asc':
                            return parseWeekendNumber(a["Last weekend worked"]) - parseWeekendNumber(b["Last weekend worked"]);
                        default:
                            if (primaryFilter === 'recent') {
                                return parseWeekendNumber(b["Last weekend worked"]) - parseWeekendNumber(a["Last weekend worked"]);
                            } else {
                                // Default sort if no secondary is chosen is alphabetical by last name
                                return (a.Last || '').localeCompare(b.Last || '');
                            }
                    }
                });
                
                filteredPescadores = data;
                renderNamesGrid();
            }
            
            function renderNamesGrid() {
                const grid = $('#namesGrid');
                grid.innerHTML = '';
                $('#directoryCount').textContent = `${filteredPescadores.length} results`;

                if(filteredPescadores.length === 0){
                    grid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #666;">No results found.</p>';
                    return;
                }

                const rowsNeeded = Math.ceil(filteredPescadores.length / 4);
                grid.style.gridTemplateRows = `repeat(${rowsNeeded}, auto)`;

                filteredPescadores.forEach((p, index) => {
                    const box = document.createElement('div');
                    box.className = 'name-box';
                    const displayName = nameFormat === 'firstLast' 
                        ? `${p.Preferred || p.First || ''} ${p.Last || ''}` 
                        : `${p.Last || ''}, ${p.Preferred || p.First || ''}`;

                    if (p.searchMatch) {
                        box.classList.add('enhanced-search-result');
                        let badgeClass = '';
                        let badgeText = '';

                        if (p.searchMatch.type === 'candidate') {
                            badgeClass = 'candidate';
                            badgeText = 'Candidate';
                        } else if (p.searchMatch.type === 'service') {
                            badgeClass = 'service';
                            badgeText = p.searchMatch.role;
                        }
                        
                        box.innerHTML = `
                            <div class="name-section">${displayName}</div>
                            <div class="search-match-badge ${badgeClass}">${badgeText}</div>
                        `;
                    } else {
                        box.textContent = displayName;
                    }

                    box.onclick = () => showProfile(index);
                    grid.appendChild(box);
                });
            }
            
            function showProfile(index) {
                currentProfileIndex = index;
                $('#directoryView').style.display = 'none';
                $('#profileView').style.display = 'block';
                renderProfile();
            }

            function showDirectory() {
                $('#profileView').style.display = 'none';
                $('#directoryView').style.display = 'block';
                currentProfileIndex = -1;
            }
                function renderProfile() {
                if(currentProfileIndex < 0 || currentProfileIndex >= filteredPescadores.length) {
                    showDirectory();
                    return;
                }
                
                const profile = filteredPescadores[currentProfileIndex];
                const container = $('#profileContainer');
                container.classList.toggle('edit-mode', editMode);
                
                $('#profileCounter').textContent = `${currentProfileIndex + 1} of ${filteredPescadores.length}`;
                $('#prevButton').disabled = currentProfileIndex === 0;
                $('#nextButton').disabled = currentProfileIndex === filteredPescadores.length - 1;

                const candidateWeekend = profile["Candidate Weekend"] || '';
                const lastWorked = profile["Last weekend worked"] || '';
                
                // Prepare values for display or editing
                const email = profile.Email || '';
                const phone = profile.Phone1 || '';
                const address = `${profile.Address || ''}, ${profile.City || ''}, ${profile.State || ''} ${profile.Zip || ''}`.trim() === ',' ? '' : `${profile.Address || ''}, ${profile.City || ''}, ${profile.State || ''} ${profile.Zip || ''}`;
                const church = profile.Church || '';
                const displayName = profile.Preferred || profile.First || '';
                const fullName = `${displayName} ${profile.Last || ''}`;
                const legalNameBadgeHTML = profile.Preferred && profile.Preferred.trim() !== '' && profile.Preferred !== profile.First ? `<span class="legal-name-badge">Actual: ${profile.First || ''}</span>` : '';

                const createEditableInput = (id, value, placeholder) => `<input type="text" id="${id}" class="editable-field" value="${value}" placeholder="${placeholder}">`;

                const createRoleItemHTML = (displayName, status, roleKey, serviceNumber, quantityNumber) => {
                    const sanitizedStatus = (status || 'N').toUpperCase();
                    const onclickHandler = editMode ? `onclick="TV.cycleRoleStatus(this)"` : '';
                    
                    // Construct the database field names correctly
                    const serviceField = `${roleKey} Service`;
                    const quantityField = `${roleKey.replace(/ /g, '_')}_Service_Qty`;

                    const lastCellHTML = editMode
                        ? `<input type="text" class="editable-field" data-field="${serviceField}" value="${serviceNumber || ''}">`
                        : `<span class="service-number">${serviceNumber || ''}</span>`;
                        
                    const qtyCellHTML = editMode
                        ? `<input type="number" class="editable-field" data-field="${quantityField}" value="${quantityNumber || ''}">`
                        : `<span class="quantity-number">${quantityNumber || ''}</span>`;

                    return `
                        <div class="role-item">
                            <div class="role-name">${displayName}</div>
                            <div class="role-status-cell">
                                <span class="role-status status-${sanitizedStatus}" data-field="${roleKey}" ${onclickHandler}>${sanitizedStatus}</span>
                            </div>
                            <div class="role-last-cell">${lastCellHTML}</div>
                            <div class="role-qty-cell">${qtyCellHTML}</div>
                        </div>
                    `;
                };

                const teamRolesHTML = ROLE_CONFIG.team.map(role => {
                    const status = profile[role.key];
                    const serviceNumber = profile[`${role.key} Service`];
                    const quantityNumber = profile[`${role.key.replace(/ /g, '_')}_Service_Qty`];
                    return createRoleItemHTML(role.name, status, role.key, serviceNumber, quantityNumber);
                }).join('');

                const professorRolesHTML = ROLE_CONFIG.professor.map(role => {
                    const status = profile[role.key];
                    const serviceNumber = profile[`${role.key} Service`];
                    const quantityNumber = profile[`${role.key}_Service_Qty`];
                    return createRoleItemHTML(role.name, status, role.key, serviceNumber, quantityNumber);
                }).join('');
                
                let headerHTML;
                if (editMode) {
                    // Header is now just a container, inputs are moved to the main grid
                    headerHTML = `<div class="profile-header"></div>`;
                } else {
                    headerHTML = `
                        <div class="profile-header">
                            <div style="display: flex; align-items: center; flex-wrap: wrap;">
                                <h2 class="profile-name">${fullName}</h2>
                                ${legalNameBadgeHTML}
                                ${(candidateWeekend || lastWorked) ? `<span class="name-separator"></span>` : ''}
                                ${candidateWeekend ? `<span class="profile-weekend-info">Candidate: <span class="last-served-highlight">${candidateWeekend}</span></span>` : ''}
                                ${lastWorked ? `<span class="profile-weekend-info">Last Served: <span class="last-served-highlight">${lastWorked}</span></span>` : ''}
                            </div>
                        </div>`;
                }
                
                const mainInfoHTML = editMode ? `
                    <div class="main-info-item">
                        <span class="main-info-label">First Name:</span>
                        <span class="main-info-value">${createEditableInput('edit-first', profile.First || '', 'First Name')}</span>
                    </div>
                     <div class="main-info-item">
                        <span class="main-info-label">Preferred Name:</span>
                        <span class="main-info-value">${createEditableInput('edit-preferred', profile.Preferred || '', 'Preferred Name')}</span>
                    </div>
                    <div class="main-info-item">
                        <span class="main-info-label">Last Name:</span>
                        <span class="main-info-value">${createEditableInput('edit-last', profile.Last || '', 'Last Name')}</span>
                    </div>
                    <div class="main-info-item full-width-item">
                        <span class="main-info-label">Address:</span>
                        <span class="main-info-value">${createEditableInput('edit-address', profile.Address || '', 'Street Address')}</span>
                    </div>
                    <div class="main-info-item">
                        <span class="main-info-label">City:</span>
                        <span class="main-info-value">${createEditableInput('edit-city', profile.City || '', 'City')}</span>
                    </div>
                    <div class="main-info-item">
                        <span class="main-info-label">State:</span>
                        <span class="main-info-value">${createEditableInput('edit-state', profile.State || '', 'ST')}</span>
                    </div>
                    <div class="main-info-item">
                        <span class="main-info-label">Zip:</span>
                        <span class="main-info-value">${createEditableInput('edit-zip', profile.Zip || '', 'Zip Code')}</span>
                    </div>
                    <div class="main-info-item full-width-item">
                        <span class="main-info-label">Church:</span>
                        <span class="main-info-value">${createEditableInput('edit-church', church, 'Church Name')}</span>
                    </div>
                    <div class="main-info-item full-width-item">
                        <span class="main-info-label">Email:</span>
                        <span class="main-info-value">${createEditableInput('edit-email', email, 'Email Address')}</span>
                    </div>
                    <div class="main-info-item">
                        <span class="main-info-label">Phone:</span>
                        <span class="main-info-value">${createEditableInput('edit-phone', phone, 'Phone Number')}</span>
                    </div>
                    <div class="main-info-item">
                        <span class="main-info-label">Do Not Call:</span>
                        <span class="main-info-value">
                            <select id="edit-do-not-call" class="editable-field" data-field="Do_Not_Call" style="width: 100%; padding: 6px 10px; border-radius: 4px; border: 1px solid #007bff;">
                                <option value="false" ${!(profile.Do_Not_Call === true || (profile.Do_Not_Call || '').toLowerCase() === 'y' || (profile.Do_Not_Call || '').toLowerCase() === 'yes') ? 'selected' : ''}>Call</option>
                                <option value="true" ${profile.Do_Not_Call === true || (profile.Do_Not_Call || '').toLowerCase() === 'y' || (profile.Do_Not_Call || '').toLowerCase() === 'yes' ? 'selected' : ''}>Do not call</option>
                            </select>
                        </span>
                    </div>
                    <div class="main-info-item">
                        <span class="main-info-label">Deceased:</span>
                        <span class="main-info-value">
                           <select id="edit-deceased" class="editable-field" data-field="Deceased" style="width: 100%; padding: 6px 10px; border-radius: 4px; border: 1px solid #007bff;">
                                <option value="false" ${!(profile.Deceased === true || (profile.Deceased || '').toLowerCase() === 'y' || (profile.Deceased || '').toLowerCase() === 'yes') ? 'selected' : ''}>No</option>
                                <option value="true" ${profile.Deceased === true || (profile.Deceased || '').toLowerCase() === 'y' || (profile.Deceased || '').toLowerCase() === 'yes' ? 'selected' : ''}>Yes</option>
                            </select>
                        </span>
                    </div>
                ` : `
                    <div class="main-info-item">
                        <span class="main-info-label">Address:</span>
                        <span class="main-info-value">${address || 'N/A'}</span>
                    </div>
                     <div class="main-info-item">
                        <span class="main-info-label">Church:</span>
                        <span class="main-info-value">${church || 'N/A'}</span>
                    </div>
                     <div class="main-info-item">
                        <span class="main-info-label">Email:</span>
                        <span class="main-info-value">${email || 'N/A'}</span>
                    </div>
                    <div class="main-info-item">
                        <span class="main-info-label">Phone:</span>
                        <span class="main-info-value">${phone || 'N/A'}</span>
                    </div>
                `;

                // Add logic to apply status classes for Deceased and Do Not Call
                const isDeceased = profile.Deceased === true || (profile.Deceased || '').toLowerCase() === 'y' || (profile.Deceased || '').toLowerCase() === 'yes';
                const isDoNotCall = profile.Do_Not_Call === true || (profile.Do_Not_Call || '').toLowerCase() === 'y' || (profile.Do_Not_Call || '').toLowerCase() === 'yes';
                const isSpiritualDirector = (profile['Spiritual Director'] || 'N').toUpperCase() === 'E';

                let statusClasses = '';
                if (isSpiritualDirector) {
                    statusClasses += ' is-spiritual-director';
                }

                // Deceased status takes precedence over Do Not Call for the main indicator style
                if (isDeceased) {
                    statusClasses += ' deceased';
                } else if (isDoNotCall) {
                    statusClasses += ' do-not-call';
                }

                const createRectorCriteriaHTML = (person) => {
                    const speakingProfRoles = ROLE_CONFIG.professor.filter(r => r.key !== 'Prof_Silent').map(r => r.key);
                    const allTeamRoles = ROLE_CONFIG.team.map(r => r.key);
                    const hasHeadRole = (person['Head'] === 'E' || person['Asst Head'] === 'E');
                    const hasKitchenHeadRole = (person['Head Kitchen'] === 'E' || person['Asst Head Kitchen'] === 'E');
                    const experiencedProfRoles = ROLE_CONFIG.professor.map(r => r.key).filter(role => person[role] === 'E');
                    const hasTwoProfRoles = experiencedProfRoles.length >= 2;
                    const hasOneSpeakingRole = experiencedProfRoles.some(role => speakingProfRoles.includes(role));
                    const hasProfRequirement = hasTwoProfRoles && hasOneSpeakingRole;
                    const experiencedChaRoles = allTeamRoles.filter(role => person[role] === 'E');
                    const hasTwoChaRoles = experiencedChaRoles.length >= 2;
                    const hasCoreChaRole = experiencedChaRoles.some(role => ['Palanca', 'Chapel', 'Gopher'].includes(role));
                    const hasChaRequirement = hasTwoChaRoles && hasCoreChaRole;

                    const createRectorCriteriaItem = (displayName, status) => `
                        <div class="role-item">
                            <span class="role-name">${displayName}</span>
                            <div class="status-container">
                                <span class="role-status status-${status ? 'E' : 'N'}"></span>
                            </div>
                        </div>`;

                    return `
                        <div class="card pad">
                            <div class="roles-section">
                                <div class="roles-title" style="margin-bottom: 12px;">Rector Qualification</div>
                                <div class="rector-qualification-grid">
                                    <div class="qualification-labels">
                                        <div class="qualification-label">Head / Asst Head</div>
                                        <div class="qualification-label">Head / Asst Kitchen</div>
                                        <div class="qualification-label">2 Prof Roles (1 Speaking)</div>
                                        <div class="qualification-label">2 Cha Roles (1 Timed)</div>
                                    </div>
                                    <div class="segmented-bar-container">
                                        <div class="bar-segment ${hasHeadRole ? 'pass' : 'fail'}"></div>
                                        <div class="bar-segment ${hasKitchenHeadRole ? 'pass' : 'fail'}"></div>
                                        <div class="bar-segment ${hasProfRequirement ? 'pass' : 'fail'}"></div>
                                        <div class="bar-segment ${hasChaRequirement ? 'pass' : 'fail'}"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                };

                const rectorCriteriaHTML = createRectorCriteriaHTML(profile);

                container.innerHTML = `
                    <div class="card pad profile-main-info${statusClasses}">
                        ${headerHTML}
                        ${mainInfoHTML}
                    </div>
                    
                    ${rectorCriteriaHTML}

                    <div class="card pad">
                        <div class="roles-section">
                            <div class="roles-header-container">
                                <div class="roles-title">Team Roles</div>
                                <div class="legend">
                                    <div class="legend-item"><div class="legend-color status-N"></div><span>Never</span></div>
                                    <div class="legend-item"><div class="legend-color status-I"></div><span>Inexp.</span></div>
                                    <div class="legend-item"><div class="legend-color status-E"></div><span>Exp.</span></div>
                                </div>
                            </div>
                            <div class="role-header-legend team-headers">
                                ${Array(3).fill('<div class="role-header-set"><div class="role-header-name">Role</div><div class="role-header-status">Status</div><div class="role-header-last">Last</div><div class="role-header-qty">Qty</div></div>').join('')}
                            </div>
                            <div class="role-grid">${teamRolesHTML}</div>
                        </div>
                    </div>
                    
                    <div class="card pad">
                        <div class="roles-section">
                            <div class="roles-header-container">
                                <div class="roles-title">Professor Roles</div>
                                <div class="legend">
                                    <div class="legend-item"><div class="legend-color status-N"></div><span>Never</span></div>
                                    <div class="legend-item"><div class="legend-color status-I"></div><span>Inexp.</span></div>
                                    <div class="legend-item"><div class="legend-color status-E"></div><span>Exp.</span></div>
                                </div>
                            </div>
                            <div class="role-header-legend professor-headers">
                                ${Array(2).fill('<div class="role-header-set"><div class="role-header-name">Role</div><div class="role-header-status">Status</div><div class="role-header-last">Last</div><div class="role-header-qty">Qty</div></div>').join('')}
                            </div>
                            <div class="role-grid professor-grid">${professorRolesHTML}</div>
                        </div>
                    </div>
                `;
            }

            function navigateProfile(direction) {
                const newIndex = currentProfileIndex + direction;
                if (newIndex >= 0 && newIndex < filteredPescadores.length) {
                    showProfile(newIndex);
                }
            }

            function clearSearch(){
                $('#nameSearch').value = '';
                
                // Reset the custom primary dropdown
                const primaryDropdown = $('#primaryFilterDropdown');
                const primaryBtn = primaryDropdown.querySelector('.dropdown-btn');
                primaryDropdown.dataset.selectedValue = '';
                primaryBtn.textContent = 'Select Primary Filter...';
                primaryDropdown.querySelectorAll('.dropdown-content a').forEach(a => a.classList.remove('selected'));
                primaryDropdown.querySelector('a[data-value=""]').classList.add('selected');
                
                // Reset the custom secondary dropdown
                const secondaryDropdown = $('#secondaryFilterDropdown');
                const secondaryBtn = secondaryDropdown.querySelector('.dropdown-btn');
                secondaryDropdown.dataset.selectedValue = 'alpha-asc';
                secondaryBtn.textContent = 'Select Sort Order...';
                secondaryDropdown.querySelectorAll('.dropdown-content a').forEach(a => a.classList.remove('selected'));
                secondaryDropdown.querySelector('a[data-value="alpha-asc"]').classList.add('selected');

                performSearch();
            }

            function printReport() {
                if (filteredPescadores.length === 0) {
                    showNotification('No Results', 'There are no names in the directory to print.');
                    return;
                }

                const genderTitle = currentGender.charAt(0).toUpperCase() + currentGender.slice(1);
                const reportTitle = `${CONFIG.COMMUNITY_NAME} - ${genderTitle}'s Directory Report`;
                const generatedDate = new Date().toLocaleDateString();

                let namesHTML = '';
                filteredPescadores.forEach(p => {
                    const displayName = nameFormat === 'firstLast' ?
                        `${p.Preferred || p.First || ''} ${p.Last || ''}` :
                        `${p.Last || ''}, ${p.Preferred || p.First || ''}`;
                    namesHTML += `<div class="name-item">${displayName.trim()}</div>`;
                });

                const printableHTML = `
                    <div class="printable-header">
                        <h1>${CONFIG.COMMUNITY_NAME}</h1>
                        <h2>${genderTitle}'s Directory - ${filteredPescadores.length} Results</h2>
                        <p>Generated on ${generatedDate}</p>
                    </div>
                    <div class="names-grid-printable">
                        ${namesHTML}
                    </div>
                `;

                const printContainer = document.createElement('div');
                printContainer.id = 'printable-content';
                printContainer.innerHTML = printableHTML;
                document.body.appendChild(printContainer);

                // Define specific styles for the print output
                const printStyles = `
                    .printable-header { text-align: center; margin-bottom: 20px; }
                    .printable-header h1 { font-size: 20px; margin: 0; color: #000; }
                    .printable-header h2 { font-size: 16px; margin: 5px 0; color: #555; font-weight: normal; }
                    .printable-header p { font-size: 12px; color: #888; }
                    .names-grid-printable {
                        display: grid;
                        grid-template-columns: repeat(4, 1fr);
                        grid-auto-flow: row;
                        gap: 8px 12px;
                        font-size: 10pt;
                        color: #000;
                    }
                    .name-item {
                        border-bottom: 1px solid #eee;
                        padding: 4px;
                        page-break-inside: avoid;
                    }
                `;

                printJS({
                    printable: 'printable-content',
                    type: 'html',
                    style: printStyles,
                    documentTitle: reportTitle,
                    onPrintDialogClose: () => document.body.removeChild(printContainer)
                });
            }
            
            function printProfile() {
                if (currentProfileIndex < 0 || currentProfileIndex >= filteredPescadores.length) {
                    showNotification('No Profile Selected', 'Please select a profile to print.');
                    return;
                }
                const profile = filteredPescadores[currentProfileIndex];
                
                    const singleProfileHTML = generatePrintableProfileHTML(profile);

                const printableHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Profile Report for ${profile.First} ${profile.Last}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 0; font-size: 10pt; color: #333; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            .page-container { padding: 0.2in; }
                            .profile-main-info, .roles-section { page-break-inside: avoid; }
                            .profile-main-info { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #dee2e6; }
                            .profile-header { display: flex; align-items: baseline; flex-wrap: wrap; margin-bottom: 10px; }
                            .profile-name { font-size: 22pt; font-weight: bold; margin: 0 15px 0 0; }
                            .profile-weekend-info { font-size: 0.8em; font-weight: 600; margin-left: 10px; }
                            .last-served-highlight { background-color: #ffc107; padding: 2px 6px; border-radius: 3px; font-weight: bold; color: #333; }
                            .main-info-item { margin: 4px 0; display: flex; }
                            .main-info-label { font-weight: bold; width: 100px; flex-shrink: 0; }
                            .roles-section { margin-top: 15px; }
                            .roles-title { font-weight: bold; margin-bottom: 10px; font-size: 14pt; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
                            .role-grid { display: grid; grid-auto-flow: column; gap: 10px; }
                            .team-grid { grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(10, auto); }
                            .professor-grid { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(5, auto); }
                            .role-header-set { display: grid; grid-template-columns: 60% 15% 15% 10%; gap: 2px; }
                            .role-header-legend { display: grid; grid-auto-flow: column; gap: 10px; margin-bottom: 5px; }
                            .role-header-legend.team-headers { grid-template-columns: repeat(3, 1fr); }
                            .role-header-legend.professor-headers { grid-template-columns: repeat(2, 1fr); }
                            .role-header-name, .role-header-status, .role-header-last, .role-header-qty { padding: 4px; background-color: #495057; color: white; border-radius: 3px; text-align: center; font-size: 7pt; font-weight: bold; text-transform: uppercase; }
                            .role-header-name { text-align: left; }
                            .role-item { display: grid; grid-template-columns: 60% 15% 15% 10%; gap: 2px; align-items: stretch; margin-bottom: 2px; min-height: 24px; font-size: 8pt; }
                            .role-name, .role-status-cell, .role-last-cell, .role-qty-cell { padding: 4px; background-color: #f8f9fa; border-radius: 3px; display: flex; align-items: center; }
                            .role-status-cell, .role-last-cell, .role-qty-cell { justify-content: center; }
                            .role-status { width: 14px; height: 14px; display: inline-flex; align-items: center; justify-content: center; border-radius: 3px; font-weight: bold; color: white; font-size: 9pt; }
                            .service-number, .quantity-number { font-size: 8pt; font-weight: 600; text-transform: uppercase; }
                            .quantity-number { color: #28a745; }
                            .status-N { background-color: #dc3545; } .status-I { background-color: #ffc107; color: #333; } .status-E { background-color: #28a745; }
                            .legend { display: flex; justify-content: center; gap: 20px; margin: 15px 0; font-size: 9pt; padding: 8px; background-color: #f8f9fa; border-radius: 4px; }
                            .legend-item { display: flex; align-items: center; gap: 5px; }
                            .legend-color { width: 16px; height: 16px; border-radius: 3px; }
                            .rector-qualification-grid { display: flex; flex-direction: column; gap: 4px; }
                            .qualification-labels { display: flex; justify-content: space-around; }
                            .qualification-label { flex: 1; text-align: center; font-size: 8pt; font-weight: 600; color: #555; padding: 0 4px; }
                            .segmented-bar-container { display: flex; width: 100%; height: 12px; border-radius: 6px; overflow: hidden; border: 1px solid #dee2e6; background-color: #e9ecef; }
                            .bar-segment { flex: 1; height: 100%; }
                            .bar-segment.pass { background-color: #28a745 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                            .bar-segment.fail { background-color: #dc3545 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                        </style>
                    </head>
                    <body>
                        <div class="page-container">${singleProfileHTML}</div>
                    </body>
                    </html>
                `;

                printJS({
                    printable: printableHTML,
                    type: 'raw-html',
                    style: '@page { size: A4; margin: 0; }', // Ensures content fits on one page
                    documentTitle: `Profile - ${profile.First} ${profile.Last}`
                });
            }

            function printAllTeamProfiles() {
                const roster = currentTeam[currentGender];
                if (!roster || roster.length === 0) {
                    showNotification('Empty Team', 'There are no members on the current team to print.');
                    return;
                }

                let allProfilesHTML = '';
                roster.forEach(member => {
                    const fullProfile = allPescadores[currentGender].find(p => p.PescadoreKey === member.id);
                    if (fullProfile) {
                        const singleProfileHTML = generatePrintableProfileHTML(fullProfile);
                        // Wrap each profile in a div that forces a page break after it and has consistent padding
                        allProfilesHTML += `<div style="page-break-after: always; padding: 0.2in;">${singleProfileHTML}</div>`;
                    }
                });

                const printableHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Team Profile Reports</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 0; font-size: 10pt; color: #333; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            .profile-main-info, .roles-section { page-break-inside: avoid; }
                            .profile-main-info { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #dee2e6; }
                            .profile-header { display: flex; align-items: baseline; flex-wrap: wrap; margin-bottom: 10px; }
                            .profile-name { font-size: 22pt; font-weight: bold; margin: 0 15px 0 0; }
                            .profile-weekend-info { font-size: 0.8em; font-weight: 600; margin-left: 10px; }
                            .last-served-highlight { background-color: #ffc107; padding: 2px 6px; border-radius: 3px; font-weight: bold; color: #333; }
                            .main-info-item { margin: 4px 0; display: flex; }
                            .main-info-label { font-weight: bold; width: 100px; flex-shrink: 0; }
                            .roles-section { margin-top: 15px; }
                            .roles-title { font-weight: bold; margin-bottom: 10px; font-size: 14pt; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
                            .role-grid { display: grid; grid-auto-flow: column; gap: 10px; }
                            .team-grid { grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(10, auto); }
                            .professor-grid { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(5, auto); }
                            .role-header-set { display: grid; grid-template-columns: 60% 15% 15% 10%; gap: 2px; }
                            .role-header-legend { display: grid; grid-auto-flow: column; gap: 10px; margin-bottom: 5px; }
                            .role-header-legend.team-headers { grid-template-columns: repeat(3, 1fr); }
                            .role-header-legend.professor-headers { grid-template-columns: repeat(2, 1fr); }
                            .role-header-name, .role-header-status, .role-header-last, .role-header-qty { padding: 4px; background-color: #495057; color: white; border-radius: 3px; text-align: center; font-size: 7pt; font-weight: bold; text-transform: uppercase; }
                            .role-header-name { text-align: left; }
                            .role-item { display: grid; grid-template-columns: 60% 15% 15% 10%; gap: 2px; align-items: stretch; margin-bottom: 2px; min-height: 24px; font-size: 8pt; }
                            .role-name, .role-status-cell, .role-last-cell, .role-qty-cell { padding: 4px; background-color: #f8f9fa; border-radius: 3px; display: flex; align-items: center; }
                            .role-status-cell, .role-last-cell, .role-qty-cell { justify-content: center; }
                            .role-status { width: 14px; height: 14px; display: inline-flex; align-items: center; justify-content: center; border-radius: 3px; font-weight: bold; color: white; font-size: 9pt; }
                            .service-number, .quantity-number { font-size: 8pt; font-weight: 600; text-transform: uppercase; }
                            .quantity-number { color: #28a745; }
                            .status-N { background-color: #dc3545; } .status-I { background-color: #ffc107; color: #333; } .status-E { background-color: #28a745; }
                            .legend { display: flex; justify-content: center; gap: 20px; margin: 15px 0; font-size: 9pt; padding: 8px; background-color: #f8f9fa; border-radius: 4px; }
                            .legend-item { display: flex; align-items: center; gap: 5px; }
                            .legend-color { width: 16px; height: 16px; border-radius: 3px; }
                            .rector-qualification-grid { display: flex; flex-direction: column; gap: 4px; }
                            .qualification-labels { display: flex; justify-content: space-around; }
                            .qualification-label { flex: 1; text-align: center; font-size: 8pt; font-weight: 600; color: #555; padding: 0 4px; }
                            .segmented-bar-container { display: flex; width: 100%; height: 12px; border-radius: 6px; overflow: hidden; border: 1px solid #dee2e6; background-color: #e9ecef; }
                            .bar-segment { flex: 1; height: 100%; }
                            .bar-segment.pass { background-color: #28a745 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                            .bar-segment.fail { background-color: #dc3545 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                        </style>
                    </head>
                    <body>
                        ${allProfilesHTML}
                    </body>
                    </html>
                `;

                printJS({
                    printable: printableHTML,
                    type: 'raw-html',
                    style: '@page { size: A4; margin: 0; }',
                    documentTitle: 'Team Profiles'
                });
            }

            function showLoadingState(isLoading, message = "Loading...") {
                const grid = $('#namesGrid');
                if (isLoading) {
                    grid.innerHTML = `
                        <div class="progress-bar-container">
                            <div class="progress-bar-label">${message}</div>
                            <div class="progress-bar-track">
                                <div class="progress-bar-fill"></div>
                            </div>
                        </div>`;
                } else {
                    grid.innerHTML = ''; // Content will be rendered by another function
                }
            }

            function updateTeamUI() {
                const team = currentTeam[currentGender];
                const count = team.length;
                const teamCountBadge = $('#teamCountBadge');
                const teamCountBadgeProfile = $('#teamCountBadgeProfile');

                if (teamCountBadge) {
                    teamCountBadge.textContent = count;
                    teamCountBadge.style.display = count > 0 ? 'inline-block' : 'none';
                }
                if (teamCountBadgeProfile) {
                    teamCountBadgeProfile.textContent = count;
                    teamCountBadgeProfile.style.display = count > 0 ? 'inline-block' : 'none';
                }
            }
            
            function renderTeamListPage() {
                 const grid = $('#teamListGrid');
                 const titleEl = $('#teamListTitle');
                 grid.innerHTML = '';

                 const genderLabel = currentGender.charAt(0).toUpperCase() + currentGender.slice(1);
                 const weekendId = TV.weekendIdentifier || ''; 
                 
                let displayId = weekendId;
                 if (weekendId) {
                    const match = weekendId.match(/(\w+)'s (\d+)/);
                    if (match && !weekendId.toLowerCase().includes('weekend')) {
                        displayId = `${match[1]}'s Weekend ${match[2]}`;
                    }
                    titleEl.innerHTML = `
                        <span>${genderLabel}'s Team List</span>
                        <span style="font-size: 0.85rem; color: var(--muted); font-weight: 400; margin-left: 15px;">${displayId}</span>
                    `;
                 } else {
                     titleEl.textContent = `${genderLabel}'s Team List`;
                 }
                 
                 $('#teamGenderDisplayPanel').textContent = genderLabel;
                 
                 let totalMembers = 0;
                 const roster = currentTeam[currentGender];
                 totalMembers = roster.length;

                // --- NEW: Move Team Total card into the controls bar ---
                const controlsContainer = $('.team-list-controls');
                controlsContainer.querySelector('p')?.remove(); // Remove the old helper text

                const existingTotalCard = controlsContainer.querySelector('.team-total-card');
                if (existingTotalCard) {
                    existingTotalCard.querySelector('.team-total-count').textContent = totalMembers;
                } else {
                    const totalCard = document.createElement('div');
                    totalCard.className = 'team-total-card';
                    totalCard.innerHTML = `
                        <div class="team-total-title">Team Total</div>
                        <div class="team-total-count">${totalMembers}</div>
                    `;
                    controlsContainer.appendChild(totalCard);
                }
                
                // --- Rector Section is now the first item in the grid ---
                const rectorSection = document.createElement('div');
                rectorSection.className = 'rector-section';
                rectorSection.innerHTML = `
                    <div class="rector-title">Rector</div>
                    <div id="rectorContainer"></div>
                `;
                grid.appendChild(rectorSection);

                 const rectorContainer = $('#rectorContainer');
                 const rector = roster.find(m => m.role === 'Rector');
                 
                 if (rector) {
                     const rectorBadge = document.createElement('div');
                     rectorBadge.className = 'rector-badge';
                     
                     const rectorNameSpan = document.createElement('span');
                     rectorNameSpan.className = 'rector-name';
                     rectorNameSpan.textContent = rector.name;
                     
                     const removeRectorSpan = document.createElement('span');
                     removeRectorSpan.className = 'remove-rector-btn';
                     removeRectorSpan.textContent = 'Remove ×';
                     
                     rectorBadge.appendChild(rectorNameSpan);
                     rectorBadge.appendChild(removeRectorSpan);
                     rectorBadge.addEventListener('click', () => removeTeammate(rector.id, 'Rector'));
                     
                     rectorContainer.appendChild(rectorBadge);
                 } else {
                     const emptyDiv = document.createElement('div');
                     emptyDiv.style.cssText = 'color: #6c757d; font-style: italic; padding: 8px 16px;';
                     emptyDiv.textContent = '(No Rector Assigned)';
                     rectorContainer.appendChild(emptyDiv);
                 }
                 
                const leadershipRoles = ['Head', 'Asst Head', 'BUR', 'Head Spiritual Director', 'Spiritual Director'];
                const professorRoles = ROLE_CONFIG.professor.map(r => r.key);
                const unifiedTeamGroups = [
                    { title: 'Kitchen Team', head: 'Head Kitchen', assistantHead: 'Asst Head Kitchen', team: 'Kitchen' },
                    { title: 'Prayer Team', head: 'Head Prayer', team: 'Prayer' },
                    { title: 'Table Team', head: 'Head Table', team: 'Table' },
                    { title: 'Chapel Team', head: 'Head Chapel', team: 'Chapel' },
                    { title: 'Dorm Team', head: 'Head Dorm', team: 'Dorm' },
                    { title: 'Palanca Team', head: 'Head Palanca', team: 'Palanca' },
                    { title: 'Gopher Team', head: 'Head Gopher', team: 'Gopher' },
                    { title: 'Storeroom Team', head: 'Head Storeroom', team: 'Storeroom' },
                    { title: 'Floater Supply Team', head: 'Head Floater Supply', team: 'Floater Supply' },
                    { title: 'Worship Team', head: 'Head Worship', team: 'Worship' },
                    { title: 'Media Team', head: 'Head Media', team: 'Media' }
                ];

                grid.appendChild(createLeadershipSection(leadershipRoles));
                grid.appendChild(createSingleRoleSection('Professor Team', professorRoles));
                unifiedTeamGroups.forEach(group => grid.appendChild(createUnifiedTeamSection(group)));
            }

            function createLeadershipSection(leadershipRoles) {
                const roster = currentTeam[currentGender];
                const section = document.createElement('div');
                section.className = 'unified-team-section';

                const leadershipKeys = ['Head', 'Asst Head', 'BUR', 'Head Spiritual Director', 'Spiritual Director'];
                let totalMembers = leadershipKeys.reduce((acc, role) => acc + roster.filter(m => m.role === role).length, 0);

                const title = document.createElement('div');
                title.className = 'unified-team-header';
                title.innerHTML = `<span>Leadership Team</span>${totalMembers > 0 ? `<span class="team-header-count-badge">${totalMembers}</span>` : ''}`;
                section.appendChild(title);
                
                const layoutGrid = document.createElement('div');
                layoutGrid.className = 'unified-team-members';
                layoutGrid.style.display = 'grid';
                layoutGrid.style.gridTemplateColumns = '1fr 1fr';
                layoutGrid.style.gap = '0';

                const col1 = document.createElement('div');
                col1.style.borderRight = '1px solid #f0f0f0';
                const col2 = document.createElement('div');

                // --- Column 1: Secular Leadership ---
                const secularRoles = ['Head', 'Asst Head', 'BUR'];
                secularRoles.forEach(role => {
                    const person = roster.find(m => m.role === role);
                    const roleItem = document.createElement('div');
                    roleItem.className = 'unified-member-item';
                    if (person) {
                        roleItem.innerHTML = `<div class="single-role-name">${role}:</div><div class="single-role-assigned"><span class="unified-member-name">${person.name}</span><button class="remove-teammate-btn">×</button></div>`;
                        roleItem.querySelector('.remove-teammate-btn').addEventListener('click', () => removeTeammate(person.id, role));
                    } else {
                        roleItem.innerHTML = `<div class="single-role-name">${role}:</div><div class="single-role-assigned"><span style="color: #6c757d; font-style: italic;"></span></div>`;
                    }
                    col1.appendChild(roleItem);
                });

                // --- Column 2: Spiritual Leadership ---
                const headSD = roster.find(m => m.role === 'Head Spiritual Director');
                const regularSDs = roster.filter(m => m.role === 'Spiritual Director');

                // Slot 1: Head Spiritual Director
                const headSDRoleItem = document.createElement('div');
                headSDRoleItem.className = 'unified-member-item';
                if (headSD) {
                    headSDRoleItem.innerHTML = `<div class="single-role-name">Spiritual Director:</div><div class="single-role-assigned"><span class="unified-member-name">${headSD.name} <span class="member-role-label head">HEAD</span></span><button class="remove-teammate-btn">×</button></div>`;
                    headSDRoleItem.querySelector('.remove-teammate-btn').addEventListener('click', () => removeTeammate(headSD.id, 'Head Spiritual Director'));
                } else {
                    headSDRoleItem.innerHTML = `<div class="single-role-name">Spiritual Director:</div><div class="single-role-assigned"><span style="color: #6c757d; font-style: italic;"></span></div>`;
                }
                col2.appendChild(headSDRoleItem);

                // Slots 2 & 3: Regular Spiritual Directors (up to 2)
                for (let i = 0; i < 2; i++) {
                    const person = regularSDs[i];
                    const sdRoleItem = document.createElement('div');
                    sdRoleItem.className = 'unified-member-item';
                    if (person) {
                        sdRoleItem.innerHTML = `<div class="single-role-name">Spiritual Director:</div><div class="single-role-assigned"><span class="unified-member-name">${person.name}</span><button class="remove-teammate-btn">×</button></div>`;
                        sdRoleItem.querySelector('.remove-teammate-btn').addEventListener('click', () => removeTeammate(person.id, 'Spiritual Director'));
                    } else {
                        sdRoleItem.innerHTML = `<div class="single-role-name">Spiritual Director:</div><div class="single-role-assigned"><span style="color: #6c757d; font-style: italic;"></span></div>`;
                    }
                    col2.appendChild(sdRoleItem);
                }

                layoutGrid.appendChild(col1);
                layoutGrid.appendChild(col2);
                section.appendChild(layoutGrid);
                return section;
            }
            
            function createUnifiedTeamSection(group) {
                const roster = currentTeam[currentGender];
                const headMembers = roster.filter(m => m.role === group.head);
                const assistantMembers = group.assistantHead ? roster.filter(m => m.role === group.assistantHead) : [];
                const teamMembers = roster.filter(m => m.role === group.team);
                const totalMembers = headMembers.length + assistantMembers.length + teamMembers.length;
                
                const section = document.createElement('div');
                section.className = 'unified-team-section';
                
                const header = document.createElement('div');
                header.className = 'unified-team-header';
                header.innerHTML = `<span>${group.title}</span>${totalMembers > 0 ? `<span class="team-header-count-badge">${totalMembers}</span>` : ''}`;
                section.appendChild(header);
                
                const membersList = document.createElement('div');
                membersList.className = 'unified-team-members';
                
                if (totalMembers === 0) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'unified-member-item';
                    emptyDiv.style.cssText = 'color: #6c757d; font-style: italic; text-align: center; padding: 20px; align-items: center;';
                    emptyDiv.textContent = 'No team members assigned';
                    membersList.appendChild(emptyDiv);
                } else {
                    headMembers.forEach(person => {
                        const item = document.createElement('div');
                        item.className = 'unified-member-item';
                        item.innerHTML = `<div class="single-role-assigned"><span class="unified-member-name">${person.name} <span class="member-role-label head">HEAD</span></span><button class="remove-teammate-btn">×</button></div>`;
                        item.querySelector('.remove-teammate-btn').addEventListener('click', () => removeTeammate(person.id, group.head));
                        membersList.appendChild(item);
                    });
                    assistantMembers.forEach(person => {
                        const item = document.createElement('div');
                        item.className = 'unified-member-item';
                        item.innerHTML = `<div class="single-role-assigned"><span class="unified-member-name">${person.name} <span class="member-role-label asst-head">ASST HEAD</span></span><button class="remove-teammate-btn">×</button></div>`;
                        item.querySelector('.remove-teammate-btn').addEventListener('click', () => removeTeammate(person.id, group.assistantHead));
                        membersList.appendChild(item);
                    });
                    teamMembers.forEach(person => {
                        const item = document.createElement('div');
                        item.className = 'unified-member-item';
                        item.innerHTML = `<div class="single-role-assigned"><span class="unified-member-name">${person.name}</span><button class="remove-teammate-btn">×</button></div>`;
                        item.querySelector('.remove-teammate-btn').addEventListener('click', () => removeTeammate(person.id, group.team));
                        membersList.appendChild(item);
                    });
                }
                
                section.appendChild(membersList);
                return section;
            }

            function createSingleRoleSection(sectionTitle, roles) {
                const roster = currentTeam[currentGender];
                const section = document.createElement('div');
                section.className = 'unified-team-section';

                let totalMembers = roles.reduce((acc, roleKey) => acc + roster.filter(m => m.role === roleKey).length, 0);

                const title = document.createElement('div');
                title.className = 'unified-team-header';
                title.innerHTML = `<span>${sectionTitle}</span>${totalMembers > 0 ? `<span class="team-header-count-badge">${totalMembers}</span>` : ''}`;
                section.appendChild(title);
                
                const roleList = document.createElement('div');
                roleList.className = 'unified-team-members two-column';
                
                roles.forEach(roleKey => {
                    const person = roster.find(m => m.role === roleKey);
                    const roleConf = ROLE_CONFIG.professor.find(r => r.key === roleKey);
                    const displayName = roleConf ? roleConf.name.replace('Professor - ', '') : roleKey;
                    
                    const roleItem = document.createElement('div');
                    roleItem.className = 'unified-member-item';
                    
                    if (person) {
                        roleItem.innerHTML = `<div class="single-role-name">${displayName}:</div><div class="single-role-assigned"><span class="unified-member-name">${person.name}</span><button class="remove-teammate-btn">×</button></div>`;
                        roleItem.querySelector('.remove-teammate-btn').addEventListener('click', () => removeTeammate(person.id, roleKey));
                    } else {
                        roleItem.innerHTML = `<div class="single-role-name">${displayName}:</div><div class="single-role-assigned"><span style="color: #6c757d; font-style: italic;"></span></div>`;
                    }
                    roleList.appendChild(roleItem);
                });
                
                section.appendChild(roleList);
                return section;
            }
            
            function openRoleModal() {
                if (currentProfileIndex === -1) return;
                const profile = filteredPescadores[currentProfileIndex];
                const container = $('#roleButtonGrid');
                container.innerHTML = '';

                // Create Team Roles Section
                const teamSection = document.createElement('div');
                teamSection.className = 'role-section';
                teamSection.innerHTML = `<h4 class="role-section-title">Team Roles</h4>`;
                
                const teamGrid = document.createElement('div');
                teamGrid.className = 'role-button-grid';
                const teamRoles = ROLE_CONFIG.team;
                const teamRowsNeeded = Math.ceil(teamRoles.length / 4);
                teamGrid.style.gridTemplateRows = `repeat(${teamRowsNeeded}, auto)`;
                
                teamRoles.forEach(role => {
                    const button = document.createElement('button');
                    button.className = 'role-assign-button';
                    const roleCount = (currentTeam[currentGender].filter(m => m.role === role.name) || []).length;
                    const countBadge = roleCount > 0 ? `<span class="team-count-badge">${roleCount}</span>` : '';
                    button.innerHTML = `<span style="flex-grow: 1;">${role.name}</span>${countBadge}`;
                    button.onclick = () => assignRole(profile, role.name);
                    teamGrid.appendChild(button);
                });
                teamSection.appendChild(teamGrid);
                container.appendChild(teamSection);

                // Create Professor Roles Section
                const profSection = document.createElement('div');
                profSection.className = 'role-section';
                profSection.innerHTML = `<h4 class="role-section-title">Professor Roles</h4>`;
                
                const profGrid = document.createElement('div');
                profGrid.className = 'role-button-grid';
                const profRoles = ROLE_CONFIG.professor;
                const profRowsNeeded = Math.ceil(profRoles.length / 4);
                profGrid.style.gridTemplateRows = `repeat(${profRowsNeeded}, auto)`;

                profRoles.forEach(role => {
                    const button = document.createElement('button');
                    button.className = 'role-assign-button';
                    const roleCount = (currentTeam[currentGender].filter(m => m.role === role.name) || []).length;
                    const countBadge = roleCount > 0 ? `<span class="team-count-badge">${roleCount}</span>` : '';
                    button.innerHTML = `<span style="flex-grow: 1;">${role.name}</span>${countBadge}`;
                    button.onclick = () => assignRole(profile, role.name);
                    profGrid.appendChild(button);
                });
                profSection.appendChild(profGrid);
                container.appendChild(profSection);
                
                $('#roleModal').style.display = 'block';
            }

            function closeRoleModal() {
                $('#roleModal').style.display = 'none';
            }

            function assignRole(profile, role) {
                const team = currentTeam[currentGender];
                const existing = team.find(m => m.id === profile.PescadoreKey && m.role === role);
                if(existing){
                    showNotification('Already exists', `${profile.Preferred || profile.First} is already assigned as ${role}.`);
                    return;
                }
                
                team.push({
                    id: profile.PescadoreKey,
                    name: `${profile.Preferred || profile.First || ''} ${profile.Last || ''}`,
                    role: role
                });
                
                updateTeamUI();
                closeRoleModal();
                showNotification('Success', `${profile.Preferred || profile.First} has been added as ${role}.`);
            }

            function removeTeammate(pescadoreId){
                currentTeam[currentGender] = currentTeam[currentGender].filter(m => m.id.toString() !== pescadoreId.toString());
                renderTeamModal();
                updateTeamUI();
            }

            function clearTeam(){
                if(confirm(`Are you sure you want to clear the entire ${currentGender}'s team?`)){
                    currentTeam[currentGender] = [];
                    renderTeamModal();
                    updateTeamUI();
                }
            }
            
            function exportTeam(){ alert('Export for Team Book clicked'); }
            function openBadgeExportModal(){ $('#badgeExportModal').style.display = 'block'; }
            function closeBadgeExportModal(){ $('#badgeExportModal').style.display = 'none'; }
            function generateBadgeCSV(){ alert('Generate Badge CSV clicked'); }
            function printTeamRoster() { alert('Print Team Roster clicked'); }

            function requestEditMode(){ 
                $('#passwordModal').style.display = 'block';
                $('#passwordInput').focus();
            }
            function closePasswordModal(){ 
                $('#passwordModal').style.display = 'none'; 
                $('#passwordInput').value = ''; 
                $('#passwordError').style.display = 'none';
            }
            
            function checkPassword(){
                if($('#passwordInput').value === EDIT_PASSWORD){
                    closePasswordModal();
                    enterEditMode();
                } else {
                    $('#passwordError').style.display = 'block';
                }
            }

            function enterEditMode() {
                editMode = true;
                pendingChanges = {}; // Clear any previous changes
                renderProfile();
                
                // Show save/cancel buttons and hide the regular footer buttons
                $('#editModeControls').style.display = 'flex';
                $('.refresh-section').style.display = 'none';
            }

            function cancelEdit() {
                exitEditMode();
            }

            async function saveChanges() {
                const profile = filteredPescadores[currentProfileIndex];
                const updateData = { ...pendingChanges };
                
                const fieldsToUpdate = {
                    'First': $('#edit-first').value,
                    'Preferred': $('#edit-preferred').value,
                    'Last': $('#edit-last').value,
                    'Email': $('#edit-email').value,
                    'Phone1': $('#edit-phone').value,
                    'Church': $('#edit-church').value,
                    'Address': $('#edit-address').value,
                    'City': $('#edit-city').value,
                    'State': $('#edit-state').value,
                    'Zip': $('#edit-zip').value,
                    'Deceased': document.getElementById('edit-deceased').value === 'true',
                    'Do_Not_Call': document.getElementById('edit-do-not-call').value === 'true'
                };

                // Add to updateData only if changed
                for (const key in fieldsToUpdate) {
                    const newValue = fieldsToUpdate[key];
                    const originalValue = profile[key];

                    // This block handles the boolean toggles ('Deceased', 'Do_Not_Call')
                    if (typeof newValue === 'boolean') {
                        // This logic now correctly mirrors the rendering logic to handle all 'yes'/'no' variations from the database.
                        const isOriginalValueYes = originalValue === true || (originalValue || '').toLowerCase() === 'y' || (originalValue || '').toLowerCase() === 'yes';
                        if (newValue !== isOriginalValueYes) {
                            updateData[key] = newValue;
                        }
                    } 
                    // This block handles all other string/number fields
                    else {
                        if (newValue !== (originalValue || '')) {
                            updateData[key] = newValue;
                        }
                    }
                }

                // NEW: Collect changes from role service and quantity inputs
                $$('.role-last-cell .editable-field, .role-qty-cell .editable-field').forEach(input => {
                    const fieldName = input.dataset.field;
                    const newValue = input.value.trim();
                    const originalValue = profile[fieldName]; 

                    // Using String() handles null/undefined original values gracefully
                    if (newValue !== String(originalValue || '')) {
                        const isQtyField = fieldName.endsWith('_Qty');
                        // For quantity, convert to number or null if empty. For service, save as string.
                        updateData[fieldName] = isQtyField 
                            ? (newValue === '' ? null : parseInt(newValue, 10)) 
                            : newValue;
                    }
                });

                if (Object.keys(updateData).length === 0) {
                    showNotification('No Changes', 'No changes were detected.');
                    exitEditMode();
                    return;
                }
                
                const tableName = currentGender === 'men' ? 'men_raw' : 'women_raw';
                const { error } = await supabaseClient
                    .from(tableName)
                    .update(updateData)
                    .eq('PescadoreKey', profile.PescadoreKey);

                if (error) {
                    showNotification('Error', `Failed to save changes: ${error.message}`);
                } else {
                    showNotification('Success', 'Profile updated successfully.');
                    
                    // Keep the PescadoreKey to find the profile after refresh
                    const currentPescadoreKey = profile.PescadoreKey;

                    // Refresh all local data from the database
                    await fetchDataFromSupabase(); 

                    // Find the updated profile in the newly fetched master list
                    const updatedProfile = allPescadores[currentGender].find(p => p.PescadoreKey === currentPescadoreKey);
                    
                    // Update the currently viewed profile data in the filtered list
                    if (updatedProfile) {
                        filteredPescadores[currentProfileIndex] = updatedProfile;
                    }

                    // Now exit edit mode. The `false` argument ensures the profile re-renders with the fresh data.
                    exitEditMode(false);
                }
            }

            function exitEditMode(skipRender = false) {
                editMode = false;
                pendingChanges = {};
                if (!skipRender) {
                    renderProfile();
                }

                // Hide save/cancel and show regular footer buttons
                $('#editModeControls').style.display = 'none';
                $('.refresh-section').style.display = 'block';
            }

            function cycleRoleStatus(element) {
                const currentStatus = element.textContent;
                const fieldName = element.dataset.field;
                let nextStatus;

                if (currentStatus === 'N') nextStatus = 'I';
                else if (currentStatus === 'I') nextStatus = 'E';
                else nextStatus = 'N';

                element.textContent = nextStatus;
                element.className = `role-status status-${nextStatus}`;
                pendingChanges[fieldName] = nextStatus;
            }

            async function openTeamNameModal() {
                $('#teamNameModal').style.display = 'block';

                const menRosterTable = 'men_team_rosters';
                const womenRosterTable = 'women_team_rosters';

                const { data: menTeams, error: menErr } = await supabaseClient.from(menRosterTable).select('weekend_identifier');
                const { data: womenTeams, error: womenErr } = await supabaseClient.from(womenRosterTable).select('weekend_identifier');

                if (menErr || womenErr) {
                    console.error("Error fetching team lists:", menErr || womenErr);
                    $('#loadMenTeamBtn').disabled = true;
                    $('#loadWomenTeamBtn').disabled = true;
                    $('#createMenTeamBtn').disabled = true;
                    $('#createWomenTeamBtn').disabled = true;
                    return;
                } else {
                    $('#createMenTeamBtn').disabled = false;
                    $('#createWomenTeamBtn').disabled = false;
                }

                // Helper to robustly get the highest number from an identifier string
                const getHighestNumber = (teams) => {
                    if (!teams || teams.length === 0) return 0;
                    return teams.reduce((max, team) => {
                        const identifierStr = team.weekend_identifier ? String(team.weekend_identifier) : '';
                        const numMatch = identifierStr.match(/\d+/);
                        const num = numMatch ? parseInt(numMatch[0], 10) : 0;
                        return Math.max(max, num);
                    }, 0);
                };
                
                // Logic for "Load" buttons
                const latestMenNumber = getHighestNumber(menTeams);
                const latestWomenNumber = getHighestNumber(womenTeams);

                const loadMenBtn = $('#loadMenTeamBtn');
                if (latestMenNumber > 0) {
                    loadMenBtn.textContent = `Load Men's Weekend ${latestMenNumber}`;
                    loadMenBtn.dataset.number = latestMenNumber;
                    loadMenBtn.disabled = false;
                } else {
                    loadMenBtn.textContent = `No Men's Teams Exist`;
                    loadMenBtn.disabled = true;
                }
                
                const loadWomenBtn = $('#loadWomenTeamBtn');
                if (latestWomenNumber > 0) {
                    loadWomenBtn.textContent = `Load Women's Weekend ${latestWomenNumber}`;
                    loadWomenBtn.dataset.number = latestWomenNumber;
                    loadWomenBtn.disabled = false;
                } else {
                    loadWomenBtn.textContent = `No Women's Teams Exist`;
                    loadWomenBtn.disabled = true;
                }

                // Logic for "Create" buttons
                const nextMenNumber = latestMenNumber + 1;
                const nextWomenNumber = latestWomenNumber + 1;

                $('#createMenTeamBtn').textContent = `Create Men's Weekend ${nextMenNumber}`;
                $('#createMenTeamBtn').dataset.number = nextMenNumber;

                $('#createWomenTeamBtn').textContent = `Create Women's Weekend ${nextWomenNumber}`;
                $('#createWomenTeamBtn').dataset.number = nextWomenNumber;
            }


            function closeTeamNameModal(){ $('#teamNameModal').style.display = 'none'; }
            
            function loadLatestTeam(gender) {
                const button = $(`#load${gender.charAt(0).toUpperCase() + gender.slice(1)}TeamBtn`);
                const number = button.dataset.number;
                if (!number || number === '0') {
                    showNotification('No Team Found', `There is no existing ${gender}'s team to load.`);
                    return;
                }
                
                weekendIdentifier = `${gender.charAt(0).toUpperCase() + gender.slice(1)}'s ${number}`;
                currentGender = gender;
                
                // Update the main toggle to reflect the loaded team's gender
                $$('#genderToggleContainer .toggle-inset-option').forEach(el => {
                    el.classList.toggle('active', el.textContent.toLowerCase() === currentGender);
                });

                closeTeamNameModal();
                // Programmatically switch to the Team List view
                document.querySelector('[data-app-id="team-list-app"]').click();
                loadTeamRoster();
            }
            
            function createNewTeam(gender) {
                const button = $(`#create${gender.charAt(0).toUpperCase() + gender.slice(1)}TeamBtn`);
                const number = button.dataset.number;
                const newIdentifier = `${gender.charAt(0).toUpperCase() + gender.slice(1)}'s ${number}`;

                // Set the global state
                weekendIdentifier = newIdentifier;
                currentGender = gender;
                currentTeam[gender] = []; // Start with an empty roster

                // Update the main toggle to reflect the new team's gender
                $$('#genderToggleContainer .toggle-inset-option').forEach(el => {
                    el.classList.toggle('active', el.textContent.toLowerCase() === currentGender);
                });

                closeTeamNameModal();
                // Programmatically switch to the Team List view and render it
                document.querySelector('[data-app-id="team-list-app"]').click();
                renderTeamListPage();
            }

            async function loadTeamRoster() {
                if (!weekendIdentifier) return;

                const rosterTable = currentGender === 'men' ? 'men_team_rosters' : 'women_team_rosters';
                const rawTableData = allPescadores[currentGender];

                // Show a loading state inside the team page
                $('#teamListGrid').innerHTML = '<div class="progress-bar-container"><div class="progress-bar-label">Loading Roster...</div><div class="progress-bar-track"><div class="progress-bar-fill"></div></div></div>';

                const { data, error } = await supabaseClient
                    .from(rosterTable)
                    .select('pescadore_key, role')
                    .eq('weekend_identifier', weekendIdentifier);

                if (error) {
                    showNotification('Error', `Failed to load roster: ${error.message}`);
                    $('#teamGrid').innerHTML = `<p style="text-align:center; color: var(--accentD);">Error loading team.</p>`;
                    return;
                }

                const newRoster = [];
                if (data) {
                    data.forEach(entry => {
                        const profile = rawTableData.find(p => p.PescadoreKey === entry.pescadore_key);
                        if (profile) {
                            newRoster.push({
                                id: profile.PescadoreKey,
                                name: `${profile.Preferred || profile.First || ''} ${profile.Last || ''}`.trim(),
                                role: entry.role
                            });
                        }
                    });
                }

                currentTeam[currentGender] = newRoster;

                renderTeamListPage();
                updateTeamUI();
            }
            
            function showNotification(title, message) {
                $('#notificationTitle').textContent = title;
                $('#notificationMessage').textContent = message;
                $('#notificationModal').style.display = 'block';
            }
            function closeNotificationModal(){ $('#notificationModal').style.display = 'none'; }
            
            async function renderWhenReady() {
                await dataFetchPromise; // Wait for the initial fetch to complete
                performSearch(); // Now render with guaranteed data
            }

            // Public API
            return {
                init,
                performSearch,
                clearSearch,
                printReport,
                printProfile,
                selectGender,
                selectNameFormat,
                showDirectory,
                showProfile,
                navigateProfile,
                fetchDataFromSupabase,
                renderTeamListPage,
                openRoleModal,
                closeRoleModal,
                requestEditMode,
                checkPassword,
                closePasswordModal,
                enterEditMode,
                cancelEdit,
                saveChanges,
                cycleRoleStatus,
                openTeamNameModal,
                closeTeamNameModal,
                loadLatestTeam,
                createNewTeam,
                showNotification,
                closeNotificationModal,
                openBadgeExportModal,
                closeBadgeExportModal,
                generateBadgeCSV,
                printTeamRoster,
                printAllTeamProfiles,
                exportTeam,
                clearTeam,
                removeTeammate,
                loadTeamByGender,
                renderWhenReady
            };
        })();
        // ======================================================
        // =============== END: TEAM VIEWER SCRIPT ==============
        // ======================================================


        // --- NEW: SECRETARIAT MODULE ---
        const SECRETARIAT = (function() {
            const $ = sel => document.querySelector(sel);

            const positions = [
                { key: 'chairman', name: 'Chairman', type: 'single', defaultTerm: 3 },
                { key: 'spiritual_director', name: 'Spiritual Director', type: 'single', defaultTerm: 3 },
                { key: 'mens_leader', name: 'Men’s Leader', type: 'single', defaultTerm: 3 },
                { key: 'womens_leader', name: 'Women’s Leader', type: 'single', defaultTerm: 3 },
                { key: 'secretary', name: 'Secretary', type: 'single', defaultTerm: 3 },
                { key: 'treasurer', name: 'Treasurer', type: 'single', defaultTerm: 3 },
                { key: 'pre_weekend_couple', name: 'Pre-Weekend Couple', type: 'couple', defaultTerm: 3 },
                { key: 'fourth_day_couple', name: 'Fourth Day', type: 'couple', defaultTerm: 3 },
                { key: 'database_website', name: 'Database/Website', type: 'single', defaultTerm: 3 },
                { key: 'weekend_couple', name: 'Weekend Couple', type: 'couple', defaultTerm: 3 },
                { key: 'palanca_couple', name: 'Palanca Couple', type: 'couple', defaultTerm: 3 },
                { key: 'newsletter', name: 'Newsletter', type: 'single', defaultTerm: 3 }
            ];

            let rosterData = {}; // To store real data from Supabase
            let allMembers = []; // To store all community members for name lookups
            
            // --- NEW: State for custom date picker ---
            let isPickerOpen = false;
            let pickerTarget = null; // NEW: Track which date input is active
            let pickerCurrentYear = new Date().getFullYear();
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            // --- END: New state ---

            async function loadDataAndRenderAll() {
                const rosterPromise = supabaseClient.from('secretariat_roster').select('*');
                const menPromise = supabaseClient.from('men_raw').select('PescadoreKey, First, Last, Preferred');
                const womenPromise = supabaseClient.from('women_raw').select('PescadoreKey, First, Last, Preferred');

                try {
                    const [rosterResult, menResult, womenResult] = await Promise.all([rosterPromise, menPromise, womenPromise]);

                    if (rosterResult.error) throw rosterResult.error;
                    if (menResult.error) throw menResult.error;
                    if (womenResult.error) throw womenResult.error;

                    allMembers = [...(menResult.data || []), ...(womenResult.data || [])];
                    
                    // Convert roster array to an object keyed by position_key for easy lookup
                    rosterData = (rosterResult.data || []).reduce((acc, item) => {
                        acc[item.position_key] = item;
                        return acc;
                    }, {});

                    renderSettingsCard();
                    renderDashboard();

                } catch (error) {
                    console.error("Error loading Secretariat data:", error);
                    alert(`Failed to load Secretariat data: ${error.message}`);
                }
            }

            function findMember(memberId) {
                if (!memberId) return null;
                return allMembers.find(m => String(m.PescadoreKey) === String(memberId));
            }

            function renderSettingsCard() {
                const grid = $('#secretariat-positions-grid');
                if (!grid) return;

                grid.innerHTML = positions.map(pos => {
                    const savedTerm = rosterData[pos.key]?.term_length_years;
                    const termValue = savedTerm !== null && savedTerm !== undefined ? savedTerm : pos.defaultTerm;

                    return `
                        <div class="secretariat-position-item">
                            <span class="position-name">${pos.name}</span>
                            <div class="term-input-group">
                                <input type="number" class="input term-input" id="term-${pos.key}" value="${termValue}" min="1" max="5">
                                <label class="label" for="term-${pos.key}" style="margin:0;">Years</label>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            function findMemberName(memberId) {
                if (!memberId) return null;
                const member = allMembers.find(m => String(m.PescadoreKey) === String(memberId));
                if (!member) return `Unknown (ID: ${memberId})`;
                return `${member.Preferred || member.First} ${member.Last}`.trim();
            }

            function renderDashboard() {
                const container = $('#secretariat-dashboard-container');
                if (!container) {
                    // This can happen if the Secretariat tab is not the active one on load.
                    // The main navigation logic will call this when the tab becomes visible.
                    return;
                }

                const today = new Date();
                const oneYearFromNow = new Date();
                oneYearFromNow.setFullYear(today.getFullYear() + 1);

                container.innerHTML = positions.map(pos => {
                    const data = rosterData[pos.key] || {};
                    const termLength = data.term_length_years || pos.defaultTerm;

                    let memberName = 'Unfilled';
                    if (pos.type === 'couple') {
                        const member1 = findMember(data.member1_id);
                        const member2 = findMember(data.member2_id);
                        if (member1 && member2) {
                            const firstName1 = member1.Preferred || member1.First;
                            const lastName1 = member1.Last;
                            const firstName2 = member2.Preferred || member2.First;
                            const lastName2 = member2.Last;
                            if (lastName1 && lastName1.toLowerCase() === lastName2.toLowerCase()) {
                                memberName = `${firstName1} & ${firstName2} ${lastName1}`;
                            } else {
                                memberName = `${firstName1} ${lastName1} & ${firstName2} ${lastName2}`;
                            }
                        } else if (member1) {
                            memberName = `${member1.Preferred || member1.First} ${member1.Last}`;
                        } else if (member2) {
                            memberName = `${member2.Preferred || member2.First} ${member2.Last}`;
                        }
                    } else {
                        const name1 = findMemberName(data.member1_id);
                        if (name1) memberName = name1;
                    }
                    
                    // Add Interim tag if applicable
                    if (data.is_interim && data.member1_id) {
                        memberName += ` <span style="font-weight: 600; font-style: italic; color: var(--muted);">(Interim)</span>`;
                    }
                    
                    // --- NEW: Intern/Successor Logic ---
                    let internHTML = '';
                    const hasIntern = data.intern1_id && data.intern_start_date;
                    if (hasIntern) {
                        const internStartDate = new Date(data.intern_start_date);
                        const internStartDateFormatted = internStartDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                        const startVerb = internStartDate <= today ? 'Started' : 'Starts'; // Check if date is past or present
                        
                        let internName = '';
                        if (pos.type === 'couple') {
                            const intern1 = findMember(data.intern1_id);
                            const intern2 = findMember(data.intern2_id);
                            if (intern1 && intern2) {
                                const firstName1 = intern1.Preferred || intern1.First;
                                const lastName1 = intern1.Last;
                                const firstName2 = intern2.Preferred || intern2.First;
                                const lastName2 = intern2.Last;
                                if (lastName1 && lastName1.toLowerCase() === lastName2.toLowerCase()) {
                                    internName = `${firstName1} & ${firstName2} ${lastName1}`;
                                } else {
                                    internName = `${firstName1} ${lastName1} & ${firstName2} ${lastName2}`;
                                }
                            } else if (intern1) {
                                internName = `${intern1.Preferred || intern1.First} ${intern1.Last}`;
                            } else if (intern2) {
                                internName = `${intern2.Preferred || intern2.First} ${intern2.Last}`;
                            }
                        } else {
                            const intern1 = findMemberName(data.intern1_id);
                            if (intern1) internName = intern1;
                        }
                        if (internName) {
                            internHTML = `<div class="intern-info">Intern: ${internName} (${startVerb}: ${internStartDateFormatted})</div>`;
                        }
                    }
                    // --- END: Intern/Successor Logic ---

                    let startDate, endDate, progressPercent = 0, timeRemainingText = 'N/A', barColor = 'grey';
                    
                    if (data.start_date) {
                        startDate = new Date(data.start_date);
                        endDate = new Date(startDate);
                        endDate.setFullYear(startDate.getFullYear() + termLength);

                        const totalDuration = endDate.getTime() - startDate.getTime();
                        const elapsedDuration = today.getTime() - startDate.getTime();
                        progressPercent = Math.max(0, Math.min(100, (elapsedDuration / totalDuration) * 100));

                        if (today > endDate) {
                            const monthsPastDue = Math.round((today.getTime() - endDate.getTime()) / (1000 * 60 * 60 * 24 * 30.44));
                            const monthString = monthsPastDue === 1 ? 'month' : 'months';
                            timeRemainingText = `${monthsPastDue} ${monthString} past due`;
                            barColor = 'red';
                        } else {
                            const monthsRemaining = Math.round((endDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24 * 30.44));
                            const monthString = monthsRemaining === 1 ? 'month' : 'months';
                            timeRemainingText = `${monthsRemaining} ${monthString} remaining`;
                            if (endDate < oneYearFromNow) barColor = 'yellow';
                            else barColor = 'green';
                        }
                    }

                    const formattedStartDate = startDate ? startDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) : 'N/A';
                    const formattedEndDate = endDate ? endDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) : 'N/A';
                    const timeRemainingColor = barColor === 'green' ? 'var(--muted)' : (barColor === 'yellow' ? 'var(--accentC)' : 'var(--accentD)');

                    // --- Segmented Timeline Logic ---
                    let timelineHTML = '';
                    const totalMonthsInTerm = termLength * 12;

                    if (data.start_date) {
                        const elapsedMonths = Math.max(0, (today.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24 * 30.44));
                        let segmentFills = [];
                        for (let i = 0; i < termLength; i++) {
                            const yearStartMonths = i * 12;
                            const yearEndMonths = (i + 1) * 12;
                            let fillPercent = 0;
                            if (elapsedMonths >= yearEndMonths) {
                                fillPercent = 100;
                            } else if (elapsedMonths > yearStartMonths) {
                                fillPercent = ((elapsedMonths - yearStartMonths) / 12) * 100;
                            }
                            segmentFills.push(Math.min(100, fillPercent));
                        }
                        timelineHTML = `
                            <div class="timeline-container">
                                ${segmentFills.map((fill, i) => {
                                    // Add the transition overlay to the last segment if an intern exists
                                    const transitionOverlay = (i === termLength - 1 && hasIntern) 
                                        ? '<div class="timeline-transition-overlay"></div>' 
                                        : '';

                                    return `
                                        <div class="timeline-segment">
                                            <div class="timeline-fill ${barColor}" style="width: ${fill}%;"></div>
                                            ${transitionOverlay}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                    } else {
                        // Render empty segments for unfilled positions
                        timelineHTML = `
                            <div class="timeline-container">
                                ${Array(termLength).fill(`
                                    <div class="timeline-segment">
                                        <div class="timeline-fill" style="width: 0%;"></div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    // --- END: Segmented Timeline Logic ---

                    return `
                        <div class="secretariat-card ${data.is_interim ? 'is-interim' : ''}">
                            <div class="secretariat-card-header">
                                <div class="position-title">${pos.name} ${data.is_interim ? ' (INTERIM)' : ''}</div>
                            </div>
                            <div class="secretariat-card-body">
                                <div>
                                    <div class="member-name ${memberName === 'Unfilled' ? 'unfilled' : ''}">${memberName.replace(' (Interim)', '')}</div>
                                    ${internHTML}
                                </div>
                                ${timelineHTML}
                                <div class="term-info-footer">
                                    <span class="term-dates">${formattedStartDate} – ${formattedEndDate}</span>
                                    <span class="time-remaining" style="color: ${timeRemainingColor}">${timeRemainingText}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            async function saveTermLengths() {
                const updates = positions.map(pos => {
                    const input = $(`#term-${pos.key}`);
                    const termLength = input ? parseInt(input.value, 10) : pos.defaultTerm;
                    return {
                        position_key: pos.key,
                        term_length_years: isNaN(termLength) ? pos.defaultTerm : termLength
                    };
                });

                const { error } = await supabaseClient
                    .from('secretariat_roster')
                    .upsert(updates, { onConflict: 'position_key' });

                if (error) {
                    console.error("Error saving term lengths:", error);
                    alert(`Failed to save term lengths: ${error.message}`);
                } else {
                    alert('Term lengths have been saved successfully.');
                    // Reload data to reflect changes immediately
                    await loadDataAndRenderAll();
                }
            }
            
            function openRosterModal() {
                renderRosterModal();
                $('#rosterManagementModal').style.display = 'block';
            }

            function closeRosterModal() {
                $('#rosterManagementModal').style.display = 'none';
            }
            
            function openMemberAssignmentModal(positionKey) {
                const position = positions.find(p => p.key === positionKey);
                if (!position) return;

                $('#assignmentModalTitle').textContent = `Assign ${position.name}`;
                const inputsContainer = $('#assignment-inputs-container');
                const existingData = rosterData[positionKey] || {};

                let optionsHTML = '<option value="">Select Member...</option>';
                allMembers.sort((a, b) => (a.Last || '').localeCompare(b.Last || '')).forEach(m => {
                    const name = `${m.Last}, ${m.Preferred || m.First}`.trim();
                    optionsHTML += `<option value="${m.PescadoreKey}">${name}</option>`;
                });

                let assignmentHTML = '';
                if (position.type === 'couple') {
                    assignmentHTML = `
                        <div class="field"><label class="label">Member 1</label><select id="assignmentMember1" class="select">${optionsHTML}</select></div>
                        <div class="field"><label class="label">Member 2</label><select id="assignmentMember2" class="select">${optionsHTML}</select></div>
                    `;
                } else {
                    assignmentHTML = `<div class="field"><label class="label">Member</label><select id="assignmentMember1" class="select">${optionsHTML}</select></div>`;
                }

                assignmentHTML += `<hr style="border:none; border-top: 1px solid var(--border); margin: 20px 0;">`;

                if (position.type === 'couple') {
                    assignmentHTML += `
                        <div class="field"><label class="label" style="font-style: italic;">Intern 1 (Optional)</label><select id="assignmentIntern1" class="select">${optionsHTML}</select></div>
                        <div class="field"><label class="label" style="font-style: italic;">Intern 2 (Optional)</label><select id="assignmentIntern2" class="select">${optionsHTML}</select></div>
                    `;
                } else {
                    assignmentHTML += `<div class="field"><label class="label" style="font-style: italic;">Intern (Optional)</label><select id="assignmentIntern1" class="select">${optionsHTML}</select></div>`;
                }

                inputsContainer.innerHTML = assignmentHTML;

                // Populate existing data
                if (existingData.member1_id) $('#assignmentMember1').value = existingData.member1_id;
                if (position.type === 'couple' && existingData.member2_id) $('#assignmentMember2').value = existingData.member2_id;
                
                // Populate intern data
                if (existingData.intern1_id) $('#assignmentIntern1').value = existingData.intern1_id;
                if (position.type === 'couple' && existingData.intern2_id) $('#assignmentIntern2').value = existingData.intern2_id;
                
                // Populate the new interim checkbox
                $('#assignmentIsInterim').checked = existingData.is_interim || false;
                
                // --- UPDATE: Populate custom date pickers ---
                const termDateContainer = $('#assignmentStartDate');
                const termDateText = $('#assignmentStartDateText');
                if (existingData.start_date) {
                    const [year, month] = existingData.start_date.split('-');
                    termDateContainer.dataset.value = `${year}-${month}`;
                    termDateText.textContent = `${monthNames[parseInt(month, 10) - 1]} ${year}`;
                    termDateText.classList.remove('placeholder');
                } else {
                    termDateContainer.dataset.value = '';
                    termDateText.textContent = 'Select Month & Year...';
                    termDateText.classList.add('placeholder');
                }

                const internDateContainer = $('#assignmentInternStartDate');
                const internDateText = $('#assignmentInternStartDateText');
                if (existingData.intern_start_date) {
                    const [year, month] = existingData.intern_start_date.split('-');
                    internDateContainer.dataset.value = `${year}-${month}`;
                    internDateText.textContent = `${monthNames[parseInt(month, 10) - 1]} ${year}`;
                    internDateText.classList.remove('placeholder');
                } else {
                    internDateContainer.dataset.value = '';
                    internDateText.textContent = 'Select Month & Year...';
                    internDateText.classList.add('placeholder');
                }
                
                const internDatePicker = $('#intern-date-picker-container');
                const internSelected = existingData.intern1_id || (position.type === 'couple' && existingData.intern2_id);
                internDatePicker.style.display = internSelected ? 'block' : 'none';

                // Add listeners to show/hide the intern date picker
                const internSelects = inputsContainer.querySelectorAll('#assignmentIntern1, #assignmentIntern2');
                internSelects.forEach(sel => sel.addEventListener('change', () => {
                    const anyInternSelected = Array.from(internSelects).some(s => s.value);
                    internDatePicker.style.display = anyInternSelected ? 'block' : 'none';
                }));
                
                // Store the position key on the save button to retrieve it later
                $('#assignmentModalSave').dataset.positionKey = positionKey;

                $('#secretariatAssignmentModal').style.display = 'block';
            }

            function closeMemberAssignmentModal() {
                closeDatePicker(); // Ensure picker is closed
                $('#secretariatAssignmentModal').style.display = 'none';
                // Also hide the status bar when closing
                const statusBar = $('#assignmentStatusBar');
                if (statusBar) {
                    statusBar.classList.remove('visible', 'error');
                }
            }

            function showAssignmentStatus(message, isError = false) {
                const statusBar = $('#assignmentStatusBar');
                if (!statusBar) return;

                statusBar.textContent = message;
                statusBar.classList.toggle('error', isError);
                statusBar.classList.add('visible');

                // Hide the bar after 4 seconds
                setTimeout(() => {
                    statusBar.classList.remove('visible', 'error');
                }, 4000);
            }

            async function saveAssignment() {
                const saveButton = $('#assignmentModalSave');
                const positionKey = saveButton.dataset.positionKey;
                if (!positionKey) return;
                
                const position = positions.find(p => p.key === positionKey);
                
                const member1_id = $('#assignmentMember1').value || null;
                const member2_id = (position.type === 'couple' && $('#assignmentMember2')) ? ($('#assignmentMember2').value || null) : null;
                const intern1_id = $('#assignmentIntern1').value || null;
                const intern2_id = (position.type === 'couple' && $('#assignmentIntern2')) ? ($('#assignmentIntern2').value || null) : null;
                
                // --- UPDATE: Read value from custom picker's data attribute ---
                const termDateValue = $('#assignmentStartDate').dataset.value; // YYYY-MM
                const start_date = termDateValue ? `${termDateValue}-01` : null; // Convert to YYYY-MM-DD
                
                const internDateValue = $('#assignmentInternStartDate').dataset.value;
                const intern_start_date = internDateValue ? `${internDateValue}-01` : null;
                
                const is_interim = $('#assignmentIsInterim').checked;
                
                // Fetch the term length from the roster data to avoid overwriting it
                const term_length_years = rosterData[positionKey]?.term_length_years || position.defaultTerm;

                const payload = {
                    position_key: positionKey,
                    member1_id: member1_id,
                    member2_id: member2_id,
                    intern1_id: intern1_id,
                    intern2_id: intern2_id,
                    start_date: start_date,
                    intern_start_date: (intern1_id || (position.type === 'couple' && intern2_id)) ? intern_start_date : null, // Correctly save date if ANY intern is assigned
                    term_length_years: term_length_years,
                    is_interim: is_interim
                };

                const { error } = await supabaseClient
                    .from('secretariat_roster')
                    .upsert(payload, { onConflict: 'position_key' });

                if (error) {
                    showAssignmentStatus('Failed to save assignment: ' + error.message, true);
                } else {
                    showAssignmentStatus('Assignment saved successfully.');
                    // Reload all data and re-render everything to ensure consistency
                    await loadDataAndRenderAll();
                    // Re-render the roster modal which is still open in the background
                    renderRosterModal();

                    // Close modal after a short delay to allow user to see the message
                    setTimeout(() => {
                        closeMemberAssignmentModal();
                    }, 1500);
                }
            }
            
            function renderRosterModal() {
                const container = $('#rosterModalBody');
                if (!container) return;

                container.innerHTML = positions.map(pos => {
                    const data = rosterData[pos.key] || {};
                    let memberName = 'Unassigned';
                    if (pos.type === 'couple') {
                        const member1 = findMember(data.member1_id);
                        const member2 = findMember(data.member2_id);
                        if (member1 && member2) {
                            const firstName1 = member1.Preferred || member1.First;
                            const lastName1 = member1.Last;
                            const firstName2 = member2.Preferred || member2.First;
                            const lastName2 = member2.Last;
                            if (lastName1 && lastName1.toLowerCase() === lastName2.toLowerCase()) {
                                memberName = `${firstName1} & ${firstName2} ${lastName1}`;
                            } else {
                                memberName = `${firstName1} ${lastName1} & ${firstName2} ${lastName2}`;
                            }
                        } else if (member1) {
                            memberName = `${member1.Preferred || member1.First} ${member1.Last}`;
                        } else if (member2) {
                            memberName = `${member2.Preferred || member2.First} ${member2.Last}`;
                        }
                    } else {
                        const name1 = findMemberName(data.member1_id);
                        if (name1) memberName = name1;
                    }

                    return `
                        <div class="roster-item">
                            <div class="roster-item-info">
                                <span class="roster-item-position">${pos.name}</span>
                                <span class="roster-item-member">${memberName}</span>
                            </div>
                            <button class="btn btn-small" data-action="assign-member" data-position="${pos.key}">
                                ${data.member1_id ? 'Change' : 'Assign'}
                            </button>
                        </div>
                    `;
                }).join('');
            }
            
            function init() {
                loadDataAndRenderAll();
                
                const saveBtn = $('#saveTermLengthsBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', saveTermLengths);
                }

                // --- NEW: Refresh button for roster data ---
                const refreshBtn = $('#refreshRosterListBtn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', async () => {
                        refreshBtn.textContent = 'Refreshing...';
                        refreshBtn.disabled = true;

                        await loadDataAndRenderAll(); // This re-fetches all member and roster data
                        renderRosterModal();          // This re-draws the content inside the modal

                        refreshBtn.textContent = 'Refresh List';
                        refreshBtn.disabled = false;
                    });
                }
                
                // --- NEW: Wire up roster management buttons ---
                const manageBtn = $('#manageRosterBtn');
                const closeBtn = $('#rosterModalClose');
                if(manageBtn) manageBtn.addEventListener('click', openRosterModal);
                if(closeBtn) closeBtn.addEventListener('click', closeRosterModal);

                // --- FIX: Add delegated listener for assign buttons ---
                const rosterBody = $('#rosterModalBody');
                if(rosterBody) {
                    rosterBody.addEventListener('click', e => {
                        const button = e.target.closest('button[data-action="assign-member"]');
                        if (button) {
                            openMemberAssignmentModal(button.dataset.position);
                        }
                    });
                }
                
                // --- NEW: Wire up assignment modal buttons ---
                const assignCancelBtn = $('#assignmentModalCancel');
                const assignSaveBtn = $('#assignmentModalSave');
                if(assignCancelBtn) assignCancelBtn.addEventListener('click', closeMemberAssignmentModal);
                if(assignSaveBtn) assignSaveBtn.addEventListener('click', saveAssignment);
                
                // --- REFACTORED: Wire up ALL custom date pickers ---
                document.querySelectorAll('.custom-date-input').forEach(input => {
                    input.addEventListener('click', toggleDatePicker);
                });
                $('#pickerPrevYear').addEventListener('click', () => changePickerYear(-1));
                $('#pickerNextYear').addEventListener('click', () => changePickerYear(1));
            }

            // --- REFACTORED: Custom Date Picker Functions ---
            function toggleDatePicker(e) {
                e.stopPropagation();
                const targetInput = e.currentTarget;
                if (isPickerOpen && pickerTarget === targetInput) {
                    closeDatePicker();
                } else {
                    openDatePicker(targetInput);
                }
            }
            
            function openDatePicker(inputEl) {
                if (isPickerOpen) closeDatePicker(); // Close any other picker that might be open

                pickerTarget = inputEl;
                const pickerEl = $('#monthYearPicker');
                const selectedValue = pickerTarget.dataset.value;
                
                pickerCurrentYear = selectedValue ? parseInt(selectedValue.split('-')[0], 10) : new Date().getFullYear();
                renderDatePicker();

                const inputRect = pickerTarget.getBoundingClientRect();
                pickerEl.style.display = 'block';
                pickerEl.style.top = `${inputRect.bottom + 8}px`;
                pickerEl.style.left = `${inputRect.left}px`;
                pickerTarget.classList.add('active');
                isPickerOpen = true;

                window.addEventListener('click', closeDatePickerOnOutsideClick, true);
            }
            
            function closeDatePicker() {
                if (!isPickerOpen) return;
                $('#monthYearPicker').style.display = 'none';
                if(pickerTarget) pickerTarget.classList.remove('active');
                isPickerOpen = false;
                pickerTarget = null;
                window.removeEventListener('click', closeDatePickerOnOutsideClick, true);
            }
            
            function closeDatePickerOnOutsideClick(e) {
                const picker = $('#monthYearPicker');
                const isClickInside = picker && picker.contains(e.target);
                const isClickOnTarget = pickerTarget && pickerTarget.contains(e.target);
                
                if (!isClickInside && !isClickOnTarget) {
                    closeDatePicker();
                }
            }
            
            function renderDatePicker() {
                if (!pickerTarget) return;

                $('#pickerCurrentYear').textContent = pickerCurrentYear;
                const grid = $('#pickerMonthGrid');
                const selectedValue = pickerTarget.dataset.value;
                const [selectedYear, selectedMonth] = selectedValue ? selectedValue.split('-').map(Number) : [null, null];

                grid.innerHTML = monthNames.map((name, index) => {
                    const month = index + 1;
                    const isSelected = selectedYear === pickerCurrentYear && selectedMonth === month;
                    return `<button class="month-btn ${isSelected ? 'selected' : ''}" data-month="${month}">${name}</button>`;
                }).join('');

                if (!grid.dataset.listenerAttached) {
                    grid.addEventListener('click', e => {
                        const btn = e.target.closest('.month-btn');
                        if (btn) {
                            selectDate(pickerCurrentYear, btn.dataset.month);
                        }
                    });
                    grid.dataset.listenerAttached = 'true';
                }
            }

            function changePickerYear(direction) {
                pickerCurrentYear += direction;
                renderDatePicker();
            }

            function selectDate(year, month) {
                if (!pickerTarget) return;

                const dateTextEl = pickerTarget.querySelector('span');
                const monthStr = String(month).padStart(2, '0');
                
                pickerTarget.dataset.value = `${year}-${monthStr}`;
                dateTextEl.textContent = `${monthNames[month - 1]} ${year}`;
                dateTextEl.classList.remove('placeholder');
                
                closeDatePicker();
            }
            // --- END: Custom Date Picker Functions ---

            return {
                init,
                renderDashboard // Expose this to be called by the main navigation
            };
        })();


        // --- NEW: USER MANAGEMENT (UM) MODULE ---
        const UM = (function() {
            const $ = sel => document.querySelector(sel);

            async function openUserModal() {
                $('#userManagementModal').style.display = 'block';
                const dropdown = $('#userSelectDropdown');
                const emailDisplay = $('#userEmailDisplay');
                dropdown.innerHTML = '<option value="">Loading directory...</option>';
                dropdown.disabled = true;
                emailDisplay.value = '';

                try {
                    const { data: men, error: menError } = await supabaseClient.from('men_raw').select('PescadoreKey, First, Last, Preferred, Email').eq('org_id', currentUserOrgId);
                    if (menError) throw menError;

                    const { data: women, error: womenError } = await supabaseClient.from('women_raw').select('PescadoreKey, First, Last, Preferred, Email').eq('org_id', currentUserOrgId);
                    if (womenError) throw womenError;

                    const allDirectoryMembers = [...men, ...women]
                        .filter(p => p.Email) // Only include people with an email
                        .map(p => ({
                            id: p.PescadoreKey,
                            name: `${p.Last}, ${p.Preferred || p.First}`,
                            email: p.Email
                        }))
                        .sort((a, b) => a.name.localeCompare(b.name));

                    if (allDirectoryMembers.length === 0) {
                        dropdown.innerHTML = '<option value="">No members with emails in directory</option>';
                        return;
                    }

                    dropdown.innerHTML = '<option value="" selected disabled>Select a person...</option>';
                    allDirectoryMembers.forEach(person => {
                        const option = document.createElement('option');
                        option.value = person.email; // Use email as value for simplicity
                        option.textContent = person.name;
                        option.dataset.email = person.email;
                        dropdown.add(option);
                    });

                    dropdown.disabled = false;

                } catch (error) {
                    console.error('Error loading directory for user management:', error);
                    dropdown.innerHTML = `<option value="">Error loading directory</option>`;
                }
            }
            
            function closeUserModal() {
                $('#userManagementModal').style.display = 'none';
                $('#userSelectDropdown').innerHTML = '<option value="">Loading directory...</option>';
                $('#userEmailDisplay').value = '';
                $('#userRoleSelect').value = 'User';
                $('#permissions-grid').querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
            }

            function setupDropdownListener() {
                $('#userSelectDropdown').addEventListener('change', e => {
                    const selectedOption = e.target.options[e.target.selectedIndex];
                    $('#userEmailDisplay').value = selectedOption.dataset.email || '';
                });
            }

            async function addUser() {
                const email = $('#userEmailDisplay').value;
                const role = $('#userRoleSelect').value;

                if (!email) {
                    alert('Please select a user from the directory.');
                    return;
                }

                try {
                    // 1. Find the user in the 'profiles' table to get their auth user_id
                    const { data: profile, error: profileError } = await supabaseClient
                        .from('profiles')
                        .select('user_id')
                        .eq('email', email)
                        .maybeSingle();

                    if (profileError || !profile) {
                        alert('This person has not created a login account yet. They must sign up before they can be added.');
                        throw new Error(profileError?.message || 'Profile not found for this email.');
                    }
                    
                    const userId = profile.user_id;

                    // 2. Check if they are already a member of this organization
                    const { data: existingMembership, error: checkError } = await supabaseClient
                        .from('memberships')
                        .select('user_id')
                        .eq('user_id', userId)
                        .eq('org_id', currentUserOrgId)
                        .maybeSingle();

                    if (checkError) throw checkError;

                    if (existingMembership) {
                        alert('This user is already a member of your organization.');
                        return;
                    }

                    // 3. Insert into the memberships table
                    const { error: insertError } = await supabaseClient
                        .from('memberships')
                        .insert({
                            user_id: userId,
                            org_id: currentUserOrgId,
                            role: role
                        });

                    if (insertError) throw insertError;
                    
                    showMainStatus('User added successfully!');
                    closeUserModal();
                    renderUserList(); // Refresh the list

                } catch (error) {
                    console.error('Error adding user:', error);
                    alert('Failed to add user: ' + error.message);
                }
            }
            
            async function renderUserList() {
                const tbody = $('#user-list-tbody');
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Loading users...</td></tr>';
                
                try {
                    const { data, error } = await supabaseClient
                        .from('memberships')
                        .select('role, profiles(full_name, email)')
                        .eq('org_id', currentUserOrgId);

                    if (error) throw error;

                    if (!data || data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No users have been added yet.</td></tr>';
                        return;
                    }

                    tbody.innerHTML = '';
                    data.forEach(member => {
                        const tr = document.createElement('tr');
                        const roleLower = (member.role || 'user').toLowerCase();
                        const profile = member.profiles;
                        tr.innerHTML = `
                            <td>
                                <strong>${profile?.full_name || 'Name not found'}</strong><br>
                                <span style="color: var(--muted); font-size: 0.85rem;">${profile?.email || 'Email not found'}</span>
                            </td>
                            <td><span class="role-badge ${roleLower}">${member.role}</span></td>
                            <td class="actions-cell">
                                <button class="btn btn-small">Manage</button>
                                <button class="btn btn-small btn-danger">Delete</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });

                } catch (error) {
                    console.error('Error fetching user list:', error);
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color: var(--accentD);">Failed to load user list.</td></tr>';
                }
            }


            function init() {
                $('#inviteUserBtn')?.addEventListener('click', openUserModal);
                $('#userModalCancel')?.addEventListener('click', closeUserModal);
                $('#userModalSave')?.addEventListener('click', addUser);
                setupDropdownListener();
                renderUserList();
            }

            return {
                init
            };
        })();


        // --- GLOBAL CONFIRMATION MODAL LOGIC ---
        let confirmCallback = null;

        function showConfirmation(title, body, onConfirm) {
            document.getElementById('confirmModalTitle').querySelector('span').textContent = title;
            document.getElementById('confirmModalBody').textContent = body;
            confirmCallback = onConfirm;
            document.getElementById('confirmModal').style.display = 'block';
        }

        function hideConfirmation() {
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
        }


        document.addEventListener('DOMContentLoaded', () => {
            const sidebarContainer = document.querySelector('.sidebar');
            const appPanels = document.querySelectorAll('.app-panel');
            const appTitle = document.getElementById('app-title');
        
            sidebarContainer.addEventListener('click', e => {
                const link = e.target.closest('a');
                if (!link) return;
        
                const appId = link.dataset.appId;
                const parentLi = link.closest('.nav-item');
        
                // Handle submenu toggling
                if (parentLi && parentLi.classList.contains('has-submenu')) {
                    // Don't prevent default if it's a submenu item click
                    if (link.parentElement.classList.contains('nav-item')) {
                       e.preventDefault();
                       parentLi.classList.toggle('open');
                    }
                }
        
                // Handle panel switching for main nav items
                if (appId) {
                    e.preventDefault();
        
                    // Deactivate all main nav items, then activate the clicked one
                    sidebarContainer.querySelectorAll('.nav-item > a').forEach(a => a.classList.remove('active'));
                    link.classList.add('active');
        
                    // Close all submenus except the one belonging to the active item
                    sidebarContainer.querySelectorAll('.nav-item.has-submenu').forEach(item => {
                        if (item !== parentLi) {
                            item.classList.remove('open');
                        }
                    });
        
                    // Switch panels
                    let panelFound = false;
                    appPanels.forEach(panel => {
                        if (panel.id === appId) {
                            panel.style.display = 'block';
                            // For flexbox layouts that need it
                            if (panel.classList.contains('mci-app') || panel.classList.contains('cra-view')) {
                                panel.style.display = 'flex';
                            }
                            panelFound = true;
                        } else {
                            panel.style.display = 'none';
                        }
                    });
        
                    // Update title
                    const navText = link.querySelector('.nav-text');
                    if (navText) {
                        appTitle.textContent = navText.textContent;
                    }
                    
                    // Call render functions for specific panels that need it
                    if (appId === 'secretariat-app') {
                        SECRETARIAT.renderDashboard();
                    }
                    if (appId === 'team-list-app') {
                        const menToggleOption = document.querySelector('#teamListGenderToggle .opt[data-gender="men"]');
                        if (menToggleOption) {
                            TV.loadTeamByGender('men', menToggleOption);
                        } else {
                            TV.renderTeamListPage(); // Fallback
                        }
                    }
                    if (appId === 'meeting-check-in-app') {
                        // Explicitly show the controls bar which contains the gender toggle.
                        const mciControls = document.getElementById('mciControls');
                        if (mciControls) {
                            mciControls.style.display = 'flex';
                        }

                        // Find the 'Men' button in the MCI gender toggle
                        const menToggleOption = document.querySelector('#mciGenderToggle .opt[data-gender="men"]');
                        if (menToggleOption) {
                            // Automatically select 'Men' and load their latest team. This also shows the correct view.
                            MCI.selectGender('men', menToggleOption);
                            
                            // Manually set the "Check-In" submenu item to active for visual consistency
                            const mciNav = document.getElementById('mci-nav-parent');
                            if (mciNav) {
                                mciNav.querySelectorAll('.submenu-item a').forEach(link => link.classList.remove('active'));
                                const checkInLink = mciNav.querySelector('[data-mci-action="show_checkin"]');
                                if (checkInLink) checkInLink.classList.add('active');
                            }
                        }
                    }
                }
            });

            // AUTH.init() is now the single entry point.
            // It will handle auth state changes and trigger initializeUserSession.
            
            // REMOVED old init calls from here. They are now in initializeUserSession.
            
            const confirmModalConfirm = document.getElementById('confirmModalConfirm');
            const confirmModalCancel = document.getElementById('confirmModalCancel');

            confirmModalConfirm.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                hideConfirmation();
            });

            confirmModalCancel.addEventListener('click', hideConfirmation);


            const dataManagementContainer = document.querySelector('#dataManagementContainer');
            if (dataManagementContainer) {
                dataManagementContainer.addEventListener('click', e => {
                    const action = e.target.dataset.action;
                    if (!action) return;

                    switch (action) {
                        case 'clear-mci-view':
                            if (confirm('Clear the current MCI team view? This only affects the screen, not saved data.')) {
                                MCI.clearTeamView();
                            }
                            break;
                        case 'delete-mci-db':
                            showConfirmation(
                                'Delete ALL MCI Data?',
                                'This will permanently delete ALL Meeting Check-In records from the database. This action is irreversible. Are you absolutely sure?',
                                async () => {
                                    const {
                                        error
                                    } = await supabaseClient.from('mci_checkin_data').delete().neq('team_id', '0'); // a safe delete all
                                    if (error) alert('Error: ' + error.message);
                                    else alert('All MCI data has been deleted.');
                                }
                            );
                            break;
                        case 'clear-cra-form':
                            document.querySelector('#cra_clear').click();
                            break;
                        case 'delete-cra-db':
                            showConfirmation(
                                'Delete ALL CRA Data?',
                                'This will permanently delete ALL Candidate Application records from the database. This action is irreversible. Are you absolutely sure?',
                                async () => {
                                    const {
                                        error
                                    } = await supabaseClient.from('cra_applications').delete().neq('id', '0');
                                    if (error) alert('Error: ' + error.message);
                                    else alert('All CRA data has been deleted.');
                                }
                            );
                            break;
                    }
                });
            }
        });
    </script>

    <!-- ====================================================== -->
    <!-- ============== START: AUTHENTICATION SCRIPT ========== -->
    <!-- ====================================================== -->
    <script>
        const AUTH = (function() {
            const $ = sel => document.querySelector(sel);

            // DOM Elements
            const authContainer = $('#auth-container');
            const appContainer = $('.app-container');
            
            const loginView = $('#login-view');
            const signupView = $('#signup-view');
            const forgotPasswordView = $('#forgot-password-view');

            function init() {
                // Listen for authentication state changes
                supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    const user = session?.user;

                    // --- FIX: Core session logic ---
                    // This block acts as a gatekeeper. It ensures the main app 
                    // initialization only runs ONCE per session, preventing a race condition
                    // caused by multiple 'onAuthStateChange' events firing on page load.
                    if (user && !isSessionInitialized) {
                        isSessionInitialized = true; // Set flag immediately to block re-entry
                        await initializeUserSession(user);
                    } else if (!user) {
                        // When the user fully signs out, reset the flag for the next login session.
                        isSessionInitialized = false;
                    }
                    // --- END FIX ---

                    // This function handles showing/hiding the auth screen vs. the app container.
                    // It's safe to run this on every auth event.
                    updateUI(user);
                });

                // Attach event listeners
                $('#loginButton').addEventListener('click', handleLogin);
                $('#signupButton').addEventListener('click', handleSignup);
                $('#resetButton').addEventListener('click', handlePasswordReset);
                $('#logoutButton').addEventListener('click', handleLogout);

                // View switching links
                $('#showSignupLink').addEventListener('click', (e) => { e.preventDefault(); switchView('signup'); });
                $('#forgotPasswordLink').addEventListener('click', (e) => { e.preventDefault(); switchView('forgot-password'); });
                $('#showLoginLink_fromSignup').addEventListener('click', (e) => { e.preventDefault(); switchView('login'); });
                $('#showLoginLink_fromReset').addEventListener('click', (e) => { e.preventDefault(); switchView('login'); });
                
                // Allow submitting forms with Enter key
                $('#loginPassword').addEventListener('keypress', e => { if(e.key === 'Enter') handleLogin(); });
                $('#signupPassword').addEventListener('keypress', e => { if(e.key === 'Enter') handleSignup(); });
                $('#resetEmail').addEventListener('keypress', e => { if(e.key === 'Enter') handlePasswordReset(); });
            }

            function updateUI(user) {
                console.log("updateUI function was called. User object is:", user);
                if (user) {
                    // User is logged in
                    authContainer.style.display = 'none';
                    appContainer.style.display = 'flex';
                } else {
                    // User is logged out
                    authContainer.style.display = 'flex';
                    appContainer.style.display = 'none';
                }
            }

            function switchView(view) {
                loginView.style.display = 'none';
                signupView.style.display = 'none';
                forgotPasswordView.style.display = 'none';

                if (view === 'signup') signupView.style.display = 'block';
                else if (view === 'forgot-password') forgotPasswordView.style.display = 'block';
                else loginView.style.display = 'block';
            }

            async function handleLogin(e) {
                e.preventDefault();
                const email = $('#loginEmail').value;
                const password = $('#loginPassword').value;

                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });

                if (error) {
                    showMainStatus(error.message, true);
                } else {
                    // onAuthStateChanged will handle the UI update
                    $('#loginEmail').value = '';
                    $('#loginPassword').value = '';
                }
            }

            async function handleSignup(e) {
                e.preventDefault();
                const fullName = $('#signupName').value;
                const orgName = $('#signupOrgName').value;
                const email = $('#signupEmail').value;
                const password = $('#signupPassword').value;

                if (!fullName || !orgName || !email || !password) {
                    showMainStatus('All fields are required for sign up.', true);
                    return;
                }

                // 1. Sign up the user in Supabase Auth
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({ email, password });
                if (authError) {
                    showMainStatus(authError.message, true);
                    return;
                }
                
                const user = authData.user;
                if (!user) {
                    showMainStatus('Sign up successful, but could not retrieve user data. Please log in.', true);
                    return;
                }

                // 2. Create the organization
                const { data: orgData, error: orgError } = await supabaseClient
                    .from('organizations')
                    .insert({ name: orgName, created_by: user.id })
                    .select()
                    .single();
                
                if (orgError) {
                     showMainStatus(`Account created, but failed to create organization: ${orgError.message}`, true);
                     return;
                }

                // 3. Create the user profile
                const { error: profileError } = await supabaseClient
                    .from('profiles')
                    .insert({ user_id: user.id, full_name: fullName, email: user.email });

                if (profileError) {
                    showMainStatus(`Organization created, but failed to create user profile: ${profileError.message}`, true);
                    return;
                }
                
                // 4. Create the membership link
                const { error: membershipError } = await supabaseClient
                    .from('memberships')
                    .insert({ user_id: user.id, org_id: orgData.id, role: 'owner' });

                if (membershipError) {
                    showMainStatus(`Profile created, but failed to create membership: ${membershipError.message}`, true);
                    return;
                }
                
                showMainStatus('Account created! Check your email for a confirmation link.');
                switchView('login');
            }
            
            async function handlePasswordReset(e) {
                e.preventDefault();
                const email = $('#resetEmail').value;
                
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.href.split('#')[0] // URL to redirect to after password reset
                });

                if (error) {
                    showMainStatus(error.message, true);
                } else {
                    showMainStatus('Password reset link sent to your email.');
                    switchView('login');
                }
            }

            async function handleLogout(e) {
                e.preventDefault();
                await supabaseClient.auth.signOut();
                // onAuthStateChanged will handle the UI update
            }

            return { init };
        })();

        // Initialize the new AUTH module
        document.addEventListener('DOMContentLoaded', AUTH.init);
    </script>
</body>

</html>
